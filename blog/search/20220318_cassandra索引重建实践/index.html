<!DOCTYPE html><html lang="zh" data-astro-cid-bvzihdzo> <head><!-- Global Metadata --><meta charset="utf-8"><!--<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">--><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css"><link rel="shortcut icon" href="favicon.png" type="image/png"><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="Ge Yuxu • AI &#38; Engineering" href="https://geyuxu.com/rss.xml"><meta name="generator" content="Astro v5.7.5"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://geyuxu.com/blog/search/20220318_cassandra%E7%B4%A2%E5%BC%95%E9%87%8D%E5%BB%BA%E5%AE%9E%E8%B7%B5/"><!-- Primary Meta Tags --><title>Cassandra 索引重建实践</title><meta name="title" content="Cassandra 索引重建实践"><meta name="description"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://geyuxu.com/blog/search/20220318_cassandra%E7%B4%A2%E5%BC%95%E9%87%8D%E5%BB%BA%E5%AE%9E%E8%B7%B5/"><meta property="og:title" content="Cassandra 索引重建实践"><meta property="og:description"><meta property="og:image" content="https://geyuxu.com/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://geyuxu.com/blog/search/20220318_cassandra%E7%B4%A2%E5%BC%95%E9%87%8D%E5%BB%BA%E5%AE%9E%E8%B7%B5/"><meta property="twitter:title" content="Cassandra 索引重建实践"><meta property="twitter:description"><meta property="twitter:image" content="https://geyuxu.com/blog-placeholder-1.jpg"><script src="/js/jquery-3.7.1.min.js"></script><script is:global>
	window.addEventListener('DOMContentLoaded', () => {
		$('.toc ol').css({
		'list-style': 'none',   // 隐藏 1. 2. 3.
		'margin': 0,
		'padding-left': 0,       // 可按需调整
		});
		$('.toc ol > li').css({
		'list-style': 'none',   // 隐藏 1. 2. 3.
		'padding-left': 10  
		});
        $('.sidebar').append($('.toc'));
      });
	</script><style>:root{--accent: #2337ff;--accent-dark: #000d8a;--black: 15, 18, 25;--gray: 96, 115, 159;--gray-light: 229, 233, 240;--gray-dark: 34, 41, 57;--gray-gradient: rgba(var(--gray-light), 50%), #fff;--box-shadow: 0 2px 6px rgba(var(--gray), 25%), 0 8px 24px rgba(var(--gray), 33%), 0 16px 32px rgba(var(--gray), 33%)}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-regular.woff) format("woff");font-weight:400;font-style:normal;font-display:swap}@font-face{font-family:Atkinson;src:url(/fonts/atkinson-bold.woff) format("woff");font-weight:700;font-style:normal;font-display:swap}body{font-family:Atkinson,sans-serif;margin:0;padding:0;text-align:left;background:linear-gradient(var(--gray-gradient)) no-repeat;background-size:100% 600px;word-wrap:break-word;overflow-wrap:break-word;color:rgb(var(--gray-dark));font-size:20px;line-height:1.7}main{width:720px;max-width:calc(100% - 2em);margin:auto;padding:3em 1em}h1,h2,h3,h4,h5,h6{margin:0 0 .5rem;color:rgb(var(--black));line-height:1.2}h1{font-size:3.052em}h2{font-size:2.441em}h3{font-size:1.953em}h4{font-size:1.563em}h5{font-size:1.25em}strong,b{font-weight:700}a,a:hover{color:var(--accent)}p{margin-bottom:1em}.prose p{margin-bottom:2em}textarea{width:100%;font-size:16px}input{font-size:16px}table{width:100%}img{max-width:100%;height:auto;border-radius:8px}code{padding:2px 5px;background-color:rgb(var(--gray-light));border-radius:2px}pre{padding:1.5em;border-radius:8px}pre>code{all:unset}blockquote{border-left:4px solid var(--accent);padding:0 0 0 20px;margin:0;font-size:1.333em}hr{border:none;border-top:1px solid rgb(var(--gray-light))}@media (max-width: 720px){body{font-size:18px}main{padding:1em}}.sr-only{border:0;padding:0;margin:0;position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px 1px 1px 1px);clip:rect(1px,1px,1px,1px);clip-path:inset(50%);white-space:nowrap}.title_li{list-style:none}.title_li>a,.title_li_num>a,.toc-link,.series-list>li>a,.series_title>a{color:#7a888e}.content{max-width:720px;margin:0 auto;padding:2rem 1rem;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;font-size:1.05rem;line-height:1.75;color:#333}.content h1,.content h2,.content h3{font-weight:600;margin-top:2rem;margin-bottom:1rem;line-height:1.3}.content p{margin-bottom:1.25rem}.content a{color:var(--accent, #0070f3);text-decoration:underline}.content img{max-width:100%;border-radius:6px;margin:1.5rem 0}.content pre,.content code{font-family:Menlo,Monaco,Consolas,Courier New,monospace;font-size:.9em;border-radius:4px}.content pre{padding:1em;overflow-x:auto}article.prose{font-size:var(--fs-base);line-height:1.7}@media (max-width: 640px){nav>div,nav>h2{font-size:.6em}ul,ol{padding-left:20px}main,.content-wrapper{padding-left:0;width:350px;max-width:60350px0px;margin:0 auto}img,table,pre{max-width:100%}table,pre{overflow-x:auto}.content{margin:0;padding:0;border:0;max-width:3350px00px;font-size:11px}h1{font-size:1.3rem}h2{font-size:1.2rem}h3{font-size:1.1rem}h4{font-size:1rem}h5{font-size:.9rem}}
a[data-astro-cid-eimmu3lg]{display:inline-block;text-decoration:none}a[data-astro-cid-eimmu3lg].active{font-weight:bolder;text-decoration:underline}header[data-astro-cid-3ef6ksr2]{margin:0;padding:0 1em;background:#fff;box-shadow:0 2px 8px rgba(var(--black),5%)}h2[data-astro-cid-3ef6ksr2]{margin:0;font-size:1em}h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2],h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none}nav[data-astro-cid-3ef6ksr2]{display:flex;align-items:center;justify-content:space-between}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{padding:1em .5em;color:var(--black);border-bottom:4px solid transparent;text-decoration:none}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none;border-bottom-color:var(--accent)}.social-links[data-astro-cid-3ef6ksr2],.social-links[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{display:flex}@media (max-width: 720px){.social-links[data-astro-cid-3ef6ksr2]{display:none}}footer[data-astro-cid-sz7xmlte]{padding:2em 1em 6em;background:linear-gradient(var(--gray-gradient)) no-repeat;color:rgb(var(--gray));text-align:center}.social-links[data-astro-cid-sz7xmlte]{display:flex;justify-content:center;gap:1em;margin-top:1em}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]{text-decoration:none;color:rgb(var(--gray))}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]:hover{color:rgb(var(--gray-dark))}
.statement[data-astro-cid-uffxixac]{font-size:10px;color:gray}
main[data-astro-cid-bvzihdzo].page{display:grid;grid-template-columns:260px minmax(0,1fr);width:100%;margin:0}aside[data-astro-cid-bvzihdzo].sidebar{box-sizing:border-box;width:260px;padding:2rem 1rem;font-size:.95rem;position:sticky;top:4rem;align-self:start}.sidebar[data-astro-cid-bvzihdzo] .meta[data-astro-cid-bvzihdzo] p[data-astro-cid-bvzihdzo]{margin:.25rem 0}nav[data-astro-cid-bvzihdzo].toc li[data-astro-cid-bvzihdzo]{margin:.35rem 0 .35rem 1rem}nav[data-astro-cid-bvzihdzo].toc a[data-astro-cid-bvzihdzo]{color:var(--gray-dark,#444);text-decoration:none}nav[data-astro-cid-bvzihdzo].toc a[data-astro-cid-bvzihdzo]:hover{text-decoration:underline}.content-wrapper[data-astro-cid-bvzihdzo]{display:flex;justify-content:center;padding:2rem 1rem}article[data-astro-cid-bvzihdzo].prose{max-width:740px;width:100%}@media (max-width: 768px){main[data-astro-cid-bvzihdzo].page{grid-template-columns:1fr}aside[data-astro-cid-bvzihdzo].sidebar{position:static;width:100%;padding:1rem}.content-wrapper[data-astro-cid-bvzihdzo]{justify-content:flex-start}article[data-astro-cid-bvzihdzo].prose{max-width:100%}}.series-list[data-astro-cid-bvzihdzo]{list-style:none;margin:0;padding-left:10px}.series-list[data-astro-cid-bvzihdzo]{list-style:none;margin:0;padding-left:10px;max-height:calc(16em + .5rem);overflow-y:auto}.series-list[data-astro-cid-bvzihdzo]::-webkit-scrollbar{width:6px}.series-list[data-astro-cid-bvzihdzo]::-webkit-scrollbar-thumb{background:#0003;border-radius:3px}
</style></head> <body data-astro-cid-bvzihdzo> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <!--<h2><a href="/">{SITE_TITLE}</a></h2>--> <h2 data-astro-cid-3ef6ksr2><a style="padding-left:0" href="/" data-astro-cid-3ef6ksr2>Ge Yuxu<br data-astro-cid-3ef6ksr2>AI & Engineering</a></h2> <div class="internal-links" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Home </a>  <a href="/blog/1" class="active" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Blog </a>  <a href="/series" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Series </a>  <a href="/projects" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Projects </a>  </div> <div class="social-links" data-astro-cid-3ef6ksr2> <a href="https://github.com/geyuxu" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Go to Ge Yuxu's GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path></svg> </a> <a href="https://www.linkedin.com/in/geyuxu/" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Go to Ge Yuxu's LinkedIn profile</span> <svg viewBox="0 0 24 24" width="32" height="32" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" data-astro-cid-3ef6ksr2> <path fill="currentColor" d="M20.447 20.452H17.2v-5.569c0-1.328-.025-3.039-1.852-3.039-1.853 0-2.136 1.447-2.136 2.942v5.666h-3.248V9h3.122v1.561h.045c.435-.823 1.498-1.688 3.083-1.688 3.295 0 3.903 2.17 3.903 4.989v6.59zM5.337 7.433a1.882 1.882 0 110-3.764 1.882 1.882 0 010 3.764zm1.626 13.019H3.708V9h3.255v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.226.792 24 1.771 24h20.451C23.2 24 24 23.226 24 22.271V1.729C24 .774 23.2 0 22.222 0z" data-astro-cid-3ef6ksr2></path> </svg> </a> </div> </nav> </header>  <main class="page" data-astro-cid-bvzihdzo> <!-- 左侧栏 --> <aside class="sidebar" data-astro-cid-bvzihdzo> <div class="meta" data-astro-cid-bvzihdzo> <b data-astro-cid-bvzihdzo>Cassandra 索引重建实践</b> <p data-astro-cid-bvzihdzo><time datetime="2022-03-31T16:00:00.000Z"> Apr 1, 2022 </time></p>   </div> <hr data-astro-cid-bvzihdzo> <br data-astro-cid-bvzihdzo> </aside> <!-- 右侧正文区域（flex 居中） --> <div class="content-wrapper" data-astro-cid-bvzihdzo> <article class="prose" data-astro-cid-bvzihdzo>  <article class="content"> <nav class="toc"><ol class="toc-level toc-level-1"><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#cassandra简介">Cassandra简介</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#cassandra二级索引原理">Cassandra二级索引原理</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#为什么需要手动重建索引">为什么需要手动重建索引</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#索引重建的实践步骤">索引重建的实践步骤</a><ol class="toc-level toc-level-2"><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#确认索引状况">确认索引状况</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#通知并停止相关应用">通知并停止相关应用</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#连接到-cassandra-集群">连接到 Cassandra 集群</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#备份表模式可选">备份表模式（可选）</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#删除索引">删除索引</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#创建索引">创建索引</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#监控重建进度">监控重建进度</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#验证索引">验证索引</a></li><li class="toc-item toc-item-h3"><a class="toc-link toc-link-h3" href="#恢复应用服务">恢复应用服务</a></li></ol></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#python索引重建自动化小工具">Python索引重建自动化小工具</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#示例使用python脚本重建索引">示例：使用Python脚本重建索引</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#结论">结论</a></li></ol></nav><h1 id="cassandra-索引重建实践"><a aria-hidden="true" tabindex="-1" href="#cassandra-索引重建实践"><span class="icon icon-link"></span></a>Cassandra 索引重建实践</h1>
<h2 id="cassandra简介"><a aria-hidden="true" tabindex="-1" href="#cassandra简介"><span class="icon icon-link"></span></a>Cassandra简介</h2>
<p>Apache Cassandra 是一种分布式 NoSQL 数据库，属于宽列存储（Wide Column Store）模型。它最初由 Facebook 开发用于 Inbox 搜索，随后在2008年开源并进入 Apache 基金会孵化 。Cassandra 以其高可用性和线性可扩展性著称，能够在多节点集群中实现无单点故障的数据存储。它遵循 CAP 定理中 AP（Partition Tolerance 和 Availability）原则，提供可调的最终一致性。在 Cassandra 中，数据按照 Keyspace（密钥空间） 来划分，类似于关系型数据库中的数据库；Keyspace 下包含多个 Table（表），每个表通过 Primary Key（主键） 定义数据分区和排序方式。Cassandra 采用分布式哈希将数据分散到集群各节点上，支持在多数据中心部署下的容灾和跨地域复制。凭借其高吞吐和可伸缩性，Cassandra 被广泛应用于日志收集、物联网、社交网络等对海量数据和高可用要求严苛的场景。</p>
<h2 id="cassandra二级索引原理"><a aria-hidden="true" tabindex="-1" href="#cassandra二级索引原理"><span class="icon icon-link"></span></a>Cassandra二级索引原理</h2>
<p>在 Cassandra 中，每张表的主键决定了数据的分区和查询模式。如果需要通过非主键列进行查询，通常有两种办法：冗余建模（为新查询模式创建一张反范式表），或使用 二级索引。二级索引（Secondary Index） 是 Cassandra 提供的一种机制，允许在非主键列上建立索引，从而支持通过该列进行查询。使用 CREATE INDEX 语句即可为已有表添加二级索引；之后，对该列的新写入会自动更新索引，而已有的数据则会被后台异步索引。</p>
<p>二级索引的实现原理与关系型数据库不同：索引数据是本地的、非全局的。Cassandra 在每个存储数据的节点上为被索引列维护一个隐式的索引表（类似于隐藏的索引列族） 。这个索引表通常以索引列的值作为键，指向拥有该值的分区的主键。查询包含二级索引时，协调节点会将查询下发到每个节点，由各节点利用本地索引筛选出满足条件的主键，然后再由协调节点汇总结果。这意味着如果索引列不是查询的分区键的一部分，可能需要遍历集群中多个节点才能完成查询。<strong>高基数（High Cardinality）</strong> 或分布很广的列上建立二级索引通常效率低下 ：因为几乎每个节点都可能持有匹配的数据，需要全局扫描；相反，对于基数较低且选择性较好的列（例如状态标志、类别等），二级索引可以有效地定位数据而无需手动创建冗余表。</p>
<p>值得注意的是，Cassandra 二级索引并不适合所有查询场景。如果滥用，可能导致写入性能下降（因为每次写入还需更新索引表），查询延迟增大，甚至给集群增加负担。在 Cassandra 3.x 中，引入了 SAI（Storage-Attached Indexing）等改进的索引机制，但经典的二级索引仍然被广泛使用。理解其工作原理有助于判断何时该使用索引、何时应考虑其他方案。</p>
<h2 id="为什么需要手动重建索引"><a aria-hidden="true" tabindex="-1" href="#为什么需要手动重建索引"><span class="icon icon-link"></span></a>为什么需要手动重建索引</h2>
<p>理想情况下，Cassandra 的二级索引会随着数据更新自动维护，不需要额外干预。然而，在实际生产环境中，可能出现索引异常或性能问题，需要我们手动干预重建索引。以下是常见的原因：</p>
<ul>
<li>索引不一致或损坏：由于集群故障、Bug 或其它异常情况，索引数据可能与实际数据不同步。例如，某些写入在索引表中未正确记录，导致通过索引查询无法找到实际存在的数据，或者已经删除的数据仍通过索引查询出现。这种索引数据不一致的情况需要重建索引来修复。</li>
<li>性能下降：长时间运行后，索引表可能积累大量过期或无效条目（例如对应已删除或过期的数据），从而充斥大量墓碑（tombstone）记录，影响查询性能。如果索引列上的数据分布发生显著变化（例如大量插入删除），索引的查询效率可能下降。这时，重新索引可以清理无效数据、压缩索引结构，从而提升性能。</li>
<li>数据批量导入或迁移：在通过 SSTable 离线导入数据、节点扩容/缩容或灾备数据恢复等操作后，二级索引可能没有及时构建完全。例如，将某节点数据文件拷贝恢复到新集群时，索引数据不会自动生成，需要手动重建索引以涵盖所有导入的数据。</li>
<li>索引设计调整：有时为了优化查询，我们可能修改索引策略或列。在删除旧索引、更换新索引时，手动删除和重建索引是必要步骤。此外，Cassandra 提供了 nodetool rebuild_index 命令，可以在不删除索引定义的情况下重建索引，但在某些版本中可能不稳定。所以，删除后重新创建 often 是更直接可靠的做法。</li>
</ul>
<p>总之，当出现索引无法正常服务（查询结果不正确或超时）或者索引本身导致写入/读取性能显著下降时，手动重建索引是一种有效的修复手段。</p>
<h2 id="索引重建的实践步骤"><a aria-hidden="true" tabindex="-1" href="#索引重建的实践步骤"><span class="icon icon-link"></span></a>索引重建的实践步骤</h2>
<p>下面以实际案例为背景，介绍 Cassandra 二级索引重建的一般步骤和实践方法。假设我们在 Keyspace keyspace_xxx 的表 table_xxx 上有一个索引 index_xxx，索引目标列为 field_xxx。近期监控发现，针对该索引列的查询出现异常（查询不到应有的数据），同时写入延迟升高，怀疑索引出现问题。我们计划在维护时间窗对其进行重建。大体步骤如下：</p>
<h3 id="确认索引状况"><a aria-hidden="true" tabindex="-1" href="#确认索引状况"><span class="icon icon-link"></span></a>确认索引状况</h3>
<p>在动手之前，先评估索引的当前状态。例如，可以登录节点服务器检查索引文件占用的磁盘大小，以评估索引规模。Cassandra 的数据目录通常位于 <code>.../data/data/&#x3C;keyspace>/&#x3C;table> </code>下，其中二级索引数据会存储在类似 <code>&#x3C;table>.&#x3C;index_name></code> 的子目录中。通过如下一条命令可以查看索引相关目录大小：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#79B8FF">cd</span><span style="color:#9ECBFF"> /path/to/cassandra-data/data/data/keyspace_xxx</span></span>
<span class="line"><span style="color:#B392F0">du</span><span style="color:#79B8FF"> -h</span><span style="color:#79B8FF"> --max-depth=1</span><span style="color:#F97583"> |</span><span style="color:#B392F0"> grep</span><span style="color:#9ECBFF"> index_xxx</span></span></code></pre>
<p>如果发现索引数据文件异常庞大（例如数十GB），或与预期不符，说明索引可能累积了大量历史数据。这进一步佐证了需要重建索引的判断。</p>
<h3 id="通知并停止相关应用"><a aria-hidden="true" tabindex="-1" href="#通知并停止相关应用"><span class="icon icon-link"></span></a>通知并停止相关应用</h3>
<p>因为重建索引需要删除并重新创建索引，在此过程中依赖该索引的查询将不可用。为避免影响业务，应该提前通知相关方并在维护窗口执行。关闭或暂停使用该索引的应用服务（例如我们的案例中相关的 service_xxx 等微服务）以避免在索引重建期间收到错误查询结果。同时停止写入该表的数据也有助于保证重建期间数据一致性（虽然Cassandra允许在线重建索引，但静默数据环境下操作风险更低）。</p>
<h3 id="连接到-cassandra-集群"><a aria-hidden="true" tabindex="-1" href="#连接到-cassandra-集群"><span class="icon icon-link"></span></a>连接到 Cassandra 集群</h3>
<p>使用 CQL 工具或驱动连接到 Cassandra 执行索引重建操作。可以通过 cqlsh 连接，或者如下一样使用 Python Driver 脚本连接。这里以 cqlsh 为例：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> cqlsh</span><span style="color:#9ECBFF"> 10.x.x.x</span><span style="color:#6A737D">    # 连接到集群某节点的 CQL 接口，IP已脱敏为10.x.x.x</span></span></code></pre>
<p>连接后，切换到目标 Keyspace：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#F97583">USE</span><span style="color:#E1E4E8"> keyspace_xxx;</span></span></code></pre>
<h3 id="备份表模式可选"><a aria-hidden="true" tabindex="-1" href="#备份表模式可选"><span class="icon icon-link"></span></a>备份表模式（可选）</h3>
<p>在删除索引前，建议使用 DESCRIBE TABLE table_xxx; 保存表的 schema 定义。这有助于了解表结构和索引信息，防止误操作。如果需要，也可以备份当前索引的定义。</p>
<h3 id="删除索引"><a aria-hidden="true" tabindex="-1" href="#删除索引"><span class="icon icon-link"></span></a>删除索引</h3>
<p>执行索引删除语句，将异常的索引移除：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#F97583">DROP</span><span style="color:#F97583"> INDEX</span><span style="color:#F97583"> IF</span><span style="color:#F97583"> EXISTS</span><span style="color:#E1E4E8"> index_xxx;</span></span></code></pre>
<p>使用 IF EXISTS 可以避免索引不存在时的错误。删除索引会从系统中移除索引的元数据，并触发集群各节点删掉本地索引数据（这个过程可能需要一点时间来清理磁盘上的索引SSTable文件）。</p>
<h3 id="创建索引"><a aria-hidden="true" tabindex="-1" href="#创建索引"><span class="icon icon-link"></span></a>创建索引</h3>
<p>确认索引已删除后，重新创建索引：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#F97583">CREATE</span><span style="color:#F97583"> INDEX</span><span style="color:#B392F0"> index_xxx</span><span style="color:#F97583"> ON</span><span style="color:#E1E4E8"> table_xxx (field_xxx);</span></span></code></pre>
<p>Cassandra 会为已有的数据异步重建索引。在我们案例中，索引重建开始后，集群各节点会扫描表 table_xxx 上的 field_xxx 列数据并插入索引条目。这个过程对大表来说可能比较耗时。在重建过程中，新的索引查询可能仍然无法返回完整结果，直到重建完成。</p>
<h3 id="监控重建进度"><a aria-hidden="true" tabindex="-1" href="#监控重建进度"><span class="icon icon-link"></span></a>监控重建进度</h3>
<p>索引创建语句提交后，需等待索引重建完成。可以通过以下方式监控：</p>
<ul>
<li>日志观察：检查各节点的 Cassandra 日志（system.log），搜索关于索引重建的消息。例如 Cassandra 会记录索引建立完成的时间点。我们的实践中，从开始到索引构建完毕耗时约数小时，需耐心等待。</li>
<li>目录大小变化：再次查看数据目录中索引目录的大小增长情况。如果索引文件大小趋于稳定，且接近原表数据体量的预期比例，表明重建接近完成。</li>
<li>性能监控：重建索引期间，节点 CPU 和 IO 可能显著升高。待这些指标恢复正常水平，也暗示重建结束。</li>
</ul>
<h3 id="验证索引"><a aria-hidden="true" tabindex="-1" href="#验证索引"><span class="icon icon-link"></span></a>验证索引</h3>
<p>索引重建完成后，使用查询验证索引是否正常工作。可以使用之前存在的一些实际值进行测试。例如，我们知道在表 table_xxx 中存在一条记录，其 field_xxx 字段值为 ‘some_value’（这里用示例值代替实际值）。我们尝试用索引列来查询它：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="sql"><code><span class="line"><span style="color:#F97583">SELECT</span><span style="color:#F97583"> *</span><span style="color:#E1E4E8"> </span></span>
<span class="line"><span style="color:#F97583">FROM</span><span style="color:#E1E4E8"> table_xxx </span></span>
<span class="line"><span style="color:#F97583">WHERE</span><span style="color:#E1E4E8"> field_xxx </span><span style="color:#F97583">=</span><span style="color:#9ECBFF"> 'some_value'</span><span style="color:#E1E4E8"> </span></span>
<span class="line"><span style="color:#F97583">LIMIT</span><span style="color:#79B8FF"> 1</span><span style="color:#E1E4E8">;</span></span></code></pre>
<p>如果返回结果包含该记录（或至少不再超时），说明索引查询功能恢复正常。对于数值类型的字段查询时无需加引号，这里要根据字段类型调整查询语句。</p>
<h3 id="恢复应用服务"><a aria-hidden="true" tabindex="-1" href="#恢复应用服务"><span class="icon icon-link"></span></a>恢复应用服务</h3>
<p>确认索引功能恢复后，重新启动先前暂停的应用服务。例如：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#6A737D"># 重启相关应用服务</span></span>
<span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> cd</span><span style="color:#9ECBFF"> /path/to/service_xxx1</span><span style="color:#E1E4E8"> &#x26;&#x26; </span><span style="color:#B392F0">sh</span><span style="color:#9ECBFF"> startup.sh</span><span style="color:#9ECBFF"> start</span></span>
<span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> cd</span><span style="color:#9ECBFF"> /path/to/service_xxx2</span><span style="color:#E1E4E8"> &#x26;&#x26; </span><span style="color:#B392F0">sh</span><span style="color:#9ECBFF"> startup.sh</span><span style="color:#9ECBFF"> start</span></span>
<span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> cd</span><span style="color:#9ECBFF"> /path/to/service_xxx3</span><span style="color:#E1E4E8"> &#x26;&#x26; </span><span style="color:#B392F0">sh</span><span style="color:#9ECBFF"> startup.sh</span><span style="color:#9ECBFF"> start</span></span></code></pre>
<p>让应用重新与 Cassandra 建立连接，并验证业务查询正常。此时索引重建流程全部完成。</p>
<p>经过上述步骤，我们成功修复并重建了 Cassandra 的二级索引 index_xxx。在实践中，我们的索引在 DROP 时释放了大量磁盘空间，重建后查询恢复正常、写入性能也有所改善。这印证了手动重建索引在解决索引异常问题上的有效性。</p>
<h2 id="python索引重建自动化小工具"><a aria-hidden="true" tabindex="-1" href="#python索引重建自动化小工具"><span class="icon icon-link"></span></a>Python索引重建自动化小工具</h2>
<p>上述过程可以通过人工逐步执行，但在某些情况下，我们希望将其工具化，以便更快捷且可重复地对索引进行操作。下面提供一个使用 Python 和 DataStax Cassandra Driver (cassandra-driver) 的小工具示例，用于自动化地连接集群并重建指定索引。这个脚本可以执行以下工作：</p>
<ul>
<li>连接 Cassandra 集群（支持指定节点地址列表）。</li>
<li>删除指定索引（若存在）。</li>
<li>创建指定索引。</li>
<li>（可选）使用给定的测试值查询索引列，验证索引是否有效。</li>
</ul>
<p>在使用该脚本之前，请确保已通过 pip install cassandra-driver 安装 Cassandra Python 驱动，并根据需要配置好 Cassandra 集群的网络连通性和认证信息（如果集群启用了用户名/密码验证，需要在代码中添加认证支持，例如使用 PlainTextAuthProvider）。</p>
<p>下面是脚本源码：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="python"><code><span class="line"><span style="color:#6A737D">#!/usr/bin/env python3</span></span>
<span class="line"><span style="color:#6A737D"># -*- coding: utf-8 -*-</span></span>
<span class="line"><span style="color:#9ECBFF">"""</span></span>
<span class="line"><span style="color:#9ECBFF">Cassandra 二级索引重建工具</span></span>
<span class="line"><span style="color:#9ECBFF">"""</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> argparse</span></span>
<span class="line"><span style="color:#F97583">from</span><span style="color:#E1E4E8"> cassandra.cluster </span><span style="color:#F97583">import</span><span style="color:#E1E4E8"> Cluster</span></span>
<span class="line"><span style="color:#6A737D"># 如果需要认证，可启用以下导入并在 Cluster 时加入 auth_provider</span></span>
<span class="line"><span style="color:#6A737D"># from cassandra.auth import PlainTextAuthProvider</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># 解析命令行参数</span></span>
<span class="line"><span style="color:#E1E4E8">parser </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> argparse.ArgumentParser(</span><span style="color:#FFAB70">description</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"Cassandra index rebuild tool"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">parser.add_argument(</span><span style="color:#9ECBFF">'--hosts'</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">required</span><span style="color:#F97583">=</span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">help</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"Cassandra contact points (comma separated IP list)"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">parser.add_argument(</span><span style="color:#9ECBFF">'--keyspace'</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">required</span><span style="color:#F97583">=</span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">help</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"Keyspace name"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">parser.add_argument(</span><span style="color:#9ECBFF">'--table'</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">required</span><span style="color:#F97583">=</span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">help</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"Table name"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">parser.add_argument(</span><span style="color:#9ECBFF">'--column'</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">required</span><span style="color:#F97583">=</span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">help</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"Column name to index on"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">parser.add_argument(</span><span style="color:#9ECBFF">'--index'</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">required</span><span style="color:#F97583">=</span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">help</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"Index name"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">parser.add_argument(</span><span style="color:#9ECBFF">'--test-value'</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">help</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">"Optional test value to verify the index query"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">args </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> parser.parse_args()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">contact_points </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> args.hosts.split(</span><span style="color:#9ECBFF">','</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">keyspace </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> args.keyspace</span></span>
<span class="line"><span style="color:#E1E4E8">table </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> args.table</span></span>
<span class="line"><span style="color:#E1E4E8">column </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> args.column</span></span>
<span class="line"><span style="color:#E1E4E8">index </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> args.index</span></span>
<span class="line"><span style="color:#E1E4E8">test_value </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> args.test_value</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># 建立集群连接（默认端口9042，如需其它端口可在Cluster参数中指定）</span></span>
<span class="line"><span style="color:#6A737D"># 如需认证: e.g., auth_provider = PlainTextAuthProvider(username='user', password='pass')</span></span>
<span class="line"><span style="color:#E1E4E8">cluster </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> Cluster(contact_points)</span></span>
<span class="line"><span style="color:#E1E4E8">session </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> cluster.connect(keyspace)</span></span>
<span class="line"><span style="color:#79B8FF">print</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"Connected to cluster at </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">contact_points</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">, keyspace </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">keyspace</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># 删除已有索引</span></span>
<span class="line"><span style="color:#E1E4E8">drop_cql </span><span style="color:#F97583">=</span><span style="color:#F97583"> f</span><span style="color:#9ECBFF">"DROP INDEX IF EXISTS </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">index</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">"</span></span>
<span class="line"><span style="color:#E1E4E8">session.execute(drop_cql)</span></span>
<span class="line"><span style="color:#79B8FF">print</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"Index </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">index</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF"> dropped (if existed)."</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># 创建新索引</span></span>
<span class="line"><span style="color:#E1E4E8">create_cql </span><span style="color:#F97583">=</span><span style="color:#F97583"> f</span><span style="color:#9ECBFF">"CREATE INDEX </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">index</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF"> ON </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">table</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF"> (</span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">column</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">)"</span></span>
<span class="line"><span style="color:#E1E4E8">session.execute(create_cql)</span></span>
<span class="line"><span style="color:#79B8FF">print</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"Index </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">index</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF"> created on </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">table</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">(</span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">column</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">)."</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># 验证索引（如果提供了测试值）</span></span>
<span class="line"><span style="color:#F97583">if</span><span style="color:#E1E4E8"> test_value:</span></span>
<span class="line"><span style="color:#E1E4E8">    query </span><span style="color:#F97583">=</span><span style="color:#F97583"> f</span><span style="color:#9ECBFF">"SELECT </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">column</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF"> FROM </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">table</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF"> WHERE </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">column</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">=%s LIMIT 1"</span></span>
<span class="line"><span style="color:#E1E4E8">    rows </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> session.execute(query, [test_value])</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> rows:</span></span>
<span class="line"><span style="color:#79B8FF">        print</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"Index query successful, found </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">column</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF"> = </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">test_value</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">."</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">    else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#79B8FF">        print</span><span style="color:#E1E4E8">(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">"No results for </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">column</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF"> = </span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">test_value</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">. The value might not exist in table."</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#F97583">else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#79B8FF">    print</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"No test value provided for verification, skipping index query."</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># 关闭连接</span></span>
<span class="line"><span style="color:#E1E4E8">session.shutdown()</span></span>
<span class="line"><span style="color:#E1E4E8">cluster.shutdown()</span></span>
<span class="line"><span style="color:#79B8FF">print</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"Index rebuild completed."</span><span style="color:#E1E4E8">)</span></span></code></pre>
<p>上述脚本通过命令行参数指定要连接的节点、Keyspace、表、列和索引名称，并执行重建操作。我们使用 DROP INDEX IF EXISTS 确保在索引存在时删除它，随后用 CREATE INDEX 重建。cassandra-driver 会等待集群元数据同步（Schema agreement），确保索引在整个集群中创建。注意：创建索引会立即返回，但索引的数据重建在后台异步进行，因此脚本返回后索引可能还在构建中；如果数据量大，可能需要等待一段时间才能查询出结果。</p>
<p>在验证环节中，若提供了 —test-value 参数，脚本会使用该值对索引列执行一次查询（等价于 SELECT … WHERE column = ‘value’ LIMIT 1），并输出是否查找到结果。这可以简单地检验索引查询是否生效。但需要注意，这个验证依赖于提供的值确实存在于表中。如果值不存在或者索引尚未完全重建，查询可能得不到结果。</p>
<h2 id="示例使用python脚本重建索引"><a aria-hidden="true" tabindex="-1" href="#示例使用python脚本重建索引"><span class="icon icon-link"></span></a>示例：使用Python脚本重建索引</h2>
<p>假设我们希望对前述的 index_xxx 索引执行重建，索引目标列 field_xxx 我们已知存在值 ‘some_value’ 用于测试。集群的某节点 IP 为 10.x.x.x（已脱敏）。我们可以按照如下方式运行脚本：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="bash"><code><span class="line"><span style="color:#B392F0">$</span><span style="color:#9ECBFF"> python</span><span style="color:#9ECBFF"> cass_rebuild_index.py</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">    --hosts</span><span style="color:#9ECBFF"> 10.x.x.x</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">    --keyspace</span><span style="color:#9ECBFF"> keyspace_xxx</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">    --table</span><span style="color:#9ECBFF"> table_xxx</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">    --column</span><span style="color:#9ECBFF"> field_xxx</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">    --index</span><span style="color:#9ECBFF"> index_xxx</span><span style="color:#79B8FF"> \</span></span>
<span class="line"><span style="color:#79B8FF">    --test-value</span><span style="color:#9ECBFF"> some_value</span></span></code></pre>
<p>运行后，脚本会依次输出连接信息、索引删除/创建进度以及验证结果。例如，预期输出如下：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>Connected to cluster at ['10.x.x.x'], keyspace keyspace_xxx  </span></span>
<span class="line"><span>Index index_xxx dropped (if existed).  </span></span>
<span class="line"><span>Index index_xxx created on table_xxx(field_xxx).  </span></span>
<span class="line"><span>Index query successful, found field_xxx = some_value.  </span></span>
<span class="line"><span>Index rebuild completed.  </span></span></code></pre>
<p>从输出可以看到索引已成功重建，并且能够通过索引查询到测试值。此时，我们还需要留意实际集群中索引重建的完成情况。如果数据量很大，脚本可能在索引完全建好之前就返回了“查询成功”（因为刚好测试值所在的部分已经建索引完成）。对于生产环境中的大型索引，建议在脚本执行后，通过监控或日志进一步确认索引重建的完成，然后再恢复业务流量。</p>
<h2 id="结论"><a aria-hidden="true" tabindex="-1" href="#结论"><span class="icon icon-link"></span></a>结论</h2>
<p>在 Cassandra 集群中，二级索引的异常修复与重建是一项需要谨慎对待的维护操作。本文通过介绍 Cassandra 和二级索引的原理，阐述了手动重建索引的原因和重要性，并给出了实际操作步骤和自动化脚本示例。在实际应用中，我们应尽量避免二级索引失效或性能问题的发生，例如合理评估索引列的基数和查询模式，定期关注索引相关的监控指标。一旦索引出现问题，按照上述流程重建索引能够有效恢复集群的查询能力。但需要注意的是，重建索引对集群有一定性能影响，应在业务低谷期进行，并做好应用停机或流量切换的准备。</p>
<p>通过对 Cassandra 索引重建实践 的深入了解，我们可以更从容地应对分布式数据库运维中的索引挑战，保障数据库服务的稳定可靠运行。</p> </article> <html lang="en" data-astro-cid-uffxixac> <head><!-- Global Metadata --><meta charset="utf-8"><!--<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">--><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css"><link rel="shortcut icon" href="favicon.png" type="image/png"><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="Ge Yuxu • AI &#38; Engineering" href="https://geyuxu.com/rss.xml"><meta name="generator" content="Astro v5.7.5"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://geyuxu.com/blog/search/20220318_cassandra%E7%B4%A2%E5%BC%95%E9%87%8D%E5%BB%BA%E5%AE%9E%E8%B7%B5/"><!-- Primary Meta Tags --><title>Ge Yuxu • AI &amp; Engineering</title><meta name="title" content="Ge Yuxu • AI &#38; Engineering"><meta name="description" content="Welcome to my blog!"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://geyuxu.com/blog/search/20220318_cassandra%E7%B4%A2%E5%BC%95%E9%87%8D%E5%BB%BA%E5%AE%9E%E8%B7%B5/"><meta property="og:title" content="Ge Yuxu • AI &#38; Engineering"><meta property="og:description" content="Welcome to my blog!"><meta property="og:image" content="https://geyuxu.com/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://geyuxu.com/blog/search/20220318_cassandra%E7%B4%A2%E5%BC%95%E9%87%8D%E5%BB%BA%E5%AE%9E%E8%B7%B5/"><meta property="twitter:title" content="Ge Yuxu • AI &#38; Engineering"><meta property="twitter:description" content="Welcome to my blog!"><meta property="twitter:image" content="https://geyuxu.com/blog-placeholder-1.jpg"><script src="/js/jquery-3.7.1.min.js"></script></head> <body data-astro-cid-uffxixac>  <div class="statement" data-astro-cid-uffxixac> <blockquote data-astro-cid-uffxixac> <p data-astro-cid-uffxixac><strong data-astro-cid-uffxixac>脱敏说明</strong>：本文所有出现的表名、字段名、接口地址、变量名、IP&nbsp;地址及示例数据均已进行脱敏或虚拟化处理，仅用于阐述技术思路与实现步骤。<br data-astro-cid-uffxixac>
&nbsp;&nbsp;&nbsp;&nbsp;文中所示任何标识符并不对应实际生产环境中的名称或编号。<br data-astro-cid-uffxixac>
&nbsp;&nbsp;&nbsp;&nbsp;示例&nbsp;SQL、脚本及数据均为演示用途，不含真实业务数据，也不具备直接运行或复现的完整上下文。<br data-astro-cid-uffxixac>
&nbsp;&nbsp;&nbsp;&nbsp;读者若需在实际项目中参考本文方案，请结合自身业务场景及数据安全规范，使用符合内部命名和权限控制的配置。</p> <p data-astro-cid-uffxixac><strong data-astro-cid-uffxixac>版权声明</strong>：本文版权归原作者所有，未经作者事先书面许可，任何单位或个人不得以任何方式复制、转载、摘编或用于商业用途。<br data-astro-cid-uffxixac>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;若需非商业性引用或转载本文内容，请务必注明出处并保持内容完整。<br data-astro-cid-uffxixac>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;对因商业使用、篡改或不当引用本文内容所产生的法律纠纷，作者保留追究法律责任的权利。<br data-astro-cid-uffxixac><br data-astro-cid-uffxixac> <em data-astro-cid-uffxixac>Copyright&nbsp;©&nbsp;1989–Present&nbsp;Ge&nbsp;Yuxu.&nbsp;All&nbsp;Rights&nbsp;Reserved.</em></p> </blockquote> </div></body></html>  </article> </div> </main> <footer data-astro-cid-sz7xmlte>
&copy; 2025 All rights reserved.
</footer>  </body></html>