<!DOCTYPE html><html lang="zh"> <head><!-- Global Metadata --><meta charset="utf-8"><!--<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">--><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css"><link rel="shortcut icon" href="/favicon.png" type="image/png"><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="Ge Yuxu • AI &#38; Engineering" href="https://geyuxu.com/rss.xml"><meta name="generator" content="Astro v5.5.6"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://geyuxu.com/blog/ai/mcp/%E7%BB%93%E5%90%88-claude-codegraphiti-%E5%92%8C-neo4j-%E6%9E%84%E5%BB%BA-agent-%E9%95%BF%E8%AE%B0%E5%BF%86%E7%B3%BB%E7%BB%9F/"><!-- Primary Meta Tags --><title>结合 Claude Code、Graphiti 和 Neo4j 构建 Agent 长记忆系统</title><meta name="title" content="结合 Claude Code、Graphiti 和 Neo4j 构建 Agent 长记忆系统"><meta name="description"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://geyuxu.com/blog/ai/mcp/%E7%BB%93%E5%90%88-claude-codegraphiti-%E5%92%8C-neo4j-%E6%9E%84%E5%BB%BA-agent-%E9%95%BF%E8%AE%B0%E5%BF%86%E7%B3%BB%E7%BB%9F/"><meta property="og:title" content="结合 Claude Code、Graphiti 和 Neo4j 构建 Agent 长记忆系统"><meta property="og:description"><meta property="og:image" content="https://geyuxu.com/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://geyuxu.com/blog/ai/mcp/%E7%BB%93%E5%90%88-claude-codegraphiti-%E5%92%8C-neo4j-%E6%9E%84%E5%BB%BA-agent-%E9%95%BF%E8%AE%B0%E5%BF%86%E7%B3%BB%E7%BB%9F/"><meta property="twitter:title" content="结合 Claude Code、Graphiti 和 Neo4j 构建 Agent 长记忆系统"><meta property="twitter:description"><meta property="twitter:image" content="https://geyuxu.com/blog-placeholder-1.jpg"><script src="/js/jquery-3.7.1.min.js"></script><script is:global>
	window.addEventListener('DOMContentLoaded', () => {
		$('.toc ol').css({
		'list-style': 'none',   // 隐藏 1. 2. 3.
		'margin': 0,
		'padding-left': 0,       // 可按需调整
		});
		$('.toc ol > li').css({
		'list-style': 'none',   // 隐藏 1. 2. 3.
		'padding-left': 10
		});
        $('.sidebar').append($('.toc'));
      });
	</script><link rel="stylesheet" href="/_astro/_slug_.BvCO7WHQ.css">
<style>a[data-astro-cid-eimmu3lg]{display:inline-block;text-decoration:none}a[data-astro-cid-eimmu3lg].active{font-weight:bolder;text-decoration:underline}header[data-astro-cid-3ef6ksr2]{margin:0;padding:0 1em;background:#fff;box-shadow:0 2px 8px rgba(var(--black),5%)}h2[data-astro-cid-3ef6ksr2]{margin:0;font-size:1em}h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2],h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none}nav[data-astro-cid-3ef6ksr2]{display:flex;align-items:center;justify-content:space-between}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{padding:1em .5em;color:var(--black);border-bottom:4px solid transparent;text-decoration:none}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none;border-bottom-color:var(--accent)}.social-links[data-astro-cid-3ef6ksr2],.social-links[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{display:flex}@media (max-width: 720px){.social-links[data-astro-cid-3ef6ksr2]{display:none}}footer[data-astro-cid-sz7xmlte]{padding:2em 1em 6em;background:linear-gradient(var(--gray-gradient)) no-repeat;color:rgb(var(--gray));text-align:center}.social-links[data-astro-cid-sz7xmlte]{display:flex;justify-content:center;gap:1em;margin-top:1em}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]{text-decoration:none;color:rgb(var(--gray))}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]:hover{color:rgb(var(--gray-dark))}
.statement[data-astro-cid-uffxixac]{font-size:10px;color:gray}@media (max-width: 640px){.statement[data-astro-cid-uffxixac]{font-size:6px;color:gray}}
</style></head> <body> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <!--<h2><a href="/">{SITE_TITLE}</a></h2>--> <h2 data-astro-cid-3ef6ksr2><a style="padding-left:0;color:blue;" href="/" data-astro-cid-3ef6ksr2>Ge Yuxu<br data-astro-cid-3ef6ksr2>AI & Engineering</a></h2> <div class="internal-links" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Home </a>  <a href="/blog/1" class="active" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Blog </a>  <a href="/series" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Series </a>  <a href="/projects" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Projects </a>  </div> <div class="social-links" data-astro-cid-3ef6ksr2> <a href="https://github.com/geyuxu" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Go to Ge Yuxu's GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path></svg> </a> <a href="https://www.linkedin.com/in/geyuxu/" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Go to Ge Yuxu's LinkedIn profile</span> <svg viewBox="0 0 24 24" width="32" height="32" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" data-astro-cid-3ef6ksr2> <path fill="currentColor" d="M20.447 20.452H17.2v-5.569c0-1.328-.025-3.039-1.852-3.039-1.853 0-2.136 1.447-2.136 2.942v5.666h-3.248V9h3.122v1.561h.045c.435-.823 1.498-1.688 3.083-1.688 3.295 0 3.903 2.17 3.903 4.989v6.59zM5.337 7.433a1.882 1.882 0 110-3.764 1.882 1.882 0 010 3.764zm1.626 13.019H3.708V9h3.255v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.226.792 24 1.771 24h20.451C23.2 24 24 23.226 24 22.271V1.729C24 .774 23.2 0 22.222 0z" data-astro-cid-3ef6ksr2></path> </svg> </a> </div> </nav> <!-- Microsoft Clarity --> <script type="text/javascript">
		(function(c,l,a,r,i,t,y){
			c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
			t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
			y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
		})(window, document, "clarity", "script", "rc2w96osp6");
	</script> </header>  <main class="page"> <!-- 左侧栏 --> <aside class="sidebar"> <div class="meta"> <b>结合 Claude Code、Graphiti 和 Neo4j 构建 Agent 长记忆系统</b> <p><time datetime="2025-07-22T16:00:00.000Z"> 2025/07/23 00:00:00 </time></p>   </div> <hr> <br> </aside> <!-- 右侧正文区域（flex 居中） --> <div class="content-wrapper"> <article class="prose">  <nav class="toc"><ol class="toc-level toc-level-1"><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#安装与配置步骤">安装与配置步骤</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#使用验证">使用验证</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#graphiti-memory-的功能类别">Graphiti Memory 的功能类别</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#使用建议与踩坑记录">使用建议与踩坑记录</a></li></ol></nav><h1 id="结合-claude-codegraphiti-和-neo4j-构建-agent-长记忆系统"><a aria-hidden="true" tabindex="-1" href="#结合-claude-codegraphiti-和-neo4j-构建-agent-长记忆系统"><span class="icon icon-link"></span></a>结合 Claude Code、Graphiti 和 Neo4j 构建 Agent 长记忆系统</h1>
<p>在大型语言模型（LLM）应用中，为 Agent 增强“长期记忆”是一大挑战。常规对话上下文有长度限制，超出后模型容易遗忘早期信息，常见做法是借助RAG（检索增强生成）等手段将外部知识检索进来。但传统 RAG 多针对静态文档批处理，不善于处理频繁变化的对话数据。为此，我们选择了 Claude Code、Graphiti 和 Neo4j 组合，构建一个具备长期记忆的 AI Agent。</p>
<ul>
<li>Claude Code：Anthropic 提供的开发者版对话平台，支持代码执行和 MCP（Model Context Protocol）插件接口，可让 AI 调用外部工具和资源。Claude Code 拥有超大上下文窗口，适合作为智能Agent的前端，使其可以在对话中动态存取“记忆”等外部资源。</li>
<li>Graphiti：Zep 公司开源的时序知识图谱框架，用于作为 AI 的“长时记忆”存储。Graphiti 可以将对话内容、结构化数据作为“episode”逐条写入知识图，并自动抽取其中的实体和关系 。它支持实时增量更新、双时间轴（事件发生与写入时间）记录和混合检索（语义+关键词+图遍历），能够在不重算全部知识的情况下快速查询历史信息 。Graphiti 已被用于 Zep 的 AI 内存层，经证明是当前 AI Agent 最先进的记忆方案 。</li>
<li>Neo4j：流行的图数据库，用于存储 Graphiti 构建的知识图谱。Neo4j 拥有ACID事务和强大的关系查询能力，与 Graphiti 完美适配。Graphiti 默认支持 Neo4j 5.x，通过 Bolt 协议连接，将嵌入向量等数据存入 Neo4j 节点。使用 Neo4j Desktop 可以方便地本地搭建图数据库 。</li>
</ul>
<p>组合优势：Claude Code + Graphiti + Neo4j 的链路，使 AI Agent 拥有持久化、结构化的记忆。每次用户交互都通过 Graphiti 实时融合进知识图谱，Agent 能对知识进行语义+图混合搜索，低延迟检索相关历史，从而在不同会话之间保持“上下文感知” 。相比仅依赖LLM上下文或向量库，本方案可精确存取复杂关系和事件演变，为任务规划和推理提供依据。此外，Graphiti 针对动态数据设计，可处理经常更新的知识而无需频繁重建索引 ，非常适合需要持续学习的 Agent 应用。</p>
<h2 id="安装与配置步骤"><a aria-hidden="true" tabindex="-1" href="#安装与配置步骤"><span class="icon icon-link"></span></a>安装与配置步骤</h2>
<p>下面总结基于实践的安装与配置流程：</p>
<ol>
<li>安装 Neo4j Desktop：从 Neo4j 官方网站下载 Neo4j Desktop 并安装。Neo4j Desktop 提供直观的界面来管理本地数据库，非常适合入门 。安装完成后启动 Neo4j Desktop。</li>
<li>创建数据库实例并设置密码：在 Neo4j Desktop 中创建一个新的本地图数据库（版本需 5.x 或更高）。首次启动数据库时会要求设置一个密码，请设定Neo4j 用户（默认用户名为 neo4j）的密码，并牢记此信息。默认情况下，Neo4j 的 Bolt 连接 URI 为 bolt://localhost:7687，后续 Graphiti 将通过此 URI 连接数据库。</li>
<li>克隆 Graphiti 仓库并配置环境：打开终端，克隆 Graphiti 源码仓库并进入目录：</li>
</ol>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>git clone https://github.com/getzep/graphiti.git</span></span>
<span class="line"><span>cd graphiti/mcp_server</span></span></code></pre>
<p>仓库中提供了 .env.example 模板文件。复制一份作为 .env 并根据实际情况填写Neo4j和OpenAI配置：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>OPENAI_API_KEY=&#x3C;你的OpenAI API密钥></span></span>
<span class="line"><span>MODEL_NAME=gpt-4.1-mini        # 指定LLM模型名称，例如 OpenAI 的 GPT-4 mini 版本</span></span>
<span class="line"><span>NEO4J_URI=bolt://localhost:7687</span></span>
<span class="line"><span>NEO4J_USER=neo4j</span></span>
<span class="line"><span>NEO4J_PASSWORD=&#x3C;你的Neo4j密码></span></span></code></pre>
<p>其中 OPENAI_API_KEY 是 Graphiti 用于调用 OpenAI 接口进行LLM推理和嵌入的密钥，MODEL_NAME 可以指定OpenAI模型（如 gpt-3.5-turbo 或 gpt-4 系列，默认示例使用的是 GPT-4.1 mini 模型），Neo4j 部分填写刚才创建数据库的连接信息和凭证。</p>
<ol start="4">
<li>安装所需工具（uv、uvicorn、claude-cli）：</li>
</ol>
<ul>
<li>uv：Graphiti 推荐使用 Astral 开发的 uv 工具来管理Python环境和依赖。先通过 pip install uv 安装 uv 。然后在 graphiti/mcp_server 目录下执行 uv sync，该命令会根据项目的锁定文件安装所需的Python包。uv 类似于 pip，但能更快速地同步依赖。若不使用 uv，也可以手动创建虚拟环境并使用 pip install -r requirements.txt 安装依赖。</li>
<li>uvicorn：如果打算通过 HTTP SSE 方式运行服务，需要安装 ASGI 服务器 uvicorn（通常已在依赖中）。确保命令行下可以调用 uvicorn（例如 pip install uvicorn）。</li>
<li>claude-cli：Claude Code 提供了命令行工具来管理 MCP 插件。安装 claude CLI 工具（例如通过 pip install anthropic 或其他途径，具体可参考 Anthropic 文档）。安装后，命令行应能使用 claude 命令，用于添加MCP服务器等配置 。</li>
</ul>
<ol start="5">
<li>启动 Graphiti MCP Server 并在 Claude 中注册插件：Graphiti 仓库自带 MCP Server 实现，用于充当 Claude 等前端与 Graphiti 后端之间的桥梁。启动步骤有两种方式：</li>
</ol>
<ul>
<li>方法A：通过 Claude Code CLI 启动（stdio 模式）：这种方式将 Graphiti MCP Server 作为 Claude 的子进程，通过标准输入输出通信。在命令行执行以下命令将 Graphiti 插件添加到 Claude Code（user范围）：</li>
</ul>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>claude mcp add-json graphiti-memory '{</span></span>
<span class="line"><span>  "type": "stdio",</span></span>
<span class="line"><span>  "command": "/usr/local/bin/uv",</span></span>
<span class="line"><span>  "args": [</span></span>
<span class="line"><span>    "run", "--directory", "/path/to/graphiti/mcp_server", </span></span>
<span class="line"><span>    "graphiti_mcp_server.py", "--transport", "stdio"</span></span>
<span class="line"><span>  ],</span></span>
<span class="line"><span>  "env": {</span></span>
<span class="line"><span>    "OPENAI_API_KEY": "&#x3C;你的OpenAI密钥>",</span></span>
<span class="line"><span>    "MODEL_NAME": "gpt-4.1-mini",</span></span>
<span class="line"><span>    "NEO4J_URI": "bolt://localhost:7687",</span></span>
<span class="line"><span>    "NEO4J_USER": "neo4j",</span></span>
<span class="line"><span>    "NEO4J_PASSWORD": "&#x3C;你的Neo4j密码>"</span></span>
<span class="line"><span>  }</span></span>
<span class="line"><span>}'</span></span></code></pre>
<p>将上述命令中的路径和参数替换为实际值（例如 uv 可执行路径、Graphiti 仓库位置等）。执行后，Claude Code 会登记一个名为 “graphiti-memory” 的 MCP 插件，Claude 在对话中需要用到记忆时会自动启动该Server并通过 stdio 通信。</p>
<ul>
<li>方法B：独立运行 Graphiti Server（SSE 模式）：这种方式下 Graphiti 作为独立服务，通过 HTTP Server-Sent Events (SSE) 接口供 Claude 访问。可以执行：</li>
</ul>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>cd graphiti/mcp_server</span></span>
<span class="line"><span>uv run graphiti_mcp_server.py --transport sse --model gpt-4.1-mini</span></span></code></pre>
<p>上述命令将 Graphiti MCP Server 以 SSE 模式跑在本地（默认监听 0.0.0.0:8000）。成功启动后，使用 Claude CLI 将此服务添加为 MCP 插件：</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0" data-language="plaintext"><code><span class="line"><span>claude mcp add --transport sse --scope user graphiti-memory http://localhost:8000/sse</span></span></code></pre>
<p>这样Claude就注册了一个名为 “graphiti-memory” 的远程MCP服务（通过HTTP连接）。—scope user 表示对此用户全局可用（也可用 —scope project 针对某项目）。完成后，可在 Claude Code 界面的“MCP Servers”列表中看到 graphiti-memory 插件。</p>
<p>完成以上安装配置后，Claude Agent 就拥有了 Graphiti 知识图谱作为长时记忆存储。接下来可以尝试与 Claude 进行对话，记录信息并验证内存功能。</p>
<h2 id="使用验证"><a aria-hidden="true" tabindex="-1" href="#使用验证"><span class="icon icon-link"></span></a>使用验证</h2>
<p>要确认 Graphiti 内存是否正常工作，可以从Neo4j侧直接检查数据是否写入：</p>
<ul>
<li>知识图谱节点检查：打开 Neo4j Browser（Neo4j Desktop 内置）连接到刚才的数据库，执行 Cypher 查询：MATCH (n:Episodic) RETURN n LIMIT 25; 。Graphiti 将每条对话或信息片段存储为 “Episodic” 标签的节点，可通过该查询查看最新写入的若干 Episode 节点及其属性。如果能看到节点列表，说明 Claude 已成功将对话内容存进 Neo4j。</li>
</ul>
<p>如果未能查询到任何 Episode 节点或 Graphiti 功能异常，建议从以下方面排查：</p>
<ul>
<li>Bolt 连接问题：确认 Graphiti MCP Server 能连接上 Neo4j 数据库。检查 .env 配置的 NEO4J_URI 和端口是否正确，本地默认应为 bolt://localhost:7687。确保 Neo4j 数据库已启动且未设置防火墙阻止本地 Bolt 连接。如果 Neo4j 使用了非默认的数据库名称或用户名，也需要相应调整 Graphiti 配置。</li>
<li>OpenAI API Key 状态：Graphiti 在写入对话时，会调用 OpenAI 的模型来抽取实体和生成 embeddings 。如果提供的 API Key 无效或者余额不足，Graphiti 可能无法完成 Episode 的解析写入。可以查看运行 Graphiti Server 的终端输出日志，若出现 OpenAI 接口报错或余额不足的信息，则需要更换有效的 API Key（OpenAI 如开启数据分享可每日获得一定免费额度）或者确保账户有足够额度。</li>
<li>Claude 插件启用：确认 Graphiti MCP 插件已在 Claude 前端启用。在 Claude Code 中，新添加的 MCP Server 可能需要在对话界面中开启（如Claude Desktop中需要在对话窗口右上角“插件”列表里勾选启用）。如果插件未启用，Claude将不会实际调用 Graphiti。另请注意，Claude 对资源和提示类型的 MCP 功能默认不会自动触发调用 （详见下文），因此在测试时可以先提出与已记录内容相关的问题，看看 Claude 是否能够利用之前存储的记忆进行回答。</li>
</ul>
<h2 id="graphiti-memory-的功能类别"><a aria-hidden="true" tabindex="-1" href="#graphiti-memory-的功能类别"><span class="icon icon-link"></span></a>Graphiti Memory 的功能类别</h2>
<p>作为 MCP Server，Graphiti 提供了三类接口能力，对应 MCP 定义的Resources、Tools 和 Prompts 三种类型 。理解这三者有助于发挥 Graphiti 内存的作用：</p>
<ol>
<li>Resources（资源工具）：用于检索信息的接口。如从内部知识图谱或外部数据库获取内容。这类接口只读数据不产生副作用，作用是让 LLM 访问知识库中的历史信息。例如 Graphiti 提供检索节点、事实的资源接口，支持时间感知的查询，可以按时间或条件获取过往对话片段 。Claude 在需要引用记忆时，可以调用 Resource 类型的功能读取相关内容。</li>
<li>Tools（工具）：用于执行操作的接口，会对外部环境或数据产生变化。如通过 API 写入数据、进行计算等。Graphiti 的工具接口允许 LLM 将新的知识添加到图谱，或调用实时的搜索和图操作，实现在线更新记忆 。每当用户提供新信息，Claude Agent 可以调用 Graphiti 的工具类方法（如 add_episode）将其存为新节点，从而持续积累知识。</li>
<li>Prompts（提示模板）：指预定义的提示词模板或工作流，方便 LLM 和 MCP Server 之间复用复杂交互逻辑。例如 Graphiti 可能提供某些查询的模板，封装常用的多步操作 。这些 Prompt 模板可以视作Agent的一些“技能脚本”，当触发特定需求时调用。通过 Prompts，开发者可将标准查询模式固化，让 Claude 在需要时一键生成对 Graphiti 的查询请求。</li>
</ol>
<p>需要注意，在 Claude Desktop 目前的实现中，Tools 类型的 MCP 接口（如Graphiti的写入/搜索功能）可以根据对话上下文自动调用，而 Resources 和 Prompts 类型则不会自动触发 。也就是说，即使 Graphiti 列出了可用的资源和提示模板，Claude 默认不知道何时用它们，除非用户主动附加。这一点在实际使用中尤为重要，下一节会讨论应对策略。</p>
<h2 id="使用建议与踩坑记录"><a aria-hidden="true" tabindex="-1" href="#使用建议与踩坑记录"><span class="icon icon-link"></span></a>使用建议与踩坑记录</h2>
<p>基于实际体验，这里总结一些使用Graphiti长记忆过程中值得注意的建议和可能遇到的坑：</p>
<ul>
<li>调试 Graphiti 写入：当发现对话内容没有写入Neo4j时，可以检查 Graphiti MCP Server 的控制台输出日志。Graphiti 启动时会打印使用的模型名、Group ID等信息，执行写入时如发生错误（例如 OpenAI 返回格式不符合预期），通常也会有异常堆栈打印在日志中。调试时，可尝试直接调用 Graphiti 的 API（例如 REST 接口）添加测试数据，或使用简短且结构清晰的输入触发 add_episode，以隔离问题。确保 .env 已正确加载（可以在启动命令中显式指定 —env-file .env 以防万一）。如果 Graphiti 提示embedding或解析schema错误，通常是模型输出不符合预期 JSON 格式导致的。</li>
<li>避免 Schema 错误：Graphiti 要求所使用的 LLM 支持结构化输出，以确保提取实体关系时格式正确 。建议使用 OpenAI 的 GPT-4 或新版 GPT-3.5 等具备函数调用或严格JSON输出能力的模型。如果使用不支持结构化输出的模型（尤其是体量较小的模型），可能出现 Graphiti 无法解析返回内容、Episode 写入失败的情况（表现为日志报错 schema mismatch 等）。另外，第一次运行 Graphiti 会在 Neo4j 上创建所需索引和约束，如看到 IndexAlreadyExists 提示可忽略 。在调整 Graphiti 的实体/关系类型定义时，尽量保持与Neo4j模式一致，避免因为模式不符导致写入错误。</li>
<li>Claude 中正确触发 Memory：为了让 Claude 充分利用 Graphiti 长期记忆，需要在对话策略上进行一些引导。目前Claude对 Resource/Prompt 并非自动使用，因此用户或开发者需要主动触发。有几种实践技巧：其一，在对话最开始就提示Claude可以使用Graphiti记忆，并在需要时应先查询图谱。例如可以设定系统提示：“请先搜索已有知识再回答”。其二，熟练运用 Claude 界面提供的**“引用 (References)”** 功能：在 Claude Desktop 中，可点击“+”号从 MCP Server 附加存储的记忆片段作为参考资料 。其三，参考官方建议制定对话约定——例如 “先检索后回答” 和 “有新信息立即记录”。   上述规则可作为Claude的提示，让模型养成遇到新偏好/事实就调用 add_episode 保存，遇到问题先调用 search_nodes/search_facts 检索相关节点和关系的习惯。这种显式的提示能大大提高 Graphiti 内存的利用率。总之，目前需要一定人为引导，未来版本Claude可能会让AI自动意识到可用的记忆资源并调用。</li>
</ul>
<p>通过以上工具链的稳定配置和调整，Claude Code 与 Graphiti + Neo4j 的集成可以顺利运行，一个具备长时记忆的 AI Agent 也就搭建完成了。在真实开发中，我们应不断根据日志和对话表现去优化提示策略，确保AI既“记得住”用户提供的知识，又能在需要时准确想起并加以利用。这套方案在复杂项目中能有效避免信息遗忘，大幅提升Agent长程任务的连贯性和智能水平。今后若Claude插件机制升级，实现自动利用Resource/Prompt，那么AI长记忆将更加得心应手。希望以上踩坑心得能帮助大家更容易地复现这一强大的长记忆Agent方案！</p> <html lang="en" data-astro-cid-uffxixac> <head><!-- Global Metadata --><meta charset="utf-8"><!--<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">--><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css"><link rel="shortcut icon" href="/favicon.png" type="image/png"><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="Ge Yuxu • AI &#38; Engineering" href="https://geyuxu.com/rss.xml"><meta name="generator" content="Astro v5.5.6"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://geyuxu.com/blog/ai/mcp/%E7%BB%93%E5%90%88-claude-codegraphiti-%E5%92%8C-neo4j-%E6%9E%84%E5%BB%BA-agent-%E9%95%BF%E8%AE%B0%E5%BF%86%E7%B3%BB%E7%BB%9F/"><!-- Primary Meta Tags --><title>Ge Yuxu • AI &amp; Engineering</title><meta name="title" content="Ge Yuxu • AI &#38; Engineering"><meta name="description" content="Welcome to my blog!"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://geyuxu.com/blog/ai/mcp/%E7%BB%93%E5%90%88-claude-codegraphiti-%E5%92%8C-neo4j-%E6%9E%84%E5%BB%BA-agent-%E9%95%BF%E8%AE%B0%E5%BF%86%E7%B3%BB%E7%BB%9F/"><meta property="og:title" content="Ge Yuxu • AI &#38; Engineering"><meta property="og:description" content="Welcome to my blog!"><meta property="og:image" content="https://geyuxu.com/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://geyuxu.com/blog/ai/mcp/%E7%BB%93%E5%90%88-claude-codegraphiti-%E5%92%8C-neo4j-%E6%9E%84%E5%BB%BA-agent-%E9%95%BF%E8%AE%B0%E5%BF%86%E7%B3%BB%E7%BB%9F/"><meta property="twitter:title" content="Ge Yuxu • AI &#38; Engineering"><meta property="twitter:description" content="Welcome to my blog!"><meta property="twitter:image" content="https://geyuxu.com/blog-placeholder-1.jpg"><script src="/js/jquery-3.7.1.min.js"></script></head> <body data-astro-cid-uffxixac>  <div class="statement" data-astro-cid-uffxixac> <blockquote data-astro-cid-uffxixac> <p data-astro-cid-uffxixac><strong data-astro-cid-uffxixac>脱敏说明</strong>：本文所有出现的表名、字段名、接口地址、变量名、IP地址及示例数据等均非真实，
    仅用于阐述技术思路与实现步骤，示例代码亦非公司真实代码。
    示例方案亦非公司真实完整方案，仅为本人记忆总结，用于技术学习探讨。<br data-astro-cid-uffxixac>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;文中所示任何标识符并不对应实际生产环境中的名称或编号。<br data-astro-cid-uffxixac>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;示例&nbsp;SQL、脚本、代码及数据等均为演示用途，不含真实业务数据，也不具备直接运行或复现的完整上下文。<br data-astro-cid-uffxixac>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;读者若需在实际项目中参考本文方案，请结合自身业务场景及数据安全规范，使用符合内部命名和权限控制的配置。</p> <p data-astro-cid-uffxixac><strong data-astro-cid-uffxixac>版权声明</strong>：本文版权归原作者所有，未经作者事先书面许可，任何单位或个人不得以任何方式复制、转载、摘编或用于商业用途。<br data-astro-cid-uffxixac>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;若需非商业性引用或转载本文内容，请务必注明出处并保持内容完整。<br data-astro-cid-uffxixac>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;对因商业使用、篡改或不当引用本文内容所产生的法律纠纷，作者保留追究法律责任的权利。<br data-astro-cid-uffxixac><br data-astro-cid-uffxixac> <em data-astro-cid-uffxixac>Copyright&nbsp;©&nbsp;1989–Present&nbsp;Ge&nbsp;Yuxu.&nbsp;All&nbsp;Rights&nbsp;Reserved.</em></p> </blockquote> </div></body></html>  </article> </div> </main> <footer data-astro-cid-sz7xmlte>
&copy; 2025 All rights reserved.
</footer>  </body></html>