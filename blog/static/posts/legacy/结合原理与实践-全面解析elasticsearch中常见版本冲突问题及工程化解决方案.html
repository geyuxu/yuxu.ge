<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»“åˆåŸç†ä¸å®è·µï¼Œå…¨é¢è§£æElasticsearchä¸­å¸¸è§ç‰ˆæœ¬å†²çªé—®é¢˜åŠå·¥ç¨‹åŒ–è§£å†³æ–¹æ¡ˆ | Yuxu Ge</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1/themes/prism-tomorrow.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <style>
        :root {
            --black: #111;
            --dark-grey: #444;
            --off-white: #f4f4f4;
            --vermilion: #C41E3A;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: var(--black);
            background-color: var(--off-white);
        }

        a {
            color: var(--vermilion);
            text-decoration: none;
        }

        a:hover {
            opacity: 0.75;
        }

        .layout {
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 320px;
            height: 100vh;
            background: var(--black);
            color: var(--off-white);
            padding: 3rem 2rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .sidebar-top {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .avatar {
            display: block;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid var(--vermilion);
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: transform 0.2s ease;
        }

        .avatar:hover {
            opacity: 1;
            transform: scale(1.05);
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .name-block {
            margin-bottom: 0.5rem;
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 700;
            letter-spacing: 1px;
            color: var(--off-white);
        }

        .title-role {
            font-size: 0.9rem;
            color: #888;
            margin-top: 0.25rem;
            font-weight: 400;
        }

        .contact-block {
            margin-top: 2.5rem;
            width: 100%;
        }

        .social-links {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }

        .social-links a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 160px;
            color: var(--off-white);
            opacity: 0.7;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .social-links a:hover {
            color: var(--vermilion);
            opacity: 1;
            background: rgba(255, 255, 255, 0.05);
        }

        .social-links svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .social-links .orcid-link {
            font-size: 0.68rem;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .sidebar-footer {
            text-align: center;
            font-size: 0.75rem;
            color: #555;
        }

        /* Content */
        .content {
            margin-left: 320px;
            padding: 3rem 4rem;
            max-width: calc(100vw - 320px - 8rem);
        }

        .back-link {
            display: inline-block;
            font-size: 0.85rem;
            margin-bottom: 2rem;
            color: var(--dark-grey);
        }

        .back-link:hover {
            color: var(--vermilion);
        }

        /* Article */
        article h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            line-height: 1.3;
            color: var(--black);
        }

        article h2 {
            font-size: 1.4rem;
            font-weight: 600;
            margin: 2rem 0 1rem;
            color: var(--black);
        }

        article h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 1.5rem 0 0.75rem;
            color: var(--black);
        }

        article p {
            margin-bottom: 1rem;
            color: var(--dark-grey);
        }

        article ul,
        article ol {
            margin: 1rem 0 1rem 1.5rem;
            color: var(--dark-grey);
        }

        article li {
            margin-bottom: 0.5rem;
        }

        article strong {
            color: var(--black);
        }

        article code {
            font-family: "SF Mono", Monaco, monospace;
            font-size: 0.9em;
            background: #e8e8e8;
            padding: 0.15em 0.4em;
            border-radius: 3px;
        }

        article pre {
            margin: 1rem 0;
            border-radius: 6px;
            overflow-x: auto;
            background: #2d2d2d;
            padding: 1rem;
        }

        article pre code {
            background: none;
            padding: 0;
            font-size: 0.75em;
            white-space: pre !important;
            counter-reset: line;
            display: block;
            color: #ccc;
        }

        article pre code .line {
            counter-increment: line;
        }

        article pre code .line::before {
            content: counter(line);
            display: inline-block;
            width: 2.5em;
            margin-right: 1em;
            text-align: right;
            color: #666;
            user-select: none;
        }

        .code-toolbar {
            display: flex;
            justify-content: flex-start;
            padding: 0.35rem 0.5rem;
            background: #3a3a3a;
            border-radius: 6px 6px 0 0;
        }

        .code-toolbar+pre {
            margin-top: 0;
            border-radius: 0 0 6px 6px;
        }

        .copy-btn {
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
            background: #555;
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .copy-btn:hover,
        .copy-btn:active {
            background: #777;
        }

        .copy-btn.copied {
            background: #2a2;
        }

        article blockquote {
            border-left: 3px solid var(--vermilion);
            padding-left: 1rem;
            margin: 1rem 0;
            color: #666;
            font-style: italic;
        }

        article hr {
            border: none;
            border-top: 1px solid #ddd;
            margin: 2rem 0;
        }

        article table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.9rem;
        }

        article th,
        article td {
            border: 1px solid #ddd;
            padding: 0.5rem 0.75rem;
            text-align: left;
        }

        article th {
            background: #e8e8e8;
            font-weight: 600;
        }

        article img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 1.5rem 0;
            border-radius: 6px;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #888;
        }

        .error {
            color: var(--vermilion);
        }

        /* Language Selector */
        .lang-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            padding: 0.75rem 1rem;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .lang-selector-label {
            color: #666;
            display: flex;
            align-items: center;
            gap: 0.35rem;
        }

        .lang-selector-label svg {
            width: 16px;
            height: 16px;
        }

        .lang-select {
            padding: 0.4rem 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 0.85rem;
            cursor: pointer;
            min-width: 140px;
        }

        .lang-select:focus {
            outline: none;
            border-color: var(--vermilion);
        }

        .lang-status {
            font-size: 0.8rem;
            color: #888;
            margin-left: auto;
        }

        .lang-status.translating {
            color: var(--vermilion);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .lang-status.translating::before {
            content: '';
            width: 14px;
            height: 14px;
            border: 2px solid #f0f0f0;
            border-top-color: var(--vermilion);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .lang-status.cached {
            color: #4CAF50;
        }

        .lang-original-btn {
            padding: 0.35rem 0.6rem;
            font-size: 0.75rem;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            color: #666;
            transition: all 0.2s;
        }

        .lang-original-btn:hover {
            background: #e0e0e0;
            color: #333;
        }

        @media (max-width: 600px) {
            .lang-selector {
                flex-wrap: wrap;
            }
            .lang-status {
                width: 100%;
                margin-left: 0;
                margin-top: 0.5rem;
            }
        }

        /* KaTeX math styles */
        .katex-display {
            overflow-x: auto;
            overflow-y: hidden;
            padding: 0.5rem 0;
        }

        .katex {
            font-size: 1.1em;
        }

        /* Jupyter Notebook Styles */
        .notebook-container {
            margin-top: 1rem;
        }

        .notebook-download {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            margin-bottom: 1.5rem;
            background: var(--black);
            color: var(--off-white);
            border-radius: 4px;
            font-size: 0.85rem;
            transition: opacity 0.2s;
        }

        .notebook-download:hover {
            opacity: 0.8;
            color: var(--off-white);
        }

        .notebook-download svg {
            width: 16px;
            height: 16px;
        }

        .nb-cell {
            margin-bottom: 1.5rem;
        }

        .nb-cell-code .nb-source {
            background: #2d2d2d;
            border-radius: 6px;
            overflow-x: auto;
        }

        .nb-cell-code .nb-source pre {
            margin: 0;
            padding: 1rem;
            color: #ccc;
            font-family: "SF Mono", Monaco, monospace;
            font-size: 0.85em;
        }

        .nb-cell-code .nb-source code {
            background: none;
            padding: 0;
        }

        .nb-output {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 0.75rem;
            margin-top: 0.5rem;
        }

        .nb-output pre {
            margin: 0;
            padding: 0;
            background: transparent;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: "SF Mono", Monaco, monospace;
            font-size: 0.85em;
            color: #222;
        }

        .nb-output img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0.5rem 0;
        }

        .nb-output table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .nb-output th,
        .nb-output td {
            border: 1px solid #ddd;
            padding: 0.5rem;
            text-align: left;
        }

        .nb-output th {
            background: #e8e8e8;
            font-weight: 600;
        }

        .nb-cell-markdown {
            padding: 0;
        }

        .nb-cell-markdown h1:first-child {
            margin-top: 0;
        }

        /* Document Download Button */
        .doc-download {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            margin-bottom: 1.5rem;
            background: var(--black);
            color: var(--off-white);
            border-radius: 4px;
            font-size: 0.85rem;
            transition: opacity 0.2s;
        }

        .doc-download:hover {
            opacity: 0.8;
            color: var(--off-white);
        }

        .doc-download svg {
            width: 16px;
            height: 16px;
        }

        /* PDF Viewer */
        .pdf-container {
            margin-top: 1rem;
        }

        .pdf-viewer {
            width: 100%;
            height: 80vh;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #f5f5f5;
        }

        /* Text File Display */
        .text-container {
            margin-top: 1rem;
        }

        .text-content {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 1.5rem;
            font-family: "SF Mono", Monaco, monospace;
            font-size: 0.9em;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            color: var(--dark-grey);
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Word Document Display */
        .word-container {
            margin-top: 1rem;
        }

        .word-content {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 2rem;
            line-height: 1.8;
            color: var(--dark-grey);
        }

        .word-content p {
            margin-bottom: 1rem;
        }

        .word-content h1,
        .word-content h2,
        .word-content h3 {
            color: var(--black);
            margin: 1.5rem 0 1rem;
        }

        .word-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        .word-content th,
        .word-content td {
            border: 1px solid #ddd;
            padding: 0.5rem;
        }

        .word-content img {
            max-width: 100%;
            height: auto;
        }

        /* Excel Display */
        .excel-container {
            margin-top: 1rem;
        }

        .excel-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .excel-tab {
            padding: 0.5rem 1rem;
            background: #e8e8e8;
            border: none;
            border-radius: 4px 4px 0 0;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .excel-tab.active {
            background: #4CAF50;
            color: white;
        }

        .excel-content {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            overflow-x: auto;
            max-height: 70vh;
            overflow-y: auto;
        }

        .excel-content table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .excel-content th,
        .excel-content td {
            border: 1px solid #ddd;
            padding: 0.4rem 0.6rem;
            text-align: left;
            white-space: nowrap;
        }

        .excel-content th {
            background: #f5f5f5;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .excel-content tr:nth-child(even) {
            background: #fafafa;
        }

        /* PowerPoint Display */
        .ppt-container {
            margin-top: 1rem;
        }

        .ppt-viewer {
            width: 100%;
            height: 80vh;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #f5f5f5;
        }

        /* CSV Display (uses excel styles) */
        .csv-container {
            margin-top: 1rem;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .sidebar {
                position: relative;
                width: 100%;
                height: auto;
                padding: 2rem 1.5rem 1rem;
            }

            .social-links {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
            }

            .social-links a,
            .social-links .orcid-link {
                width: auto;
                padding: 0.5rem;
                font-size: 0;
                gap: 0;
            }

            .social-links svg {
                width: 24px;
                height: 24px;
            }

            .social-links .hide-mobile {
                display: none;
            }

            .sidebar-footer {
                margin-top: 1rem;
            }

            .content {
                margin-left: 0;
                padding: 2rem 1rem;
                max-width: 100%;
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                padding: 1.5rem 1rem 1rem;
            }

            .avatar {
                width: 80px;
                height: 80px;
            }

            h1 {
                font-size: 1.4rem;
            }

            article h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>

<body>

    <div class="layout">
        <aside class="sidebar" id="sidebar-content"></aside>
        <script src="/components/sidebar.js?v=20260128"></script>

        <main class="content">
            <a href="/blog/" class="back-link">â† Back to Blog</a>

            <!-- Language Selector -->
            <div class="lang-selector" id="lang-selector" style="display: none;">
                <span class="lang-selector-label">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
                    </svg>
                    Language
                </span>
                <select class="lang-select" id="lang-select">
                    <option value="en">ğŸ‡ºğŸ‡¸ English</option>
                    <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
                    <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
                    <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
                    <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
                    <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
                    <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
                    <option value="pt">ğŸ‡µğŸ‡¹ PortuguÃªs</option>
                    <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                    <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                </select>
                <button class="lang-original-btn" id="lang-original-btn" style="display: none;">Show Original</button>
                <span class="lang-status" id="lang-status"></span>
            </div>

            <article>
<hr>
<h2>date: 2024-05-28
tags: [search]
legacy: true</h2>
<h1>ç»“åˆåŸç†ä¸å®è·µï¼Œå…¨é¢è§£æElasticsearchä¸­å¸¸è§ç‰ˆæœ¬å†²çªé—®é¢˜åŠå·¥ç¨‹åŒ–è§£å†³æ–¹æ¡ˆ</h1>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æŸæ–‡æ¡£å½“å‰çš„ _version ä¸º 5ï¼Œå¦‚æœå¦ä¸€è¿›ç¨‹è¯•å›¾åŸºäºç‰ˆæœ¬ 4 çš„è¿‡æœŸæ•°æ®è¿›è¡Œæ›´æ–°ï¼ŒElasticsearch ä¼šè¿”å›å¦‚ä¸‹é”™è¯¯ï¼ˆHTTP 409 çŠ¶æ€ï¼‰ï¼š</p>
<blockquote><code>{</code><br>
<code>  &quot;error&quot;: {</code><br>
<code>    &quot;type&quot;: &quot;version_conflict_engine_exception&quot;,</code><br>
<code>    &quot;reason&quot;: &quot;[index_name][document_id]: version conflict, current [5], provided [4]&quot;,</code><br>
<code>    &quot;index&quot;: &quot;index_name&quot;,</code><br>
<code>    &quot;shard&quot;: &quot;0&quot;</code><br>
<code>  },</code><br>
<code>  &quot;status&quot;: 409</code><br>
<code>}</code></blockquote><p>è¿™æ®µæŠ¥é”™ä¿¡æ¯æ¸…æ¥šåœ°è¡¨æ˜ï¼šå½“å‰æ–‡æ¡£ç‰ˆæœ¬æ˜¯ 5ï¼Œè€Œæä¾›çš„æ›´æ–°åŸºäºç‰ˆæœ¬ 4ï¼Œå› æ­¤è¢«åˆ¤æ–­ä¸ºç‰ˆæœ¬å†²çªã€‚ç±»ä¼¼åœ°ï¼Œåœ¨ Elasticsearch 7 åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ï¼Œé”™è¯¯ä¿¡æ¯å¯èƒ½ä¼šä»¥ _seq_no å’Œ _primary_term æ¥æè¿°ï¼Œä¾‹å¦‚ â€œversion conflict, required seqNo [4348], primary term [2]. current document has seqNo [4427] and primary term [2]â€ã€‚ä½†æ— è®ºè¡¨ç°å½¢å¼å¦‚ä½•ï¼Œå…¶æœ¬è´¨éƒ½æ˜¯å¹¶å‘å†™å†²çªå¯¼è‡´çš„ä¹è§‚é”æ£€æŸ¥å¤±è´¥ã€‚</p>
<h2>ç‰ˆæœ¬å†²çªçš„å¸¸è§åŸå› </h2>
<p>äº†è§£ç‰ˆæœ¬å†²çªçš„åŸç†åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å®é™…å¼€å‘ä¸­å“ªäº›åœºæ™¯å®¹æ˜“è§¦å‘è¿™ç§é—®é¢˜ï¼š</p>
<ul>
<li>é«˜å¹¶å‘å†™å…¥ï¼šæœ€å…¸å‹çš„æƒ…å†µæ˜¯å¤šä¸ªçº¿ç¨‹æˆ–æœåŠ¡åŒæ—¶å¯¹åŒä¸€ä¸ªæ–‡æ¡£è¿›è¡Œæ›´æ–°ã€‚ä¾‹å¦‚ï¼Œä¸¤ä¸ªç”¨æˆ·å‡ ä¹åŒæ—¶ä¿®æ”¹åŒä¸€å•†å“çš„åº“å­˜ä¿¡æ¯ï¼Œæˆ–è€…å¾®æœåŠ¡ A å’Œ B ä¸çº¦è€ŒåŒåœ°æ›´æ–°åŒä¸€ç”¨æˆ·çš„æ•°æ®ã€‚å½“å¹¶å‘å†™å…¥äº¤å‰å‘ç”Ÿæ—¶ï¼Œåæäº¤çš„æ›´æ–°å¯èƒ½åŸºäºå·²ç»è¿‡æœŸçš„æ—§æ•°æ®ï¼Œä»è€Œè§¦å‘å†²çªã€‚</li>
<li>ä¸šåŠ¡æµç¨‹ä¸­çš„é¡ºåºé—®é¢˜ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¦‚æœä¸šåŠ¡æµç¨‹æœªä¸¥æ ¼ä¿è¯é¡ºåºï¼Œå¯èƒ½å‡ºç°â€œåæ¥çš„æ“ä½œåè€Œç”¨äº†æ›´æ—©çš„æ•°æ®â€è¿™ç§æƒ…å†µã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œä¸€ä¸ªåå°ä»»åŠ¡ä»æ•°æ®åº“è¯»å–æ•°æ®å¹¶æ›´æ–° ES æ–‡æ¡£ï¼Œä½†åœ¨è¿™è¿‡ç¨‹ä¸­å¦ä¸€ä¸ªæ›´æ–°å·²ç»å†™å…¥äº†æ›´æ–°çš„æ•°æ®åˆ° ESï¼Œè€Œå‰ä¸€ä¸ªä»»åŠ¡å¹¶ä¸çŸ¥æƒ…ï¼Œä»ç„¶ä»¥æ—§æ•°æ®å»è¦†ç›–ï¼Œç»“æœå°±ä¼šäº§ç”Ÿå†²çªã€‚ç±»ä¼¼åœ°ï¼Œå¦‚æœä¸Šä¸€ä¸ªäº‹åŠ¡æ“ä½œå¤±è´¥æˆ–å›æ»šï¼Œåç»­æ“ä½œæ²¡æœ‰æ„è¯†åˆ°å®é™…æ•°æ®å·²ç»æ”¹å˜ï¼Œä¹Ÿå¯èƒ½å‡ºç°ç‰ˆæœ¬ä¸ä¸€è‡´çš„é—®é¢˜ã€‚</li>
<li>åˆ†å¸ƒå¼åŒæ­¥å»¶è¿Ÿï¼šElasticsearch é›†ç¾¤çš„å¤šå‰¯æœ¬æ¶æ„ä»¥åŠå®¢æˆ·ç«¯çš„è¯»å†™æ¨¡å¼ä¹Ÿå¯èƒ½å¼•å‘æ„å¤–çš„å†²çªã€‚å¦‚æœåº”ç”¨ä»æŸä¸ª å‰¯æœ¬åˆ†ç‰‡ è¯»å–äº†ç¨æ—§çš„æ•°æ®ï¼Œç„¶åç´§æ¥ç€å¯¹åŸå§‹æ–‡æ¡£å‘èµ·æ›´æ–°ï¼Œæ­¤æ—¶ä¸»è¦åˆ†ç‰‡ä¸Šä¹Ÿè®¸å·²ç»æœ‰æ›´æ–°æäº¤ä½†å‰¯æœ¬å°šæœªåŒæ­¥ï¼Œå¯¼è‡´åº”ç”¨æ‹¿åˆ°çš„å¹¶ä¸æ˜¯æœ€æ–°çŠ¶æ€ã€‚è¿™æ ·çš„è¯»å†™ç«æ€ä¼šé€ æˆæ›´æ–°æ—¶ç‰ˆæœ¬æ ¡éªŒå¤±è´¥ã€‚æ­¤å¤–ï¼Œåœ¨è·¨é›†ç¾¤åŒæ­¥æˆ–å¼‚æ­¥æ‰¹å¤„ç†åœºæ™¯ä¸‹ï¼Œç”±äºç½‘ç»œæˆ–ç³»ç»Ÿå»¶è¿Ÿï¼Œä¹Ÿå¯èƒ½å­˜åœ¨æ•°æ®ç‰ˆæœ¬ä¸åŒæ­¥çš„é—®é¢˜ã€‚</li>
<li>ä¸å½“çš„æ“ä½œä½¿ç”¨ï¼šæœ‰äº›ç‰ˆæœ¬å†²çªæ¥è‡ªäºå¯¹ Elasticsearch æ¥å£çš„è¯¯ç”¨ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨ op_type=create å»ç´¢å¼•ä¸€ä¸ªå·²å­˜åœ¨çš„æ–‡æ¡£ï¼ŒElasticsearch ä¼šè®¤ä¸ºè¿™æ˜¯é‡å¤åˆ›å»ºï¼Œä»è€Œè¿”å›ç‰ˆæœ¬å†²çªé”™è¯¯ï¼ˆæç¤ºæ–‡æ¡£å·²å­˜åœ¨ï¼‰ã€‚å†æ¯”å¦‚ï¼Œä½¿ç”¨äº† å¤–éƒ¨ç‰ˆæœ¬å·ï¼ˆexternal versionï¼‰ è¿›è¡Œæ§åˆ¶ï¼Œä½†æ²¡æœ‰ä¿è¯ç‰ˆæœ¬å·çš„å•è°ƒé€’å¢ï¼Œå¯¼è‡´è¾ƒå°çš„å¤–éƒ¨ç‰ˆæœ¬å°è¯•è¦†ç›–è¾ƒæ–°çš„ç‰ˆæœ¬ï¼Œä¹Ÿä¼šè¢« ES æ‹’ç»ã€‚è¿™äº›éƒ½å±äºå› ä½¿ç”¨æ–¹å¼å¯¼è‡´çš„å†²çªé”™è¯¯ã€‚</li>
</ul>
<h2>ç‰ˆæœ¬å†²çªé”™è¯¯ä¿¡æ¯è§£æ</h2>
<p>å½“å‘ç”Ÿç‰ˆæœ¬å†²çªæ—¶ï¼ŒElasticsearch ä¼šè¿”å› HTTP 409 Conflict çŠ¶æ€çš„é”™è¯¯å“åº”ï¼Œæ ¸å¿ƒå†…å®¹å°±æ˜¯æˆ‘ä»¬å‰é¢çœ‹åˆ°çš„ version_conflict_engine_exception åŠå…¶åŸå› æè¿°ã€‚è®©æˆ‘ä»¬æ‹†è§£ä¸€ä¸‹è¿™ä¸ªé”™è¯¯ä¿¡æ¯ï¼š</p>
<ul>
<li>å¼‚å¸¸ç±»å‹ï¼šversion_conflict_engine_exception è¡¨ç¤ºç‰ˆæœ¬å†²çªå¼‚å¸¸ï¼Œè¿™æ˜¯ Elasticsearch å¼•æ“åœ¨å¹¶å‘æ§åˆ¶æ—¶æŠ›å‡ºçš„ä¸“æœ‰å¼‚å¸¸ç±»å‹ã€‚</li>
<li>åŸå›  (reason)ï¼šé€šå¸¸åŒ…å«å†²çªçš„ç´¢å¼•åã€æ–‡æ¡£ IDï¼Œä»¥åŠâ€œcurrent [å½“å‰ç‰ˆæœ¬]ï¼Œprovided [æä¾›çš„ç‰ˆæœ¬]â€æˆ–è€…â€œrequired seqNo/primaryTermâ€¦ current has â€¦â€çš„å­—æ ·ã€‚è¿™æ˜ç¡®æŒ‡å‡ºäº†å†²çªçš„ç‰ˆæœ¬å¯¹æ¯”â€”â€”ä¹Ÿå°±æ˜¯æ“ä½œé¢„æœŸçš„ç‰ˆæœ¬å’Œå®é™…æ–‡æ¡£æœ€æ–°ç‰ˆæœ¬ä¹‹é—´çš„ä¸åŒ¹é…ã€‚</li>
<li>çŠ¶æ€ç  409ï¼šHTTP 409 è¡¨ç¤ºå†²çªï¼Œè¿™åœ¨RESTè¯­ä¹‰ä¸­ä¸“æŒ‡è¯·æ±‚ä¸æœåŠ¡å™¨çš„å½“å‰çŠ¶æ€å†²çªã€‚åœ¨ESé‡Œï¼Œè¿™ä¸ªçŠ¶æ€ç å‡ ä¹å°±å’Œç‰ˆæœ¬å†²çªåˆ’ç­‰å·ã€‚</li>
</ul>
<p>é€šè¿‡é”™è¯¯ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥å¿«é€Ÿç¡®å®šæ˜¯å“ªä¸€ä¸ªæ–‡æ¡£å‘ç”Ÿäº†å†²çªï¼Œä»¥åŠå†²çªå‘ç”Ÿæ—¶æ–‡æ¡£çš„ç‰ˆæœ¬æƒ…å†µã€‚è¿™ä¸ºåç»­çš„æ’æŸ¥æä¾›äº†ç›´æ¥çº¿ç´¢ã€‚</p>
<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨ Elasticsearch 7+ ç‰ˆæœ¬ä¸­ï¼Œå¼•å…¥äº† _seq_no å’Œ _primary_term æ¥ä»£æ›¿å•ä¸€çš„ _version è¿›è¡Œå¹¶å‘æ§åˆ¶ã€‚æ—¥å¿—é‡Œçš„ â€œrequired seqNoâ€ ä¿¡æ¯æ„å‘³ç€è¯·æ±‚æ˜¯åœ¨å‡å®šæ–‡æ¡£çš„åºåˆ—å·ä¸ºæŸä¸ªå€¼æ—¶æäº¤çš„ï¼Œä½†å½“å‰åºåˆ—å·å·²ç»ä¸åŒï¼Œå› è€Œå†²çªã€‚è¿™ä¸ç‰ˆæœ¬å·åŸç†ä¸€è‡´ï¼Œåªæ˜¯å®ç°å±‚é¢æ›´åŠ ç²¾ç»†ã€‚ä¸è¿‡ï¼Œå¯¹å¼€å‘è€…æ¥è¯´å¤„ç†æ–¹å¼æ˜¯ç›¸åŒçš„ã€‚</p>
<h2>å¦‚ä½•æ’æŸ¥ç‰ˆæœ¬å†²çªé—®é¢˜</h2>
<p>é‡åˆ°ç‰ˆæœ¬å†²çªå¼‚å¸¸ï¼Œä¸è¦æ…Œä¹±ï¼Œå¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ€è·¯è¿›è¡Œæ’æŸ¥ï¼š</p>
<ul>
<li>å®šä½å†²çªæ–‡æ¡£ï¼šé¦–å…ˆæ ¹æ®é”™è¯¯æ—¥å¿—æ‰¾åˆ°å‘ç”Ÿå†²çªçš„æ–‡æ¡£ ID å’Œç´¢å¼•ã€‚ç„¶åé€šè¿‡ GET è¯·æ±‚è·å–è¯¥æ–‡æ¡£å½“å‰çš„ _versionï¼ˆæˆ– _seq_noï¼‰ç­‰ä¿¡æ¯ã€‚ç¡®è®¤ç°åœ¨æ–‡æ¡£å¤„äºå“ªä¸ªç‰ˆæœ¬ï¼Œè¿™ä¸ºåˆ†ææä¾›äº†åŸºç¡€æ•°æ®ã€‚</li>
<li>å›æº¯æ“ä½œé¡ºåºï¼šæ¢³ç†åº”ç”¨ç¨‹åºä¸­å¯¹è¯¥æ–‡æ¡£çš„æ›´æ–°æµç¨‹ã€‚æ€è€ƒåœ¨å†²çªå‘ç”Ÿå‰åï¼Œæ˜¯å¦æœ‰ä¸¤ä¸ªæˆ–å¤šä¸ªå¹¶è¡Œæ“ä½œåœ¨æ›´æ–°è¿™ä»½æ–‡æ¡£ã€‚æŸ¥çœ‹ç›¸å…³çš„ä»£ç æˆ–æ—¥å¿—ï¼Œç¡®è®¤æ˜¯å¦å­˜åœ¨åŒæ—¶æ›´æ–°çš„æƒ…å†µï¼Œæˆ–æ˜¯å¦æœ‰æ“ä½œä½¿ç”¨äº†è¿‡æœŸçš„æ•°æ®ã€‚ä¾‹å¦‚ï¼Œæ˜¯å¦è¯»å–äº†æ—§æ•°æ®ç„¶ååˆè¿›è¡Œè¦†ç›–å†™å…¥ã€‚</li>
<li>æ¨¡æ‹Ÿå¹¶å‘åœºæ™¯ï¼šå¦‚æœä¸€æ—¶æ— æ³•ç¡®å®šåŸå› ï¼Œå¯ä»¥å°è¯•åœ¨æµ‹è¯•ç¯å¢ƒæ¨¡æ‹Ÿç±»ä¼¼çš„å¹¶å‘æ›´æ–°åœºæ™¯ã€‚ä¾‹å¦‚ï¼Œå¼€å¯å¤šä¸ªçº¿ç¨‹åŒæ—¶å¯¹åŒä¸€æ–‡æ¡£è¿›è¡Œæ›´æ–°ï¼Œçœ‹çœ‹æ˜¯å¦èƒ½é‡ç°å†²çªã€‚è¿™æœ‰åŠ©äºéªŒè¯é—®é¢˜æ˜¯å¦ç”±äºå¹¶å‘å¯¼è‡´ï¼Œä»¥åŠå†²çªé¢‘ç‡å¦‚ä½•ã€‚</li>
<li>æ£€æŸ¥åˆ·æ–°å’Œè¯»å–ç­–ç•¥ï¼šç•™æ„ Elasticsearch çš„åˆ·æ–°æœºåˆ¶å’Œè¯»å–é…ç½®ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒElasticsearch çš„ç´¢å¼•åˆ·æ–°é—´éš”ä¸º1ç§’ï¼Œè¿™æ„å‘³ç€é€šè¿‡æœç´¢æˆ–ä»å‰¯æœ¬è¯»å–çš„æ•°æ®å¯èƒ½æ»åä¸€ç¬é—´ã€‚å¦‚æœåº”ç”¨åœ¨å†™å…¥åç«‹å³é€šè¿‡æœç´¢è¯»å–æ•°æ®å¹¶ç”¨äºä¸‹ä¸€æ¬¡æ›´æ–°ï¼Œå¯èƒ½æ‹¿åˆ°çš„æ˜¯æ—§ç‰ˆæœ¬ã€‚è§£å†³æ–¹æ¡ˆæ˜¯å°½é‡ä½¿ç”¨å®æ—¶çš„ GET è·å–æœ€æ–°æ–‡æ¡£ï¼Œæˆ–è€…åœ¨éœ€è¦ä¸¥æ ¼ä¸€è‡´æ€§æ—¶æ‰‹åŠ¨åˆ·æ–°ï¼ˆrefresh=trueï¼‰åå†è¯»ã€‚æ’æŸ¥æ—¶ï¼Œå¯ä»¥æ£€æŸ¥åº”ç”¨æ˜¯å¦æœ‰ç±»ä¼¼çš„è¯»-&gt;æ”¹-&gt;å†™æ¨¡å¼ä¸”æœªè€ƒè™‘åˆ·æ–°å»¶è¿Ÿã€‚</li>
<li>ç‰¹æ®Šæ“ä½œå¯¼è‡´ï¼šç¡®è®¤æ˜¯å¦ä½¿ç”¨äº† version æˆ– if_seq_no ç­‰å‚æ•°ã€op_type=createã€version_type=external ç­‰ç‰¹æ®Šç”¨æ³•ã€‚å¦‚æœæœ‰ï¼Œä»”ç»†æ ¸å¯¹è¿™äº›å‚æ•°çš„å–å€¼å’Œé€»è¾‘æ˜¯å¦æ­£ç¡®ã€‚ä¾‹å¦‚ï¼Œå¤–éƒ¨ç‰ˆæœ¬å·æ˜¯å¦æ­£ç¡®é€’å¢ï¼Œcreateæ“ä½œæ˜¯å¦çœŸçš„ä¸åº”è¦†ç›–å·²æœ‰æ–‡æ¡£ç­‰ç­‰ã€‚è¿™äº›ç»†èŠ‚ç–æ¼å¾€å¾€ä¹Ÿä¼šå¼•å‘å†²çªå¼‚å¸¸ã€‚</li>
</ul>
<p>é€šè¿‡ä¸Šè¿°æ­¥éª¤ï¼Œæˆ‘ä»¬åŸºæœ¬å¯ä»¥å¼„æ¸…æ¥šå†²çªäº§ç”Ÿçš„åŸå› ã€‚ä¸€æ—¦æ‰¾åˆ°ç—‡ç»“ï¼Œå°±å¯ä»¥æœ‰é’ˆå¯¹æ€§åœ°é€‰æ‹©é€‚å½“çš„è§£å†³æ–¹æ¡ˆã€‚</p>
<h2>è§£å†³æ–¹æ¡ˆä¸å®è·µ</h2>
<p>äº†è§£é—®é¢˜åï¼Œæˆ‘ä»¬è‡ªç„¶å…³å¿ƒå¦‚ä½•è§£å†³å’Œé¿å…ç‰ˆæœ¬å†²çªã€‚ä»¥ä¸‹å°†ä»‹ç»å‡ ç§å¸¸è§çš„åº”å¯¹ç­–ç•¥ï¼Œå¹¶ç»“åˆå®é™…æ¡ˆä¾‹è¿›è¡Œè¯´æ˜ï¼š</p>
<h3>1. ä½¿ç”¨è„šæœ¬æ›´æ–°ä¸ retry_on_conflict æœºåˆ¶è‡ªåŠ¨é‡è¯•</h3>
<p>é’ˆå¯¹å¹¶å‘å†™å†²çªï¼ŒElasticsearch æä¾›äº†ä¸€äº›å†…ç½®æœºåˆ¶æ¥å‡å°‘å†²çªå‘ç”Ÿçš„æ¦‚ç‡ã€‚retry_on_conflict å‚æ•°å°±æ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚å®ƒå¯ä»¥åœ¨ä½¿ç”¨ Update API æ—¶æŒ‡å®šé‡åˆ°å†²çªåè‡ªåŠ¨é‡è¯•çš„æ¬¡æ•°ï¼Œçœå»æˆ‘ä»¬æ‰‹åŠ¨æ•è·å¼‚å¸¸å†é‡è¯•çš„éº»çƒ¦ã€‚</p>
<p>æ­¤å¤–ï¼Œå°†æ›´æ–°é€»è¾‘æ”¾åœ¨ Elasticsearch æœåŠ¡ç«¯æ‰§è¡Œï¼ˆæ¯”å¦‚ä½¿ç”¨ Painless è„šæœ¬è¿›è¡Œå±€éƒ¨æ›´æ–°ï¼‰ï¼Œä¹Ÿèƒ½é™ä½å†²çªé£é™©ã€‚å› ä¸ºç›¸æ¯”å…ˆä»ESå–å‡ºæ•°æ®åœ¨å®¢æˆ·ç«¯ä¿®æ”¹å†å†™å›çš„æ¨¡å¼ï¼Œç›´æ¥åœ¨æœåŠ¡ç«¯åŸºäºæœ€æ–°æ•°æ®æ‰§è¡Œè„šæœ¬ï¼Œå¯ä»¥é¿å…æ‹¿åˆ°è¿‡æœŸæ•°æ®ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®é™…çš„ Java ä»£ç ç‰‡æ®µæ¥å±•ç¤ºå¦‚ä½•ç»“åˆè„šæœ¬æ›´æ–°å’Œ retry_on_conflict æ¥åº”å¯¹å¹¶å‘æ›´æ–°ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸€æ‰¹å•†å“åº“å­˜çš„æ•°æ®éœ€è¦æ›´æ–°åˆ° ESï¼Œæˆ‘ä»¬é‡‡ç”¨æ‰¹é‡æ›´æ–°çš„æ–¹å¼ï¼Œæ¯ä¸ªæ›´æ–°ç”¨ä¸€ä¸ª Painless è„šæœ¬æ¥ç´¯åŠ åº“å­˜å€¼ï¼š</p>
<blockquote><code>BulkRequest bulkRequest = new BulkRequest();</code><br>
<code>for (StockEsDto dto : itemList) {</code><br>
<code>    String docId = dto.getItemId();</code><br>
<code>    if (docId == null) {</code><br>
<code>        continue; // è·³è¿‡æ— æ•ˆID</code><br>
<code>    }</code><br>
<code>    // æ„å»ºæ›´æ–°è¯·æ±‚ï¼Œä½¿ç”¨è„šæœ¬å¹¶è®¾ç½®å†²çªé‡è¯•æ¬¡æ•°</code><br>
<code>    UpdateRequest updateReq = new UpdateRequest(indexName, docId)</code><br>
<code>            .script(painlessScript)        // åŸºäºè„šæœ¬çš„å±€éƒ¨æ›´æ–°</code><br>
<code>            .retryOnConflict(3);           // å†²çªæ—¶è‡ªåŠ¨é‡è¯•3æ¬¡</code><br>
<code>    bulkRequest.add(updateReq);</code><br>
<code>}</code><br>
<code>// æ‰¹é‡æ‰§è¡Œæ›´æ–°</code><br>
<code>BulkResponse response = client.bulk(bulkRequest, RequestOptions.DEFAULT);</code></blockquote><p>åœ¨ä¸Šè¿°ä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ UpdateRequest å°†è„šæœ¬å’Œé‡è¯•å‚æ•°å°è£…åœ¨ä¸€èµ·æäº¤ç»™ ESã€‚Elasticsearch åœ¨æ‰§è¡Œè¿™äº›æ›´æ–°æ—¶ï¼Œå¦‚æœæ£€æµ‹åˆ°ç‰ˆæœ¬å†²çªï¼Œä¼šè‡ªåŠ¨é‡è¯•æœ€å¤š3æ¬¡ã€‚æ¯æ¬¡é‡è¯•æ—¶ï¼Œå®ƒä¼šé‡æ–°è·å–æœ€æ–°çš„æ–‡æ¡£å†…å®¹æ¥æ‰§è¡Œæˆ‘ä»¬æä¾›çš„è„šæœ¬ï¼Œä»è€Œæœ€å¤§ç¨‹åº¦ç¡®ä¿æ›´æ–°èƒ½æˆåŠŸåº”ç”¨ã€‚</p>
<p>éœ€è¦æ³¨æ„ï¼Œretry_on_conflict è™½ç„¶æœ‰æ•ˆå‡å°‘äº†å†²çªå¤±è´¥çš„æ¦‚ç‡ï¼Œä½†å¹¶ä¸æ˜¯ä¸‡èƒ½çš„â€”â€”å¦‚æœçŸ­æ—¶é—´å†…æŒç»­æœ‰å¹¶å‘å†™å…¥ï¼Œé‡è¯•å¤šæ¬¡åä»å¯èƒ½å¤±è´¥ã€‚å› æ­¤æˆ‘ä»¬è¿˜å¯ä»¥é…åˆä¸‹ä¸€æ­¥çš„æªæ–½ï¼Œå¯¹å¤±è´¥çš„æ“ä½œè¿›è¡Œåº”ç”¨å±‚é¢çš„å†æ¬¡é‡è¯•ã€‚</p>
<h3>2. åº”ç”¨å±‚é‡è¯•å¤±è´¥çš„æ›´æ–°</h3>
<p>å³ä½¿æœ‰ retry_on_conflictï¼Œåœ¨æç«¯é«˜å¹¶å‘ä¸‹ä»å¯èƒ½æœ‰éƒ¨åˆ†æ›´æ–°åœ¨å¤šæ¬¡é‡è¯•åå¤±è´¥ã€‚ä¸ºæ­¤ï¼Œåœ¨åº”ç”¨å±‚å®ç°ä¸€ä¸ªé‡è¯•æœºåˆ¶æ˜¯å¸¸è§ä¸”æœ‰æ•ˆçš„åšæ³•ã€‚æ€è·¯æ˜¯ï¼šå½“æ‰¹é‡æ“ä½œè¿”å›ç»“æœåï¼Œæ£€æŸ¥å…¶ä¸­æ˜¯å¦æœ‰å¤±è´¥é¡¹ï¼Œå¦‚æœæ˜¯ç‰ˆæœ¬å†²çªå¯¼è‡´çš„å¤±è´¥ï¼Œåˆ™ç¨ç­‰å¾…ç‰‡åˆ»å†å°è¯•é‡åšè¿™äº›å¤±è´¥çš„æ›´æ–°ã€‚</p>
<p>ç»§ç»­ä¸Šé¢çš„ Java ä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹ Bulk API çš„å“åº”ç»“æœè¿›è¡Œåˆ†æï¼Œå°†å¤±è´¥çš„å­è¯·æ±‚æå–å‡ºæ¥é‡æ–°æäº¤ã€‚ä¼ªä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<blockquote><code>int maxRetries = 3;</code><br>
<code>BulkResponse response = client.bulk(bulkRequest, RequestOptions.DEFAULT);</code><br>
<code>if (response.hasFailures()) {</code><br>
<code>    BulkRequest retryRequest = new BulkRequest();</code><br>
<code>    for (BulkItemResponse itemResp : response) {</code><br>
<code>        if (itemResp.isFailed() &amp;&amp; </code><br>
<code>            itemResp.getFailure().getStatus() == RestStatus.CONFLICT) {</code><br>
<code>            // å°†ç‰ˆæœ¬å†²çªå¤±è´¥çš„è¯·æ±‚åŠ å…¥é‡è¯•é˜Ÿåˆ—</code><br>
<code># ... (9 more lines)</code></blockquote>
<p><em>Full code available in the <a href="https://github.com/geyuxu">GitHub repository</a>.</em></p><p>ä¸Šè¿°é€»è¾‘ä¸­ï¼Œæˆ‘ä»¬æœ€å¤šå…è®¸ 3 æ¬¡é‡è¯•ï¼Œæ¯æ¬¡é‡è¯•å‰ç­‰å¾…ä¸€ç§’ï¼ˆé¿å…æŒç»­å†²çªï¼‰ã€‚é€šè¿‡è¿™ç§å¤±è´¥ç”„åˆ«+å»¶è¿Ÿé‡è¯•çš„æ–¹å¼ï¼Œå¯ä»¥è¿›ä¸€æ­¥ç¡®ä¿æš‚æ—¶å› å†²çªå¤±è´¥çš„æ“ä½œæœ€ç»ˆæœ‰æœºä¼šæˆåŠŸã€‚åœ¨å®è·µä¸­ï¼Œè¿™ç§åº”ç”¨å±‚çš„é‡è¯•é€šå¸¸å’Œæ—¥å¿—ç›‘æ§é…åˆä½¿ç”¨ï¼šè‹¥æœ€åä»æœ‰å¤±è´¥ï¼ŒåŠæ—¶è®°å½•æŠ¥è­¦ï¼Œä»¥ä¾¿äººå·¥ä»‹å…¥è°ƒæŸ¥ã€‚</p>
<p>å½“ç„¶ï¼Œéœ€è¦æ§åˆ¶é‡è¯•çš„æ¬¡æ•°å’Œé¢‘ç‡ï¼Œä»¥å…åœ¨å†²çªä¸¥é‡æ—¶é™·å…¥æ— é™é‡è¯•æˆ–å¯¹é›†ç¾¤é€ æˆè¿‡å¤§å‹åŠ›ã€‚é€šå¸¸ 3~5 æ¬¡é‡è¯•å·²è¶³å¤Ÿï¼Œå¤§é‡å†²çªé‡è¯•å¯èƒ½æ„å‘³ç€éœ€è¦ä»æ¶æ„ä¸Šé‡æ–°è€ƒè™‘å¹¶å‘å†™è®¾è®¡äº†ã€‚</p>
<h3>3. åˆç†è®¾è®¡æ–‡æ¡£æ›´æ–°æµç¨‹</h3>
<p>ä¸å…¶äº‹åé‡è¯•ï¼Œä¸å¦‚äº‹å‰é¿å…ã€‚ä»æ¶æ„å’Œä¸šåŠ¡æµç¨‹ä¸Šä¼˜åŒ–ï¼Œå°½é‡å‡å°‘åŒä¸€æ–‡æ¡£è¢«å¹¶å‘ä¿®æ”¹çš„æ¦‚ç‡ï¼Œæ˜¯æ ¹æœ¬çš„è§£å†³ä¹‹é“ã€‚è¿™æ–¹é¢å¯ä»¥è€ƒè™‘ï¼š</p>
<ul>
<li>æ‹†åˆ†çƒ­ç‚¹æ–‡æ¡£ï¼šå¦‚æœæŸä¸ªæ–‡æ¡£å†…å®¹éå¸¸å¤æ‚ã€æ›´æ–°é¢‘ç‡é«˜ï¼Œè€ƒè™‘æŒ‰å­—æ®µæˆ–åŠŸèƒ½æ‹†åˆ†æˆå¤šä¸ªç´¢å¼•æˆ–ç±»å‹ï¼Œé¿å…å¤šä¸ªä¸ç›¸å…³çš„æ›´æ–°éƒ½è½åˆ°åŒä¸€æ–‡æ¡£ä¸Šã€‚</li>
<li>ä¸²è¡ŒåŒ–æ›´æ–°ï¼šåœ¨åº”ç”¨å±‚é’ˆå¯¹åŒä¸€å®ä½“çš„æ›´æ–°è¿›è¡Œä¸²è¡ŒåŒ–å¤„ç†ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡é˜Ÿåˆ—ï¼ˆå¦‚æ¶ˆæ¯é˜Ÿåˆ—ï¼‰å°†å¹¶å‘çš„æ›´æ–°è¯·æ±‚ä¸²è¡Œåœ°æ‰§è¡Œï¼Œæˆ–è€…é‡‡ç”¨åˆ†å¸ƒå¼é”ç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªè¿›ç¨‹æ›´æ–°ç‰¹å®šæ–‡æ¡£ã€‚è¿™æ ·è™½ç„¶åœ¨é«˜å¹¶å‘ä¸‹ç‰ºç‰²äº†ä¸€å®šå¹¶è¡Œåº¦ï¼Œä½†æ¢æ¥äº†æ•°æ®çš„ä¸€è‡´æ€§ã€‚ä¸è¿‡è¦è°¨æ…ä½¿ç”¨é”ï¼Œä»¥å…å½±å“æ€§èƒ½ã€‚</li>
<li>å‡å°‘ä¸å¿…è¦çš„æ›´æ–°ï¼šå®¡è§†ä¸šåŠ¡é€»è¾‘ï¼Œé¿å…æ— å·®å¼‚çš„é‡å¤å†™ã€‚æ¯”å¦‚å®šæ—¶ä»»åŠ¡æ¯æ¬¡éƒ½å†™å…¥ç›¸åŒçš„æ•°æ®å°±æ²¡æœ‰æ„ä¹‰ï¼Œåº”åœ¨åº”ç”¨å±‚åŠ ä»¥åˆ¤æ–­ã€‚å†™å…¥æ¬¡æ•°çš„å‡å°‘ç›´æ¥é™ä½äº†å†²çªå‡ ç‡ã€‚</li>
<li>åŠæ—¶åˆ·æ–°è¯»å–ï¼šå¦‚æœä¸šåŠ¡æµç¨‹å¿…é¡»åœ¨å†™å…¥åç«‹åˆ»è¯»å–å†å†™å…¥ï¼Œé‚£ä¹ˆåº”è¯¥åœ¨å†™å…¥åä½¿ç”¨ refresh=wait_for æˆ–åŠæ—¶åˆ·æ–°ç´¢å¼•ï¼Œä¿è¯è¯»åˆ°æœ€æ–°æ•°æ®ã€‚æˆ–è€…å¹²è„†ä½¿ç”¨å®æ—¶ GET è·å–æ–‡æ¡£ä»¥è·å–æœ€æ–°ç‰ˆæœ¬ã€‚æ€»ä¹‹ï¼Œä¿è¯â€œè¯»-&gt;æ”¹-&gt;å†™â€æ¨¡å¼ä¸‹è¯»åˆ°çš„æ˜¯æ–°é²œæ•°æ®ã€‚</li>
</ul>
<p>é€šè¿‡è¿™äº›è®¾è®¡ä¸Šçš„æ”¹è¿›ï¼Œå¾ˆå¤šç‰ˆæœ¬å†²çªæ˜¯å¯ä»¥é¿å…çš„ã€‚ä¾‹å¦‚ï¼Œæœ‰ç»éªŒçš„å¼€å‘è€…å¸¸å¸¸ä¼šæŠŠé¢‘ç¹çš„å°æ”¹åŠ¨ç´¯ç§¯æˆè¾ƒå°‘çš„å¤§æ›´æ–°ï¼Œæˆ–è€…å¹²è„†é‡‡ç”¨å¢é‡æ›´æ–°ï¼ˆå¦‚åªæ›´æ–°å˜åŒ–çš„å­—æ®µï¼Œè€Œä¸æ˜¯æ•´æ¡æ–‡æ¡£ï¼‰æ¥é™ä½å†²çªé¢ã€‚</p>
<h3>4. å¼•å…¥å¤–éƒ¨ç‰ˆæœ¬å·æ§åˆ¶</h3>
<p>Elasticsearch æœ¬èº«å…è®¸é€šè¿‡å¤–éƒ¨ç‰ˆæœ¬å·æ¥æ§åˆ¶æ–‡æ¡£çš„ç‰ˆæœ¬ï¼Œè¿™å¯¹äºéœ€è¦å°†ESä¸å…¶ä»–æ•°æ®æºä¿æŒä¸¥æ ¼åŒæ­¥çš„åœºæ™¯å¾ˆæœ‰ç”¨ã€‚æ‰€è°“å¤–éƒ¨ç‰ˆæœ¬ï¼Œå³ç”±åº”ç”¨æˆ–å¤–éƒ¨æ•°æ®åº“ç»´æŠ¤ç‰ˆæœ¬å·ï¼Œå¹¶åœ¨æ¯æ¬¡å†™å…¥ESæ—¶æºå¸¦è¿™ä¸ªç‰ˆæœ¬å·ã€‚</p>
<p>ä½¿ç”¨å¤–éƒ¨ç‰ˆæœ¬æ§åˆ¶éœ€è¦åœ¨è¯·æ±‚ä¸­è®¾ç½® version å’Œ version_type=externalã€‚ESä¼šæ¯”è¾ƒæä¾›çš„ç‰ˆæœ¬å·ä¸å½“å‰æ–‡æ¡£çš„ç‰ˆæœ¬å·ï¼š</p>
<ul>
<li>å¦‚æœæä¾›çš„ç‰ˆæœ¬å· å¤§äº å½“å‰ESä¸­æ–‡æ¡£çš„ç‰ˆæœ¬ï¼Œåˆ™è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªæ›´æ–°ï¼ŒESä¼šæ¥å—è¯¥æ“ä½œå¹¶å°†æ–‡æ¡£ç‰ˆæœ¬è®¾ç½®ä¸ºè¿™ä¸ªæ–°çš„å¤–éƒ¨ç‰ˆæœ¬å·ï¼›</li>
<li>å¦‚æœæä¾›çš„ç‰ˆæœ¬å· å°äºæˆ–ç­‰äº å½“å‰ç‰ˆæœ¬ï¼Œåˆ™ä¼šè¢«åˆ¤å®šä¸ºè¿‡æœŸæ›´æ–°ï¼Œå› è€Œè¿”å›ç‰ˆæœ¬å†²çªï¼Œæ‹’ç»å†™å…¥ã€‚</li>
</ul>
<p>é€šè¿‡è¿™ç§æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿ ES ä¸­çš„æ•°æ®ä¸ä¼šè¢«è¿‡æœŸçš„æ•°æ®æºæ›´æ–°ã€‚ä¾‹å¦‚ï¼ŒæŸæ¡è®°å½•åœ¨æ•°æ®åº“ä¸­çš„ç‰ˆæœ¬æ˜¯10ï¼Œé‚£ä¹ˆä»»ä½•è¯•å›¾ç”¨ç‰ˆæœ¬9æˆ–æ›´ä½çš„æ•°æ®å»æ›´æ–°ESéƒ½ä¼šå¤±è´¥ï¼Œä»è€Œä¿è¯ESä¸è¢«è€æ•°æ®è¦†ç›–ã€‚</p>
<p>å¼•å…¥å¤–éƒ¨ç‰ˆæœ¬éœ€è¦æ³¨æ„ï¼š</p>
<ul>
<li>å•ä¸€æ¥æºï¼šåŠ¡å¿…ä¿è¯ç‰ˆæœ¬å·ç”±å”¯ä¸€çš„æƒå¨æ¥æºç»´æŠ¤ï¼Œé€šå¸¸æ˜¯ä¸»æ•°æ®åº“æˆ–æ¶ˆæ¯åºåˆ—ã€‚ä¸èƒ½è®©å¤šä¸ªåˆ†æ•£çš„æœåŠ¡å„è‡ªå®šä¹‰ç‰ˆæœ¬ï¼Œå¦åˆ™å®¹æ˜“å‡ºç°æ··ä¹±ã€‚</li>
<li>ä¸¥æ ¼é€’å¢ï¼šç‰ˆæœ¬å·å¿…é¡»ä¸¥æ ¼é€’å¢æˆ–é€’å¢ï¼ˆexternal_gteæ¨¡å¼å…è®¸ç­‰äºçš„æƒ…å†µï¼Œä½†ä¸€èˆ¬ç”¨ä¸åˆ°ï¼‰ã€‚å“ªæ€•æ˜¯ç›¸åŒçš„æ•°æ®é‡å¤å†™å…¥ï¼Œä¹Ÿåº”è¯¥å¸¦æ›´é«˜çš„ç‰ˆæœ¬å·ï¼Œå¦åˆ™ESä¼šå°†å…¶è§†ä¸ºå†²çªã€‚</li>
<li>æ€§èƒ½å½±å“ï¼šä½¿ç”¨å¤–éƒ¨ç‰ˆæœ¬æ„å‘³ç€æ¯æ¬¡å†™å…¥éƒ½ç»•è¿‡äº†ESå†…éƒ¨çš„è‡ªåŠ¨ç‰ˆæœ¬é€’å¢é€»è¾‘ï¼Œè€Œç”¨ä½ æä¾›çš„æ•°å­—æ›¿ä»£ã€‚è¿™æœ¬èº«ä¸ä¼šå¸¦æ¥æ˜æ˜¾æ€§èƒ½æŸè€—ï¼Œä½†å¦‚æœä½ çš„ç‰ˆæœ¬åˆ†é…ä¸å½“ï¼ˆæ¯”å¦‚éå¸¸å¤§æˆ–è€…ç»å¸¸å‡ºç°å†²çªï¼‰ï¼Œä¾ç„¶ä¼šå¼•å‘å¤§é‡å¼‚å¸¸å¤„ç†ã€‚</li>
</ul>
<p>å¤–éƒ¨ç‰ˆæœ¬æ§åˆ¶åœ¨éœ€è¦å’Œå¤–éƒ¨ç³»ç»Ÿä¸¥æ ¼åŒæ­¥çš„åœºæ™¯ä¸‹éå¸¸æœ‰ç”¨ï¼Œæ¯”å¦‚åŒå†™æ•°æ®åº“å’ŒESæ—¶ä»¥æ•°æ®åº“çš„ç‰ˆæœ¬ä¸ºå‡†ã€‚ä¸è¿‡å¯¹äºå¤§éƒ¨åˆ†æ™®é€šåº”ç”¨åœºæ™¯ï¼Œå¹¶ä¸éœ€è¦è‡ªè¡Œç®¡ç†ç‰ˆæœ¬ï¼Œè€Œæ˜¯äº¤ç»™ESå†…éƒ¨çš„ä¹è§‚é”æœºåˆ¶å³å¯ã€‚</p>
<h2>å®æˆ˜ç»éªŒä¸é¿å‘æç¤º</h2>
<p>ç»¼åˆä»¥ä¸Šæ–¹æ³•ï¼Œåœ¨å®è·µä¸­è¿˜æœ‰ä¸€äº›ç»éªŒæ•™è®­å€¼å¾—åˆ†äº«ï¼Œé¿å…æ‰å…¥ç‰ˆæœ¬å†²çªå¤„ç†çš„é™·é˜±ï¼š</p>
<ul>
<li>ä¸è¦è¿‡åº¦ä¾èµ–å¤§é‡é‡è¯•ï¼šé‡è¯•æœºåˆ¶å¯ä»¥ç¼“è§£å¶å‘çš„å†²çªï¼Œä½†å¦‚æœå†²çªé¢‘ç¹å‘ç”Ÿï¼Œç›²ç›®æé«˜é‡è¯•æ¬¡æ•°å¹¶ä¸æ˜¯è‰¯ç­–ã€‚æ— é™æˆ–è¿‡å¤šçš„é‡è¯•ä¸ä»…å¢åŠ ç³»ç»Ÿè´Ÿæ‹…ï¼Œè¿˜å¯èƒ½æ©ç›–çœŸæ­£çš„è®¾è®¡é—®é¢˜ã€‚ä¸€èˆ¬è®¾ç½®å‡ æ¬¡é‡è¯•è¶³çŸ£ï¼Œè‹¥è¶…å‡ºä»å¤±è´¥ï¼Œåº”ä»æµç¨‹ä¸Šå¯»æ‰¾åŸå› ã€‚</li>
<li>å†²çªé¢‘å‘éœ€å®¡è§†æ•°æ®æ¨¡å‹ï¼šå¦‚æœæŸç±»æ–‡æ¡£ç»å¸¸å‘ç”Ÿå†²çªï¼Œé«˜æ¦‚ç‡æ˜¯æ•°æ®æ¨¡å‹æˆ–ä¸šåŠ¡æµç¨‹å­˜åœ¨çƒ­ç‚¹æ›´æ–°ã€‚ä¾‹å¦‚ï¼Œå¤šäººé¢‘ç¹ä¿®æ”¹åŒä¸€è®°å½•ã€‚è¿™æ—¶åº”è€ƒè™‘æ˜¯å¦å¯ä»¥ä¼˜åŒ–ï¼Œä¾‹å¦‚å‰é¢æåˆ°çš„æ‹†åˆ†æ–‡æ¡£æˆ–å¼•å…¥é˜Ÿåˆ—ä¸²è¡ŒåŒ–ï¼Œä»¥ä»æºå¤´ä¸Šé™ä½å†²çªå‘ç”Ÿç‡ã€‚</li>
<li>è„šæœ¬æ›´æ–°è¦ç¡®ä¿å¹‚ç­‰ï¼šä½¿ç”¨ Painless è„šæœ¬ç­‰è¿›è¡Œæ›´æ–°æ—¶ï¼Œè€ƒè™‘åˆ°å¯èƒ½å› ä¸ºå†²çªè¢«æ‰§è¡Œå¤šæ¬¡ï¼Œè„šæœ¬é€»è¾‘åº”å°½é‡è®¾è®¡ä¸ºå¹‚ç­‰æˆ–å¯é‡å¤æ‰§è¡Œè€Œä¸äº§ç”Ÿå‰¯ä½œç”¨ã€‚ä¾‹å¦‚ï¼Œé¿å…ç®€å•åœ°ç´¯åŠ å¸¸æ•°ï¼ˆå¤šæ¬¡é‡è¯•ä¼šå¤šåŠ ï¼‰ï¼Œè€Œåº”æ ¹æ®æ¡ä»¶è®¾ç½®å€¼æˆ–è€…ä½¿ç”¨å¾ªç¯å¤–æä¾›çš„å·®å€¼ã€‚</li>
<li>æ³¨æ„ _seq_no å’Œ _primary_termï¼šåœ¨æœ€æ–°ç‰ˆçš„ESä¸­ï¼Œæ¨èä½¿ç”¨ _seq_no å’Œ _primary_term æ¥è¿›è¡Œå¹¶å‘æ§åˆ¶ï¼ˆåœ¨REST APIä¸­é€šè¿‡ if_seq_no å’Œ if_primary_term å‚æ•°ï¼‰ã€‚å¦‚æœä½ æ‰‹åŠ¨å®ç°ä¹è§‚é”æ›´æ–°ï¼Œä¸€å®šä½¿ç”¨ä»æœ€æ–°è·å–çš„è¿™ä¸¤ä¸ªå€¼ï¼Œå¦åˆ™ä¹Ÿä¼šæŠ¥å†²çªå¼‚å¸¸ã€‚åˆ‡å‹¿ä»ä½¿ç”¨æ—§ç‰ˆçš„ ?version å‚æ•°è¿›è¡Œæ§åˆ¶ï¼Œå› ä¸ºç°åœ¨ESä¼šç›´æ¥æ‹’ç»è¿™ç§ç”¨æ³•ã€‚</li>
<li>ä½¿ç”¨å®æ—¶è¯»å†™æ¥å£ï¼šå°½é‡ä½¿ç”¨å®æ—¶çš„ _doc GET æ¥å£è¯»å–éœ€è¦æ›´æ–°çš„æ–‡æ¡£ï¼Œè€Œä¸æ˜¯é€šè¿‡æœç´¢æŸ¥è¯¢å†æ›´æ–°ã€‚å› ä¸ºæœç´¢ç»“æœå¯èƒ½ä¸æ˜¯å®æ—¶æœ€æ–°çš„ï¼Œå°¤å…¶åœ¨ç´¢å¼•å°šæœªåˆ·æ–°æ—¶ã€‚è¿™ä¸€ç‚¹åœ¨éœ€è¦è¿ç»­è¯»å†™çš„æµç¨‹ä¸­å¾ˆé‡è¦ï¼Œå¯ä»¥é¿å…æ‹¿åˆ°è¿‡æœŸæ•°æ®å¯¼è‡´å†²çªã€‚</li>
<li>å¤–éƒ¨ç‰ˆæœ¬ç®¡ç†çš„çº¦æŸï¼šæ­£å¦‚ä¸Šæ–‡æ‰€è¿°ï¼Œåªæœ‰åœ¨éå¸¸æ˜ç¡®çš„æƒ…å†µä¸‹æ‰ä½¿ç”¨å¤–éƒ¨ç‰ˆæœ¬æ§åˆ¶ã€‚å¹¶ä¸”ä¸€æ—¦ä½¿ç”¨ï¼Œå°±ç›¸å½“äºå®Œå…¨ç”±å¤–éƒ¨ä¿è¯ç‰ˆæœ¬æ­£ç¡®æ€§â€”â€”è¿™å¯¹ç³»ç»Ÿè®¾è®¡æå‡ºäº†æ›´é«˜è¦æ±‚ã€‚å¦‚æœåšä¸åˆ°ä¸¥æ ¼æœ‰åºï¼Œé‚£å®å¯ä¸è¦ç”¨ï¼Œå¦åˆ™è¿˜ä¸å¦‚ç”¨ESé»˜è®¤æœºåˆ¶å¹¶å¤„ç†å†²çªæ¥å¾—å®‰å…¨ã€‚</li>
</ul>
<h2>æ€»ç»“</h2>
<p>Elasticsearch çš„ç‰ˆæœ¬å†²çªæœ¬è´¨ä¸Šæ˜¯å…¶ä¹è§‚å¹¶å‘æ§åˆ¶åœ¨å‘æŒ¥ä½œç”¨ï¼Œä¿éšœæ•°æ®ä¸è¢«ä¹±åºè¦†ç›–çš„ä¸€ç§ä¿æŠ¤æœºåˆ¶ã€‚å¯¹äºå¼€å‘è€…æ¥è¯´ï¼Œç‰ˆæœ¬å†²çªé”™è¯¯æ—¢æ˜¯ä¸€ç§æŒ‘æˆ˜ï¼Œä¹Ÿæ˜¯çº¿ç´¢ï¼šå®ƒæé†’æˆ‘ä»¬ç³»ç»Ÿä¸­å­˜åœ¨å¹¶å‘å†™å…¥çš„ç«äº‰ã€‚</p>
<p>é€šè¿‡æ·±å…¥ç†è§£ Elasticsearch çš„ç‰ˆæœ¬æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è®¾è®¡é˜¶æ®µå°±å‡å°‘å†²çªçš„å¯èƒ½ï¼›åœ¨å®ç°é˜¶æ®µå–„ç”¨ retry_on_conflict ç­‰å·¥å…·è‡ªåŠ¨è§£å†³å°æ¦‚ç‡å†²çªï¼›åœ¨å†²çªä»å‘ç”Ÿæ—¶ï¼Œé€šè¿‡æ—¥å¿—æ’æŸ¥å’Œåˆç†çš„é‡è¯•ç­–ç•¥æ¥ç¡®ä¿æ•°æ®æœ€ç»ˆä¸€è‡´ã€‚</p>
<p>æ²¡æœ‰é“¶å¼¹å¯ä»¥å½»åº•æœç»ç‰ˆæœ¬å†²çªï¼Œæˆ‘ä»¬èƒ½åšçš„æ˜¯å°½é‡å‡å°‘å…¶å‘ç”Ÿå¹¶å¹³ç¨³åº”å¯¹ã€‚å¸Œæœ›æœ¬æ–‡è®¨è®ºçš„åŸç†è§£æå’Œå®æˆ˜ç­–ç•¥ï¼Œèƒ½å¸®åŠ©ä½ åœ¨é¢å¯¹ Elasticsearch é«˜å¹¶å‘æ›´æ–°æ—¶æ¸¸åˆƒæœ‰ä½™ï¼Œæ—¢ä¿éšœæ•°æ®ä¸€è‡´æ€§ï¼Œåˆå…¼é¡¾ç³»ç»Ÿæ€§èƒ½ã€‚</p>

    </article>
    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/prismjs@1/prism.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1/components/prism-python.min.js"></script>
<script>
Prism.highlightAll();
document.querySelectorAll('article pre').forEach(pre => {
    const code = pre.querySelector('code');
    if (!code) return;
    const toolbar = document.createElement('div');
    toolbar.className = 'code-toolbar';
    const btn = document.createElement('button');
    btn.className = 'copy-btn';
    btn.textContent = 'Copy';
    btn.onclick = () => {
        navigator.clipboard.writeText(code.textContent).then(() => {
            btn.textContent = 'Copied!';
            btn.classList.add('copied');
            setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 2000);
        });
    };
    toolbar.appendChild(btn);
    pre.parentNode.insertBefore(toolbar, pre);
});
</script>
</body>
</html>