<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>从 404 到 200：记一次 Astro + GitHub Pages 样式丢失问题的深度排查</title>
    <style>
        body { font-family: Georgia, serif; max-width: 700px; margin: 2rem auto; padding: 0 1rem; line-height: 1.7; color: #333; }
        h1 { font-size: 2rem; margin-bottom: 0.5rem; }
        h2 { font-size: 1.4rem; margin-top: 2rem; }
        pre { background: #f4f4f4; padding: 1rem; overflow-x: auto; border-radius: 4px; }
        code { font-family: Menlo, Monaco, monospace; font-size: 0.9em; }
        p code { background: #f4f4f4; padding: 0.2em 0.4em; border-radius: 3px; }
        img { max-width: 100%; }
        blockquote { border-left: 3px solid #ddd; margin-left: 0; padding-left: 1rem; color: #666; }
        ul { padding-left: 1.5rem; }
        hr { border: none; border-top: 1px solid #ddd; margin: 2rem 0; }
        a { color: #1a8917; }
    </style>
</head>
<body>
<hr>
<h2>date: 2024-01-01
tags: [devops]
legacy: true</h2>
<h1>从 404 到 200：记一次 Astro + GitHub Pages 样式丢失问题的深度排查</h1>
<p>这些 CSS 文件的路径看起来像这样：</p>
<p><code>https://geyuxu.com/_astro/_slug_.BvCO7WHQ.css</code></p><p>问题很明确：服务器无法找到 Astro 构建出来的 CSS 文件。但为什么呢？</p>
<h2>二、漫漫排查路：错误的假设</h2>
<p>我的排查过程遵循了典型的从易到难、从普遍到特殊的思路，但也因此走了一些弯路。</p>
<h3>假设 1：Jekyll 捣乱？</h3>
<p>GitHub Pages 默认使用 Jekyll 来构建网站。Jekyll 有一个众所周知的约定：它会忽略所有以下划线 (<code>_</code>) 开头的目录和文件，因为它们被认为是特殊的，比如 <code>_posts</code>、<code>_includes</code> 等。</p>
<p>Astro 构建产物中的 CSS 目录恰好是 <code>_astro</code>。这看起来就是罪魁祸首！</p>
<p><strong>解决方案尝试</strong>：在仓库的根目录添加一个空的 <code>.nojekyll</code> 文件。这个文件的作用是告诉 GitHub Pages：&quot;请不要用 Jekyll 处理我的网站，我这是一个纯静态站点。&quot;</p>
<p><strong>结果</strong>：清理缓存，重新部署，问题依旧。<code>_astro</code> 目录下的 CSS 文件仍然是 404。</p>
<p>这个结果让我很困惑。<code>.nojekyll</code> 应该已经禁用了 Jekyll，为什么以下划线开头的资源还是无法访问？</p>
<h3>假设 2：目录访问问题？</h3>
<p>我开始怀疑是不是 <code>_astro</code> 目录本身因为某些服务器配置而无法被直接访问。或许它缺少一个 <code>index.html</code> 文件？</p>
<p><strong>解决方案尝试</strong>：在 <code>dist/_astro/</code> 目录下手动创建一个空的 <code>index.html</code> 文件，然后重新部署。</p>
<p><strong>结果</strong>：毫无悬念，失败了。这本就是一个不切实际的猜测，因为我们是请求具体的文件，而不是访问目录。</p>
<h2>三、柳暗花明：定位真正原因</h2>
<p>在排除了最常见的 Jekyll 问题后，我开始重新审视那个神秘的 404。<code>.nojekyll</code> 文件确实禁用了 Jekyll 的构建过程，但它并不能覆盖 GitHub Pages 服务器的所有规则。</p>
<p>经过一番搜索和验证，我终于发现了问题的关键：</p>
<blockquote>
<p><strong>GitHub Pages (或其底层的 Web 服务器) 有一条更深层的规则：它会阻止所有对以下划线 (<code>_</code>) 开头的文件的直接访问，这似乎是一个安全或约定策略，独立于 Jekyll 的行为。</strong></p>
</blockquote>
<p>Astro 生成的 CSS 文件名，例如 <code>_slug_.BvCO7WHQ.css</code>，恰好也以下划线开头！这才是 <code>.nojekyll</code> 文件无效的根本原因。我们不仅要处理 <code>_astro</code> 目录，还要处理文件名本身。</p>
<h2>四、终极解决方案：自定义 Astro 构建产物命名</h2>
<p>既然无法改变 GitHub Pages 的规则，那我们就只能改变我们自己的产物。我们需要让 Astro 在构建时，不要生成以下划线开头的文件名。</p>
<p>幸运的是，Astro 底层使用 Vite 作为其构建工具，并向我们开放了 Vite 的配置接口。我们可以通过修改 <code>astro.config.mjs</code> 文件来定制构建行为。</p>
<h3>配置方案</h3>
<p>具体的配置项是 <code>vite.build.rollupOptions.output.assetFileNames</code>。它可以让我们完全控制资源文件（如 CSS、图片等）的输出路径和名称。</p>
<p>打开项目根目录下的 <code>astro.config.mjs</code> 文件，添加 <code>vite</code> 配置项：</p>
<blockquote><code>// astro.config.mjs</code><br>
<code>import { defineConfig } from &#039;astro/config&#039;;</code><br>
<code></code><br>
<code>export default defineConfig({</code><br>
<code>  site: &#039;https://geyuxu.com&#039;,</code><br>
<code>  // ... 其他配置</code><br>
<code>  vite: {</code><br>
<code>    build: {</code><br>
<code># ... (17 more lines)</code></blockquote>
<p><em>View full code: <a href="https://gist.github.com/geyuxu/1d8521ca03525174b03656199edefafa">GitHub Gist</a></em></p><h3>代码解释</h3>
<ul>
<li><code>assetFileNames</code> 接受一个函数，该函数为每个资源文件调用</li>
<li><code>assetInfo.name</code> 包含了 Vite 建议的原始文件名，例如 <code>_slug_.BvCO7WHQ.css</code></li>
<li>我们检查 <code>assetInfo.name</code> 是否以 <code>_</code> 开头</li>
<li>如果是，我们使用 <code>replace(/^_/, &#39;assets-&#39;)</code> 将开头的下划线替换为 <code>assets-</code></li>
<li>最终生成的文件名变成了 <code>assets-slug_.BvCO7WHQ.css</code></li>
</ul>
<h3>验证结果</h3>
<p>在应用了以上配置后，重新运行 <code>npm run build</code>，然后将 <code>dist</code> 目录部署到 GitHub Pages：</p>
<blockquote><code>npm run build</code><br>
<code>npm run deploy</code></blockquote><p><strong>结果</strong>：成功！CSS 文件现在以 <code>assets-slug_.BvCO7WHQ.css</code> 这样的路径加载，HTTP 状态码从 404 变成了 200。网站样式完美呈现。</p>
<p>我们可以通过以下命令验证：</p>
<p><code>curl -I https://geyuxu.com/_astro/assets-slug_.BvCO7WHQ.css</code></p><p>返回：</p>
<blockquote><code>HTTP/2 200 </code><br>
<code>content-type: text/css; charset=utf-8</code></blockquote><h2>五、总结与反思</h2>
<p>这次调试经历虽然曲折，但收获颇丰：</p>
<h3>关键经验</h3>
<ol>
<li><p><strong>深入理解平台限制</strong>：不能想当然地认为 <code>.nojekyll</code> 能解决所有问题。需要了解托管平台（GitHub Pages）自身的底层规则，而不仅仅是其表面工具（Jekyll）的规则。</p>
</li>
<li><p><strong>从根源解决问题</strong>：与其尝试用各种&quot;补丁&quot;去适应部署环境，不如直接控制构建过程，生成符合环境要求的产物。这是一种更干净、更可维护的解决方案。</p>
</li>
<li><p><strong>善用工具的配置能力</strong>：现代前端框架（如 Astro）和构建工具（如 Vite）通常都提供了强大的配置选项。深入阅读文档、了解这些配置项，是解决复杂问题的金钥匙。</p>
</li>
<li><p><strong>下划线是特殊字符</strong>：在 Web 开发中，以下划线开头的文件/目录通常有特殊含义（如 Jekyll, Node.js 的私有模块等）。在命名和部署时要特别留意，避免与平台规则冲突。</p>
</li>
</ol>
<h3>Debug 技巧</h3>
<ul>
<li><strong>系统性排查</strong>：从最常见的原因开始，逐步深入</li>
<li><strong>验证假设</strong>：每个解决方案都要实际测试，不能想当然</li>
<li><strong>关注细节</strong>：文件名、路径、HTTP 状态码等细节往往包含关键信息</li>
<li><strong>查阅文档</strong>：当常见解决方案失效时，深入研究工具的配置选项</li>
</ul>
<h3>适用场景</h3>
<p>这个解决方案适用于所有遇到类似问题的 Astro + GitHub Pages 部署场景，也可以扩展到其他使用 Vite 构建工具的框架（如 Vue、React 等）在 GitHub Pages 上的部署问题。</p>
<p>希望我的经验能为你节省一些调试时间。Happy coding!</p>

</body>
</html>