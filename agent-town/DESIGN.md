# Agent Town è®¾è®¡æ–¹æ¡ˆ

> 8ä¸ªAIè™šæ‹Ÿäººå±…ä½çš„åƒç´ å°é•‡ï¼Œå®ƒä»¬ä¼šé˜…è¯»ä½ çš„åšå®¢å¹¶å‘è¡¨è¯„è®º

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 æ ¸å¿ƒæ¦‚å¿µ
- ä¸€ä¸ªæ—¥å¼RPGé£æ ¼çš„åƒç´ å°é•‡
- 8ä¸ªå…·æœ‰ä¸åŒæ€§æ ¼çš„AIå±…æ°‘
- å±…æ°‘ä¼šè‡ªä¸»æ´»åŠ¨ï¼ˆèµ°è·¯ã€æ€è€ƒã€èŠå¤©ï¼‰
- å±…æ°‘ä¼šé˜…è¯»åšå®¢æ–‡ç« å¹¶æ ¹æ®æ€§æ ¼å‘è¡¨è¯„è®º
- å¯åµŒå…¥åšå®¢é¡µé¢å±•ç¤º

### 1.2 æŠ€æœ¯é€‰å‹

| ç»„ä»¶ | æŠ€æœ¯ | ç†ç”± |
|------|------|------|
| å‰ç«¯æ¸²æŸ“ | Canvas 2D | åŸç”Ÿã€æ— ä¾èµ–ã€æ€§èƒ½è¶³å¤Ÿ |
| å‰ç«¯æ¡†æ¶ | Vanilla JS | ä¸åšå®¢é£æ ¼ç»Ÿä¸€ |
| åç«¯æœåŠ¡ | Cloudflare Worker | ä½ ç†Ÿæ‚‰ã€æˆæœ¬ä½ |
| çŠ¶æ€å­˜å‚¨ | Cloudflare KV | ç®€å•ã€ä¸Workeré›†æˆå¥½ |
| AIç”Ÿæˆ | OpenAI API | ç”Ÿæˆè¯„è®º |
| ç´ æé£æ ¼ | 16x16/32x32 åƒç´  | SFC/GBAæ—¶ä»£æ—¥å¼RPGé£æ ¼ |

---

## 2. ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·æµè§ˆå™¨                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    å‰ç«¯ (çº¯é™æ€)                            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚  æ¸¸æˆå¼•æ“    â”‚  â”‚  æ¸²æŸ“å¼•æ“    â”‚  â”‚  çŠ¶æ€åŒæ­¥æ¨¡å—    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ - æœ¬åœ°æ¨¡æ‹Ÿ   â”‚  â”‚ - åœ°å›¾æ¸²æŸ“   â”‚  â”‚ - è½®è¯¢æœåŠ¡å™¨    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ - Agent AI  â”‚  â”‚ - è§’è‰²åŠ¨ç”»   â”‚  â”‚ - åˆå¹¶çŠ¶æ€      â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ - è·¯å¾„å¯»æ‰¾   â”‚  â”‚ - UI/æ°”æ³¡    â”‚  â”‚ - äº‹ä»¶å¤„ç†      â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    æ¯30ç§’è½®è¯¢ GET /api/state
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Cloudflare Edge                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    Worker API                              â”‚  â”‚
â”‚  â”‚  GET  /api/state     â†’ è¿”å›æœ€æ–°è¯„è®ºå’Œäº‹ä»¶                    â”‚  â”‚
â”‚  â”‚  GET  /api/comments  â†’ è¿”å›æ‰€æœ‰è¯„è®º                         â”‚  â”‚
â”‚  â”‚  POST /api/trigger   â†’ æ‰‹åŠ¨è§¦å‘Agenté˜…è¯»(å¯é€‰)               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    Worker Cron                             â”‚  â”‚
â”‚  â”‚  æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡:                                           â”‚  â”‚
â”‚  â”‚  1. éšæœºé€‰æ‹©1ä¸ªAgent                                        â”‚  â”‚
â”‚  â”‚  2. éšæœºé€‰æ‹©1ç¯‡åšå®¢æ–‡ç«                                       â”‚  â”‚
â”‚  â”‚  3. è°ƒç”¨OpenAIç”Ÿæˆè¯„è®º                                      â”‚  â”‚
â”‚  â”‚  4. å­˜å…¥KV                                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    Cloudflare KV                           â”‚  â”‚
â”‚  â”‚  agent_town:comments  â†’ [{agent, post, text, time}, ...]   â”‚  â”‚
â”‚  â”‚  agent_town:events    â†’ [{type, agent, data, time}, ...]   â”‚  â”‚
â”‚  â”‚  agent_town:stats     â†’ {totalComments, postsRead, ...}    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       OpenAI API                                â”‚
â”‚                    ç”ŸæˆAgentè¯„è®ºå†…å®¹                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. å‰ç«¯è¯¦ç»†è®¾è®¡

### 3.1 ç›®å½•ç»“æ„
```
agent-town/
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ index.html              # ä¸»é¡µé¢
â”‚   â”œâ”€â”€ style.css               # æ ·å¼
â”‚   â”œâ”€â”€ js/
â”‚   â”‚   â”œâ”€â”€ main.js             # å…¥å£
â”‚   â”‚   â”œâ”€â”€ engine/
â”‚   â”‚   â”‚   â”œâ”€â”€ game.js         # æ¸¸æˆä¸»å¾ªç¯
â”‚   â”‚   â”‚   â”œâ”€â”€ world.js        # ä¸–ç•Œ/åœ°å›¾ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ agent.js        # Agentç±»(å‰ç«¯ç‰ˆ)
â”‚   â”‚   â”‚   â””â”€â”€ pathfinding.js  # ç®€å•è·¯å¾„å¯»æ‰¾(A*)
â”‚   â”‚   â”œâ”€â”€ render/
â”‚   â”‚   â”‚   â”œâ”€â”€ renderer.js     # ä¸»æ¸²æŸ“å™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ tilemap.js      # ç“¦ç‰‡åœ°å›¾æ¸²æŸ“
â”‚   â”‚   â”‚   â”œâ”€â”€ sprite.js       # ç²¾çµåŠ¨ç”»
â”‚   â”‚   â”‚   â””â”€â”€ ui.js           # UIå±‚(æ°”æ³¡/é¢æ¿)
â”‚   â”‚   â””â”€â”€ sync/
â”‚   â”‚       â””â”€â”€ client.js       # ä¸æœåŠ¡å™¨åŒæ­¥
â”‚   â””â”€â”€ assets/
â”‚       â”œâ”€â”€ tiles/              # åœ°å›¾ç“¦ç‰‡
â”‚       â”œâ”€â”€ characters/         # è§’è‰²ç²¾çµ
â”‚       â”œâ”€â”€ buildings/          # å»ºç­‘ç‰©
â”‚       â””â”€â”€ ui/                 # UIå…ƒç´ 
â”œâ”€â”€ backend/
â”‚   â””â”€â”€ worker.js               # Cloudflare Worker
â””â”€â”€ data/
    â”œâ”€â”€ map.json                # åœ°å›¾æ•°æ®
    â””â”€â”€ agents.json             # Agenté…ç½®
```

### 3.2 æ¸¸æˆå¼•æ“è®¾è®¡

```javascript
// ä¸»å¾ªç¯ (60 FPS)
class Game {
  constructor(canvas) {
    this.canvas = canvas;
    this.ctx = canvas.getContext('2d');
    this.world = new World(MAP_DATA);
    this.agents = AGENT_CONFIGS.map(c => new Agent(c, this.world));
    this.renderer = new Renderer(this.ctx);
    this.syncClient = new SyncClient(API_URL);
    this.lastSync = 0;
  }

  update(deltaTime) {
    // 1. æ›´æ–°æ‰€æœ‰Agent(æœ¬åœ°æ¨¡æ‹Ÿ)
    this.agents.forEach(agent => agent.update(deltaTime));

    // 2. å®šæœŸåŒæ­¥æœåŠ¡å™¨çŠ¶æ€
    if (Date.now() - this.lastSync > 30000) {
      this.syncClient.fetchState().then(state => {
        this.mergeServerState(state);
      });
      this.lastSync = Date.now();
    }
  }

  render() {
    this.renderer.clear();
    this.renderer.drawMap(this.world);
    this.renderer.drawAgents(this.agents);
    this.renderer.drawUI(this.agents, this.comments);
  }

  loop(timestamp) {
    const delta = timestamp - this.lastTime;
    this.update(delta);
    this.render();
    this.lastTime = timestamp;
    requestAnimationFrame(t => this.loop(t));
  }
}
```

### 3.3 Agent æœ¬åœ°è¡Œä¸ºæ¨¡æ‹Ÿ

```javascript
class Agent {
  constructor(config, world) {
    this.id = config.id;
    this.name = config.name;
    this.personality = config.personality;
    this.avatar = config.avatar;
    this.color = config.color;

    // ä½ç½® (åƒç´ )
    this.x = config.startX;
    this.y = config.startY;

    // çŠ¶æ€æœº
    this.state = 'idle';  // idle, walking, reading, thinking, chatting
    this.stateTimer = 0;

    // ç§»åŠ¨
    this.path = [];
    this.speed = 60; // pixels per second

    // åŠ¨ç”»
    this.direction = 'down';
    this.animFrame = 0;
    this.animTimer = 0;
  }

  update(deltaTime) {
    this.stateTimer -= deltaTime;

    switch(this.state) {
      case 'idle':
        if (this.stateTimer <= 0) {
          this.decideNextAction();
        }
        break;

      case 'walking':
        this.moveAlongPath(deltaTime);
        this.updateAnimation(deltaTime);
        break;

      case 'reading':
      case 'thinking':
      case 'chatting':
        // æ’­æ”¾å¯¹åº”åŠ¨ç”»ï¼Œç­‰å¾…çŠ¶æ€ç»“æŸ
        if (this.stateTimer <= 0) {
          this.state = 'idle';
          this.stateTimer = 1000 + Math.random() * 2000;
        }
        break;
    }
  }

  decideNextAction() {
    // æ ¹æ®æ€§æ ¼ç‰¹ç‚¹å†³å®šä¸‹ä¸€ä¸ªè¡ŒåŠ¨
    const weights = {
      walk: 0.4,
      goToLibrary: 0.2 * this.personality.curiosity,
      goToCafe: 0.2 * this.personality.depth,
      goToSquare: 0.2 * this.personality.empathy,
      stay: 0.2
    };

    const action = this.weightedRandom(weights);
    this.executeAction(action);
  }

  executeAction(action) {
    switch(action) {
      case 'walk':
        const randomDest = this.world.getRandomWalkablePoint();
        this.walkTo(randomDest);
        break;
      case 'goToLibrary':
        this.walkTo(this.world.getBuilding('library').entrance);
        this.onArrival = () => this.startReading();
        break;
      // ... å…¶ä»–è¡ŒåŠ¨
    }
  }
}
```

### 3.4 åœ°å›¾è®¾è®¡

**å°ºå¯¸**: 20x15 ç“¦ç‰‡ (640x480 åƒç´  @ 32x32ç“¦ç‰‡)

```
åœ°å›¾å¸ƒå±€:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ£®æ—è¾¹ç¼˜                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      ğŸ         â˜•å’–å•¡é¦†      ğŸ          â”‚
â”‚     æ°‘å±…                    æ°‘å±…        â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚ â† ä¸»è¡—é“
â”‚      ğŸ“šå›¾ä¹¦é¦†    â›²å–·æ³‰     ğŸ›ï¸å¹¿åœº     â”‚
â”‚                                        â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚ â† æ¬¡è¡—é“
â”‚      ğŸ¨ç”»å»Š      ğŸŒ³å…¬å›­     â›ªæ•™å ‚     â”‚
â”‚                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ£®æ—è¾¹ç¼˜                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å»ºç­‘ç‰©åŠŸèƒ½**:
| å»ºç­‘ | åŠŸèƒ½ | Agentåœ¨æ­¤çš„è¡Œä¸º |
|------|------|----------------|
| ğŸ“š å›¾ä¹¦é¦† | é˜…è¯»åšå®¢ | è¿›å…¥â†’é˜…è¯»åŠ¨ç”»â†’å¯èƒ½ç”Ÿæˆè¯„è®º |
| â˜• å’–å•¡é¦† | æ€è€ƒ | åä¸‹â†’æ€è€ƒåŠ¨ç”»â†’å†’å‡ºæƒ³æ³•æ°”æ³¡ |
| ğŸ›ï¸ å¹¿åœº | ç¤¾äº¤ | ä¸¤ä¸ªAgentç›¸é‡â†’èŠå¤©åŠ¨ç”» |
| â›² å–·æ³‰ | ä¼‘æ¯ | ç«™ç«‹â†’è§‚çœ‹å–·æ³‰ |
| ğŸŒ³ å…¬å›­ | æ•£æ­¥ | éšæœºæ¼«æ­¥ |
| å…¶ä»– | è£…é¥° | è·¯è¿‡ |

### 3.5 æ¸²æŸ“å±‚çº§

```
Layer 0: åœ°é¢ (è‰åœ°ã€æ°´ã€è·¯é¢)
Layer 1: åœ°é¢è£…é¥° (èŠ±ã€çŸ³å¤´ã€é˜´å½±)
Layer 2: å»ºç­‘ç‰©åº•éƒ¨
Layer 3: Agent (æŒ‰Yåæ ‡æ’åº)
Layer 4: å»ºç­‘ç‰©é¡¶éƒ¨ (å±‹é¡¶è¾¹ç¼˜ï¼Œå®ç°é®æŒ¡)
Layer 5: å¤©æ°”/å…‰ç…§æ•ˆæœ
Layer 6: UI (åå­—ã€æ°”æ³¡ã€é¢æ¿)
```

### 3.6 UIè®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ˜ï¸ Agent Town                        [â¸ï¸] [â©] [ğŸ“‹]    â”‚  â† æ ‡é¢˜æ 
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚                    [æ¸¸æˆç”»é¢åŒºåŸŸ]                        â”‚
â”‚                      640x480                            â”‚
â”‚                                                         â”‚
â”‚     ğŸ§™ â† "è¿™ç¯‡æ–‡ç« è®©æˆ‘æƒ³èµ·äº†æŸæ‹‰å›¾..."                   â”‚  â† è¯„è®ºæ°”æ³¡
â”‚    è‹æ ¼æ‹‰åº•                                             â”‚
â”‚                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“œ æœ€æ–°åŠ¨æ€                                             â”‚  â† æ´»åŠ¨æ—¥å¿—
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ğŸ§™ è‹æ ¼æ‹‰åº• æ­£åœ¨é˜…è¯»ã€Šä¸ºä¸ªäººç½‘ç«™æ„å»ºRAGã€‹            â”‚ â”‚
â”‚ â”‚ ğŸš€ Emma å¯¹ã€ŠCloudflare Workerså®è·µã€‹å‘è¡¨äº†è¯„è®º       â”‚ â”‚
â”‚ â”‚ ğŸ­ Tony åœ¨å’–å•¡é¦†æ€è€ƒäººç”Ÿ                            â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ‘¥ å±…æ°‘ (ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…)                                   â”‚  â† è§’è‰²åˆ—è¡¨
â”‚ [ğŸ§™][ğŸ­][ğŸš€][ğŸŒ™][ğŸ¤”][â˜€ï¸][ğŸ“š][ğŸ”§]                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. åç«¯è¯¦ç»†è®¾è®¡

### 4.1 Cloudflare Worker

```javascript
// worker.js
export default {
  async fetch(request, env) {
    const url = new URL(request.url);

    // CORS
    if (request.method === 'OPTIONS') {
      return handleCORS();
    }

    switch(url.pathname) {
      case '/api/state':
        return getState(env);
      case '/api/comments':
        return getComments(env);
      default:
        return new Response('Not found', { status: 404 });
    }
  },

  // Cronè§¦å‘å™¨ - æ¯5åˆ†é’Ÿæ‰§è¡Œ
  async scheduled(event, env) {
    await generateNewComment(env);
  }
};

async function generateNewComment(env) {
  // 1. è·å–Agentåˆ—è¡¨
  const agents = AGENT_PERSONALITIES;
  const agent = agents[Math.floor(Math.random() * agents.length)];

  // 2. è·å–åšå®¢æ–‡ç« åˆ—è¡¨
  const postsResponse = await fetch('https://yuxu.ge/blog/posts.json');
  const posts = await postsResponse.json();
  const post = posts[Math.floor(Math.random() * posts.length)];

  // 3. è·å–æ–‡ç« å†…å®¹æ‘˜è¦
  const contentResponse = await fetch(`https://yuxu.ge/blog/${post.slug}`);
  const content = await contentResponse.text();
  const summary = content.substring(0, 1000);

  // 4. ç”Ÿæˆè¯„è®º
  const comment = await generateCommentWithOpenAI(agent, post, summary, env);

  // 5. å­˜å…¥KV
  const comments = JSON.parse(await env.KV.get('agent_town:comments') || '[]');
  comments.unshift({
    id: Date.now().toString(),
    agentId: agent.id,
    agentName: agent.name,
    agentAvatar: agent.avatar,
    postSlug: post.slug,
    postTitle: post.title,
    text: comment,
    timestamp: Date.now()
  });

  // ä¿ç•™æœ€è¿‘100æ¡è¯„è®º
  await env.KV.put('agent_town:comments', JSON.stringify(comments.slice(0, 100)));

  // 6. è®°å½•äº‹ä»¶
  await logEvent(env, {
    type: 'new_comment',
    agentId: agent.id,
    postSlug: post.slug,
    timestamp: Date.now()
  });
}

async function generateCommentWithOpenAI(agent, post, summary, env) {
  const response = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${env.OPENAI_API_KEY}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      model: 'gpt-4o-mini',
      messages: [
        {
          role: 'system',
          content: agent.promptPrefix
        },
        {
          role: 'user',
          content: `è¯·é˜…è¯»ä»¥ä¸‹åšå®¢æ–‡ç« å¹¶å‘è¡¨è¯„è®ºï¼š\n\næ ‡é¢˜ï¼š${post.title}\n\nå†…å®¹ï¼š${summary}\n\nè¯·ç”¨50-150å­—å‘è¡¨ä½ çš„çœ‹æ³•ã€‚`
        }
      ],
      max_tokens: 300,
      temperature: 0.8
    })
  });

  const data = await response.json();
  return data.choices[0].message.content;
}
```

### 4.2 KV æ•°æ®ç»“æ„

```javascript
// agent_town:comments
[
  {
    id: "1706000000000",
    agentId: "philosopher",
    agentName: "è‹æ ¼æ‹‰åº• (Socrates)",
    agentAvatar: "ğŸ§™",
    postSlug: "posts/2026/ai-assistant-rag-zh",
    postTitle: "ä¸ºä¸ªäººç½‘ç«™æ„å»ºRAGé©±åŠ¨çš„AIåŠ©æ‰‹",
    text: "è¿™ç¯‡æ–‡ç« è®©æˆ‘æ€è€ƒï¼šå½“æˆ‘ä»¬æ„å»ºèƒ½å¤Ÿ"ç†è§£"çš„ç³»ç»Ÿæ—¶ï¼Œæˆ‘ä»¬æ˜¯å¦åœ¨åˆ›é€ ä¸€ç§æ–°çš„è®¤çŸ¥å½¢å¼ï¼ŸRAGè®©AIèƒ½å¤ŸåŸºäºç‰¹å®šçŸ¥è¯†å›ç­”é—®é¢˜ï¼Œä½†è¿™ä¸çœŸæ­£çš„ç†è§£æœ‰ä½•åŒºåˆ«ï¼Ÿ",
    timestamp: 1706000000000
  },
  // ...
]

// agent_town:events
[
  {
    type: "new_comment",
    agentId: "philosopher",
    data: { postSlug: "..." },
    timestamp: 1706000000000
  },
  {
    type: "reading_started",
    agentId: "enthusiast",
    data: { postTitle: "..." },
    timestamp: 1706000000000
  },
  // ...
]

// agent_town:stats
{
  totalComments: 42,
  postsRead: 38,
  lastActivity: 1706000000000,
  agentStats: {
    "philosopher": { comments: 8, reads: 12 },
    "critic": { comments: 6, reads: 8 },
    // ...
  }
}
```

---

## 5. 8ä¸ªAgentè§’è‰²è®¾è®¡

| ID | åå­— | å¤´åƒ | é¢œè‰² | æ€§æ ¼ç‰¹ç‚¹ | è¯„è®ºé£æ ¼ |
|----|------|------|------|----------|----------|
| philosopher | è‹æ ¼æ‹‰åº• | ğŸ§™ | #8B5CF6 | å¥½å¥‡ã€æ·±åº¦æ€è€ƒ | æå‡ºå“²å­¦é—®é¢˜ï¼Œè¿½é—®æœ¬è´¨ |
| critic | æ¯’èˆŒTony | ğŸ­ | #EF4444 | çŠ€åˆ©ã€å¹½é»˜ | ä¸€é’ˆè§è¡€çš„æ‰¹è¯„ï¼Œä½†æœ‰å»ºè®¾æ€§ |
| enthusiast | æŠ€æœ¯ç‹‚Emma | ğŸš€ | #10B981 | çƒ­æƒ…ã€å¥½å¥‡ | å…´å¥‹è®¨è®ºæŠ€æœ¯ç»†èŠ‚ |
| poet | è¯—äººLuna | ğŸŒ™ | #F59E0B | æ„Ÿæ€§ã€æµªæ¼« | ç”¨è¯—æ„è¯­è¨€è¡¨è¾¾ï¼Œå¶å°”å†™çŸ­è¯— |
| skeptic | æ€€ç–‘è€…Dave | ğŸ¤” | #6366F1 | ç†æ€§ã€è´¨ç–‘ | è¦æ±‚è¯æ®ï¼ŒæŒ‡å‡ºé€»è¾‘æ¼æ´ |
| cheerleader | é˜³å…‰Sunny | â˜€ï¸ | #EC4899 | ç§¯æã€çƒ­æƒ… | å‘ç°äº®ç‚¹ï¼Œçƒ­æƒ…é¼“åŠ± |
| historian | é™ˆæ•™æˆ | ğŸ“š | #78716C | åšå­¦ã€ä¸¥è°¨ | è¿½æº¯å†å²ï¼Œæä¾›èƒŒæ™¯çŸ¥è¯† |
| practitioner | å·¥ç¨‹å¸ˆBob | ğŸ”§ | #0EA5E9 | åŠ¡å®ã€ç›´æ¥ | å…³æ³¨å®é™…åº”ç”¨å’Œè½åœ° |

---

## 6. ç´ ææ–¹æ¡ˆ

### 6.1 æ¨èç´ æåŒ…

**é¦–é€‰**: [Ninja Adventure Asset Pack](https://pixel-boy.itch.io/ninja-adventure-asset-pack)
- é£æ ¼ï¼šæ—¥å¼æ‘åº„
- åŒ…å«ï¼šç“¦ç‰‡ã€å»ºç­‘ã€è§’è‰²ã€åŠ¨ç”»
- æˆæƒï¼šå…è´¹å•†ç”¨

**å¤‡é€‰**:
- [Serene Village](https://limezu.itch.io/serenevillage) - å’Œé£æ‘åº„
- [Sprout Lands](https://cupnooble.itch.io/sprout-lands-asset-pack) - å¯çˆ±å†œåœºé£

### 6.2 è‡ªå®šä¹‰è§’è‰²

8ä¸ªAgentè§’è‰²å¯ä»¥ï¼š
1. ä½¿ç”¨ç´ æåŒ…ä¸­çš„è§’è‰²ï¼Œé€šè¿‡é¢œè‰²åŒºåˆ†
2. ç”¨ AI ç”ŸæˆåŒ¹é…é£æ ¼çš„è‡ªå®šä¹‰ç²¾çµ
3. åœ¨è§’è‰²å¤´é¡¶æ˜¾ç¤º emoji å¤´åƒä½œä¸ºè¯†åˆ«

### 6.3 ç´ æè§„æ ¼

```
ç“¦ç‰‡å¤§å°: 16x16 æˆ– 32x32 åƒç´ 
è§’è‰²å¤§å°: 16x32 æˆ– 32x48 åƒç´  (æ¯”ç“¦ç‰‡é«˜)
åŠ¨ç”»å¸§ç‡: 8 FPS (èµ°è·¯åŠ¨ç”»)
è°ƒè‰²æ¿: é™åˆ¶åœ¨ 32-64 è‰²ä»¥ä¿æŒåƒç´ é£æ ¼
```

---

## 7. å®ç°è®¡åˆ’

### Phase 1: æ ¸å¿ƒæ¡†æ¶ (Week 1)
- [ ] æ­å»ºå‰ç«¯é¡¹ç›®ç»“æ„
- [ ] å®ç° Canvas æ¸²æŸ“åŸºç¡€
- [ ] å®ç°ç“¦ç‰‡åœ°å›¾æ¸²æŸ“
- [ ] å®ç°åŸºç¡€æ¸¸æˆå¾ªç¯

### Phase 2: Agentç³»ç»Ÿ (Week 2)
- [ ] å®ç° Agent ç±»å’ŒçŠ¶æ€æœº
- [ ] å®ç°ç®€å•è·¯å¾„å¯»æ‰¾ (A*)
- [ ] å®ç°è§’è‰²ç²¾çµåŠ¨ç”»
- [ ] å®ç° Agent éšæœºè¡Œä¸º

### Phase 3: åç«¯æœåŠ¡ (Week 3)
- [ ] æ­å»º Cloudflare Worker
- [ ] å®ç° KV æ•°æ®å­˜å–
- [ ] å®ç° Cron å®šæ—¶ä»»åŠ¡
- [ ] é›†æˆ OpenAI ç”Ÿæˆè¯„è®º

### Phase 4: å‰åç«¯é›†æˆ (Week 4)
- [ ] å®ç°å‰ç«¯çŠ¶æ€åŒæ­¥
- [ ] å®ç°è¯„è®ºæ°”æ³¡æ˜¾ç¤º
- [ ] å®ç°æ´»åŠ¨æ—¥å¿—é¢æ¿
- [ ] å®ç°è§’è‰²è¯¦æƒ…é¢æ¿

### Phase 5: ç¾åŒ–å’Œä¼˜åŒ– (Week 5)
- [ ] é›†æˆæ­£å¼ç´ æ
- [ ] æ·»åŠ éŸ³æ•ˆ (å¯é€‰)
- [ ] æ·»åŠ å¤©æ°”/æ—¥å¤œæ•ˆæœ (å¯é€‰)
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] åµŒå…¥åšå®¢é¡µé¢

---

## 8. åµŒå…¥åšå®¢æ–¹æ¡ˆ

### æ–¹æ¡ˆA: ç‹¬ç«‹é¡µé¢
```
https://yuxu.ge/agent-town/
```

### æ–¹æ¡ˆB: iframeåµŒå…¥
```html
<!-- åœ¨åšå®¢ä¾§è¾¹æ æˆ–é¡µè„š -->
<iframe src="/agent-town/" width="320" height="240"></iframe>
```

### æ–¹æ¡ˆC: è¿·ä½ ç‰ˆå°éƒ¨ä»¶
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ˜ï¸ Agent Town   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ [è¿·ä½ åœ°å›¾]   â”‚ â”‚
â”‚ â”‚  ğŸ§™ ğŸš€ ğŸ­   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ ğŸ’¬ æœ€æ–°: è‹æ ¼æ‹‰åº•â”‚
â”‚ è¯„è®ºäº†ã€ŠRAGã€‹   â”‚
â”‚ [æŸ¥çœ‹å®Œæ•´ç‰ˆ â†’]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 9. æˆæœ¬ä¼°ç®—

| é¡¹ç›® | å…è´¹é¢åº¦ | é¢„ä¼°ç”¨é‡ | è´¹ç”¨ |
|------|---------|---------|------|
| Cloudflare Worker | 100kè¯·æ±‚/å¤© | ~1k/å¤© | $0 |
| Cloudflare KV | 100kè¯»/å¤© | ~1k/å¤© | $0 |
| OpenAI API | - | ~300æ¬¡/æœˆ | ~$1-2/æœˆ |

---

## 10. æœªæ¥æ‰©å±•

- [ ] Agentä¹‹é—´çš„å¯¹è¯äº’åŠ¨
- [ ] ç”¨æˆ·å¯ä»¥ä¸AgentèŠå¤©
- [ ] Agentè®°å¿†ç³»ç»Ÿï¼ˆè®°ä½è¯»è¿‡çš„æ–‡ç« ï¼‰
- [ ] å­£èŠ‚/èŠ‚æ—¥ä¸»é¢˜å˜åŒ–
- [ ] æ›´å¤šAgentè§’è‰²
- [ ] Agentæˆé•¿ç³»ç»Ÿ

---

## å¾…ç¡®è®¤é—®é¢˜

1. **ç´ æé€‰æ‹©**: ä½¿ç”¨æ¨èçš„ Ninja Adventure è¿˜æ˜¯å…¶ä»–ï¼Ÿ
2. **åœ°å›¾å¤§å°**: 640x480 å¤Ÿç”¨å—ï¼Ÿ
3. **è¯„è®ºé¢‘ç‡**: æ¯5åˆ†é’Ÿç”Ÿæˆä¸€æ¡è¯„è®ºæ˜¯å¦åˆé€‚ï¼Ÿ
4. **åµŒå…¥æ–¹å¼**: ç‹¬ç«‹é¡µé¢ / iframe / è¿·ä½ ç‰ˆï¼Ÿ
5. **æ˜¯å¦éœ€è¦éŸ³æ•ˆ**ï¼Ÿ
