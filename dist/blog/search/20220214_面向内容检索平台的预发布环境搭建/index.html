<!DOCTYPE html><html lang="zh"> <head><!-- Global Metadata --><meta charset="utf-8"><!--<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">--><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css"><link rel="shortcut icon" href="/favicon.png" type="image/png"><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="Ge Yuxu • AI &#38; Engineering" href="https://geyuxu.com/rss.xml"><meta name="generator" content="Astro v5.5.6"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://geyuxu.com/blog/search/20220214_%E9%9D%A2%E5%90%91%E5%86%85%E5%AE%B9%E6%A3%80%E7%B4%A2%E5%B9%B3%E5%8F%B0%E7%9A%84%E9%A2%84%E5%8F%91%E5%B8%83%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"><!-- Primary Meta Tags --><title>面向内容检索平台的预发布环境搭建</title><meta name="title" content="面向内容检索平台的预发布环境搭建"><meta name="description"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://geyuxu.com/blog/search/20220214_%E9%9D%A2%E5%90%91%E5%86%85%E5%AE%B9%E6%A3%80%E7%B4%A2%E5%B9%B3%E5%8F%B0%E7%9A%84%E9%A2%84%E5%8F%91%E5%B8%83%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"><meta property="og:title" content="面向内容检索平台的预发布环境搭建"><meta property="og:description"><meta property="og:image" content="https://geyuxu.com/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://geyuxu.com/blog/search/20220214_%E9%9D%A2%E5%90%91%E5%86%85%E5%AE%B9%E6%A3%80%E7%B4%A2%E5%B9%B3%E5%8F%B0%E7%9A%84%E9%A2%84%E5%8F%91%E5%B8%83%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"><meta property="twitter:title" content="面向内容检索平台的预发布环境搭建"><meta property="twitter:description"><meta property="twitter:image" content="https://geyuxu.com/blog-placeholder-1.jpg"><script src="/js/jquery-3.7.1.min.js"></script><script src="/js/copy-code-button.js" defer></script><!-- Dify Chatbot Configuration --><script>
 window.difyChatbotConfig = {
  token: 'VgrjCAto93bjE0MW',
  systemVariables: {
    // user_id: 'YOU CAN DEFINE USER ID HERE',
    // conversation_id: 'YOU CAN DEFINE CONVERSATION ID HERE, IT MUST BE A VALID UUID',
  },
  userVariables: {
    // avatar_url: 'YOU CAN DEFINE USER AVATAR URL HERE',
    // name: 'YOU CAN DEFINE USER NAME HERE',
  },
 }
</script><!-- Dify Chatbot Script --><script src="https://udify.app/embed.min.js" id="VgrjCAto93bjE0MW" defer>
</script><!-- Dify Chatbot Custom Styles --><script is:global>
	window.addEventListener('DOMContentLoaded', () => {
		$('.toc ol').css({
		'list-style': 'none',   // 隐藏 1. 2. 3.
		'margin': 0,
		'padding-left': 0,       // 可按需调整
		});
		$('.toc ol > li').css({
		'list-style': 'none',   // 隐藏 1. 2. 3.
		'padding-left': 10
		});
        $('.sidebar').append($('.toc'));
      });
	</script><link rel="stylesheet" href="/_astro/assets-slug_.BFPovWfH.css">
<style>a[data-astro-cid-eimmu3lg]{display:inline-block;text-decoration:none}a[data-astro-cid-eimmu3lg].active{font-weight:bolder;text-decoration:underline}header[data-astro-cid-3ef6ksr2]{margin:0;padding:0 1em;background:#fff;box-shadow:0 2px 8px rgba(var(--black),5%)}h2[data-astro-cid-3ef6ksr2]{margin:0;font-size:1em}h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2],h2[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none}nav[data-astro-cid-3ef6ksr2]{display:flex;align-items:center;justify-content:space-between}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{padding:1em .5em;color:var(--black);border-bottom:4px solid transparent;text-decoration:none}nav[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2].active{text-decoration:none;border-bottom-color:var(--accent)}.social-links[data-astro-cid-3ef6ksr2],.social-links[data-astro-cid-3ef6ksr2] a[data-astro-cid-3ef6ksr2]{display:flex}@media (max-width: 720px){.social-links[data-astro-cid-3ef6ksr2]{display:none}}footer[data-astro-cid-sz7xmlte]{padding:2em 1em 6em;background:linear-gradient(var(--gray-gradient)) no-repeat;color:rgb(var(--gray));text-align:center}.social-links[data-astro-cid-sz7xmlte]{display:flex;justify-content:center;gap:1em;margin-top:1em}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]{text-decoration:none;color:rgb(var(--gray))}.social-links[data-astro-cid-sz7xmlte] a[data-astro-cid-sz7xmlte]:hover{color:rgb(var(--gray-dark))}
.statement[data-astro-cid-uffxixac]{font-size:10px;color:gray}@media (max-width: 640px){.statement[data-astro-cid-uffxixac]{font-size:6px;color:gray}}
</style></head> <body> <header data-astro-cid-3ef6ksr2> <nav data-astro-cid-3ef6ksr2> <!--<h2><a href="/">{SITE_TITLE}</a></h2>--> <h2 data-astro-cid-3ef6ksr2><a style="padding-left:0;color:blue;" href="/" data-astro-cid-3ef6ksr2>Ge Yuxu<br data-astro-cid-3ef6ksr2>AI & Engineering</a></h2> <div class="internal-links" data-astro-cid-3ef6ksr2> <a href="/" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Home </a>  <a href="/blog/1" class="active" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Blog </a>  <a href="/series" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Series </a>  <a href="/projects" data-astro-cid-3ef6ksr2="true" data-astro-cid-eimmu3lg> Projects </a>  </div> <div class="social-links" data-astro-cid-3ef6ksr2> <a href="https://github.com/geyuxu" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Go to Ge Yuxu's GitHub repo</span> <svg viewBox="0 0 16 16" aria-hidden="true" width="32" height="32" data-astro-cid-3ef6ksr2><path fill="currentColor" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z" data-astro-cid-3ef6ksr2></path></svg> </a> <a href="https://www.linkedin.com/in/geyuxu/" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Go to Ge Yuxu's LinkedIn profile</span> <svg viewBox="0 0 24 24" width="32" height="32" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" data-astro-cid-3ef6ksr2> <path fill="currentColor" d="M20.447 20.452H17.2v-5.569c0-1.328-.025-3.039-1.852-3.039-1.853 0-2.136 1.447-2.136 2.942v5.666h-3.248V9h3.122v1.561h.045c.435-.823 1.498-1.688 3.083-1.688 3.295 0 3.903 2.17 3.903 4.989v6.59zM5.337 7.433a1.882 1.882 0 110-3.764 1.882 1.882 0 010 3.764zm1.626 13.019H3.708V9h3.255v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.226.792 24 1.771 24h20.451C23.2 24 24 23.226 24 22.271V1.729C24 .774 23.2 0 22.222 0z" data-astro-cid-3ef6ksr2></path> </svg> </a> <a href="mailto:ngzerone@hotmail.com" target="_blank" data-astro-cid-3ef6ksr2> <span class="sr-only" data-astro-cid-3ef6ksr2>Send email to Ge Yuxu</span> <svg viewBox="0 0 24 24" width="32" height="32" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" data-astro-cid-3ef6ksr2> <path fill="currentColor" d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z" data-astro-cid-3ef6ksr2></path> </svg> </a> </div> </nav> <!-- Microsoft Clarity --> <script type="text/javascript">
		(function(c,l,a,r,i,t,y){
			c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
			t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
			y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
		})(window, document, "clarity", "script", "rc2w96osp6");
	</script> </header>  <main class="page"> <!-- 左侧栏 --> <aside class="sidebar"> <div class="meta"> <b>面向内容检索平台的预发布环境搭建</b> <p><time datetime="2022-02-13T16:00:00.000Z"> 2022/02/14 00:00:00 </time></p>   </div> <hr> <br> </aside> <!-- 右侧正文区域（flex 居中） --> <div class="content-wrapper"> <article class="prose">  <nav class="toc"><ol class="toc-level toc-level-1"><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#cassandra-副本机制解析">Cassandra 副本机制解析</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#solrcloud-分片原理解析">SolrCloud 分片原理解析</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#zookeeper-选主算法解析">ZooKeeper 选主算法解析</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#python-批量写入-cassandra-示例">Python 批量写入 Cassandra 示例</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#python-批量更新-solr-示例">Python 批量更新 Solr 示例</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#python-简易健康检查脚本">Python 简易健康检查脚本</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#docker-compose-集群部署示例">Docker Compose 集群部署示例</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#常见错误及排查">常见错误及排查</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#经验总结">经验总结</a></li><li class="toc-item toc-item-h2"><a class="toc-link toc-link-h2" href="#参考资料">参考资料：</a></li></ol></nav><h1 id="面向内容检索平台的预发布环境搭建"><a aria-hidden="true" tabindex="-1" href="#面向内容检索平台的预发布环境搭建"><span class="icon icon-link"></span></a>面向内容检索平台的预发布环境搭建</h1>
<p>内容检索平台通常由 数据存储（例如 Cassandra）、搜索引擎（例如 SolrCloud）以及 协调服务（例如 ZooKeeper）等组件构成。为了确保新功能发布前的稳定性，我们需要一个与生产环境配置一致但规模较小的预发布环境进行验证 。本文将深入解析相关技术原理，并提供完整的预发布环境搭建指南，包括 Docker Compose 集群部署、Python 批量操作示例代码、常见错误排查步骤和最佳实践总结。</p>
<h2 id="cassandra-副本机制解析"><a aria-hidden="true" tabindex="-1" href="#cassandra-副本机制解析"><span class="icon icon-link"></span></a>Cassandra 副本机制解析</h2>
<p>Cassandra 作为分布式 NoSQL 数据库，采用 无主（Masterless）架构，数据在多个节点上冗余存储，从而保证高可用性和容错性 。集群中的数据按照一致性哈希被划分到不同节点（称为 分区），每个分区会有一定数量的副本存储在不同节点上，这个数量称为复制因子 (Replication Factor) 。例如，复制因子为 3 时，每条记录会被保存到环形集群中顺时针找到的三个不同节点上 。由于采用多副本存储，Cassandra 没有单点故障——任一节点宕机，其他节点上的副本仍可提供数据服务 。所有副本地位相等，没有“主”或“从”之分 。</p>
<p>为了协调多副本的数据一致，Cassandra 引入了 可调一致性 (Tunable Consistency) 概念 。客户端在读写数据时可以指定一致性级别，例如 ONE、QUORUM、ALL 等，以权衡性能和数据准确性 。例如，写操作使用 QUORUM 则需要大多数副本成功写入才算成功读取，读操作使用 QUORUM 则需要读取大多数副本并比较得到结果。这种机制使我们能够根据应用需求选择强一致还是最终一致的策略。值得一提的是，Cassandra 的任一节点都可以充当请求的 协调者 (Coordinator)，它负责将写请求转发给所有副本并收集响应。当某个副本暂时不可用时，协调者还会保存一个提示 (Hint)，待该副本恢复后再补写数据，从而实现故障自愈 。总之，Cassandra 的副本机制通过多节点冗余和可调一致性，在提高可靠性的同时兼顾了性能灵活性。</p>
<h2 id="solrcloud-分片原理解析"><a aria-hidden="true" tabindex="-1" href="#solrcloud-分片原理解析"><span class="icon icon-link"></span></a>SolrCloud 分片原理解析</h2>
<p>SolrCloud 是 Solr 的分布式部署模式，用于处理大规模搜索索引。SolrCloud 将索引拆分成多个 分片 (Shard)，每个分片包含整个索引的一部分文档集合 。集合 (Collection) 是用户逻辑上的一个完整索引，它可能由一个或多个分片组成。SolrCloud 会根据文档的唯一键哈希或指定路由，将文档自动分配到对应的分片上，从而实现水平扩展。为了保证查询的完整性，Solr 支持 分布式查询，即一个查询会由查询节点转发到所有分片执行，汇总各分片结果后再返回给客户端。</p>
<p>每个分片为了高可用起见可以有多个 副本 (Replica)。所有副本的数据完全相同，其中有且只有一个被选举为 Leader，负责该分片的索引更新协调 。其余副本称为 Follower（以前也叫从属），从 Leader 同步索引更新。SolrCloud 没有传统意义的集群主从架构——整个集群不存在单一主节点，每个分片各自独立选主 。ZooKeeper 会维护 SolrCloud 集群的状态信息，包括哪些集合、分片、副本，以及哪个副本当前是 Leader。当需要新增副本或分裂分片时，也通过 Solr 的 Collections API 通知 ZooKeeper 再由集群协同执行。</p>
<p>这样的设计带来了高可用和容错能力：同一分片有多份副本提供服务，即使某个副本宕机，查询请求会自动由剩余副本处理，不影响整体服务 。如果某分片的 Leader 宕机，ZooKeeper 会在剩余副本中自动选举出新的 Leader，继续承担索引写入。 同时，SolrCloud 利用 ZooKeeper 实现集中配置管理和任务协调 。所有 Solr 实例启动时都会从 ZooKeeper 获取最新的配置，当配置变更时各节点也能及时感知。此外，发送给集群的索引请求无论到达哪个节点，都会由 SolrCloud 自动转发到正确的分片 Leader 去处理 ，这一切都得益于 ZooKeeper 保存的集群路由信息。通过分片+副本+选主机制，SolrCloud 实现了索引的 水平拆分 和 冗余备份。对于内容检索平台而言，这意味着可以轻松扩展索引规模，并保证在预发布环境中也能模拟查询的分布式过程和容错行为。</p>
<h2 id="zookeeper-选主算法解析"><a aria-hidden="true" tabindex="-1" href="#zookeeper-选主算法解析"><span class="icon icon-link"></span></a>ZooKeeper 选主算法解析</h2>
<p>ZooKeeper 在上述架构中充当“集群大脑”，为分布式系统提供配置存储、命名服务和同步原语等功能。其中最重要的一点是它需要保证自己的数据一致性——这通过 选主算法 来实现。一个 ZooKeeper 集群（称为 仲裁集合，ensemble）通常由多个节点组成，其中任何时刻只有一个 Leader 节点对外提供写服务，其余为 Follower 节点参与复制和投票。如果 Leader 宕机，剩余节点会通过选举算法选出新的 Leader。</p>
<p>ZooKeeper 的选主算法本质上是一个 多数投票协议。每个 ZooKeeper 节点有一个唯一的 服务器ID (myid)，以及记录自身数据状态的 事务ID (ZXID) 和轮次编号 Epoch。选举过程如下：当集群启动或Leader失效时，所有节点进入 LOOKING（选举进行中）状态，首先每个节点投自己一票（推举自己为候选Leader）。节点之间交换投票，根据既定规则比较候选者资格： 首先比对 Epoch（轮次较大的优先，这是为了防止过期的投票干扰）；如果 Epoch 相同，则比较 ZXID（数据更新越新的节点优先，意味着它拥有“最新”的集群状态）；如果 ZXID 也相同，再比较 myid（ID数值更大的节点优先）。经过多轮比较和投票交换后，一旦某个候选者获得超过半数节点的认可（这就是 ZooKeeper 要求集群节点数为奇数的原因：超过半数即严格多数），该候选者就当选为 Leader 。选举完成后，集群状态更新：胜出节点切换为 LEADING 状态成为 Leader，其他节点切换为 FOLLOWING 状态成为追随者，开始从新Leader同步数据。</p>
<p>通过上述过程，ZooKeeper 保证了在任意时刻只有一个 Leader，并且至少有半数节点保存了最新的数据日志副本。当客户端发起写请求时，Leader 将请求以事务Proposal形式广播给所有 Follower，收集过半确认后提交事务（这就是 Zab 协议的核心思想）。如果 Leader 崩溃，只要大多数节点仍健在，就能选出新 Leader 并继续提供服务。这也解释了为什么我们常见的 ZooKeeper 集群由 3 或 5 台机器组成——3台可容忍1台故障，5台可容忍2台故障，而仍有过半节点存活保证服务不间断。总之，ZooKeeper 的选主算法为分布式系统提供了强一致性的基础，在预发布环境中部署 ZooKeeper 集群能真实模拟生产中的故障切换行为，确保内容检索平台各组件的协调机制在发布前得到充分验证。</p>
<h2 id="python-批量写入-cassandra-示例"><a aria-hidden="true" tabindex="-1" href="#python-批量写入-cassandra-示例"><span class="icon icon-link"></span></a>Python 批量写入 Cassandra 示例</h2>
<p>预发布环境通常需要构造测试数据。下面通过 Python 和 Cassandra 驱动实现向 Cassandra 批量写入数据的示例。我们假设 Cassandra 已有名为 test_keyspace 的键空间和适当的表结构（如果没有，可先创建表）。代码使用 DataStax Cassandra Python Driver 执行批量插入操作：</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto;" tabindex="0" data-language="py"><code><span class="line"><span style="color:#D73A49">from</span><span style="color:#24292E"> cassandra.cluster </span><span style="color:#D73A49">import</span><span style="color:#24292E"> Cluster</span></span>
<span class="line"><span style="color:#D73A49">from</span><span style="color:#24292E"> cassandra.query </span><span style="color:#D73A49">import</span><span style="color:#24292E"> BatchStatement, ConsistencyLevel</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># 连接 Cassandra 集群（预发布环境通常在本地或内网）</span></span>
<span class="line"><span style="color:#24292E">cluster </span><span style="color:#D73A49">=</span><span style="color:#24292E"> Cluster([</span><span style="color:#032F62">'127.0.0.1'</span><span style="color:#24292E">])</span></span>
<span class="line"><span style="color:#24292E">session </span><span style="color:#D73A49">=</span><span style="color:#24292E"> cluster.connect(</span><span style="color:#032F62">'test_keyspace'</span><span style="color:#24292E">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># 如果目标表不存在，可以先创建</span></span>
<span class="line"><span style="color:#24292E">session.execute(</span><span style="color:#032F62">"""</span></span>
<span class="line"><span style="color:#032F62">    CREATE TABLE IF NOT EXISTS users (</span></span>
<span class="line"><span style="color:#032F62">        id int PRIMARY KEY,</span></span>
<span class="line"><span style="color:#032F62">        name text,</span></span>
<span class="line"><span style="color:#032F62">        age int</span></span>
<span class="line"><span style="color:#032F62">    )</span></span>
<span class="line"><span style="color:#032F62">"""</span><span style="color:#24292E">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># 准备插入语句</span></span>
<span class="line"><span style="color:#24292E">insert_stmt </span><span style="color:#D73A49">=</span><span style="color:#24292E"> session.prepare(</span><span style="color:#032F62">"INSERT INTO users (id, name, age) VALUES (?, ?, ?)"</span><span style="color:#24292E">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># 待插入的数据列表</span></span>
<span class="line"><span style="color:#24292E">users </span><span style="color:#D73A49">=</span><span style="color:#24292E"> [</span></span>
<span class="line"><span style="color:#24292E">    (</span><span style="color:#005CC5">1</span><span style="color:#24292E">, </span><span style="color:#032F62">'Alice'</span><span style="color:#24292E">, </span><span style="color:#005CC5">30</span><span style="color:#24292E">),</span></span>
<span class="line"><span style="color:#24292E">    (</span><span style="color:#005CC5">2</span><span style="color:#24292E">, </span><span style="color:#032F62">'Bob'</span><span style="color:#24292E">, </span><span style="color:#005CC5">25</span><span style="color:#24292E">),</span></span>
<span class="line"><span style="color:#24292E">    (</span><span style="color:#005CC5">3</span><span style="color:#24292E">, </span><span style="color:#032F62">'Charlie'</span><span style="color:#24292E">, </span><span style="color:#005CC5">35</span><span style="color:#24292E">)</span></span>
<span class="line"><span style="color:#24292E">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># 将多个插入操作添加到一个批处理中</span></span>
<span class="line"><span style="color:#24292E">batch </span><span style="color:#D73A49">=</span><span style="color:#24292E"> BatchStatement(</span><span style="color:#E36209">consistency_level</span><span style="color:#D73A49">=</span><span style="color:#24292E">ConsistencyLevel.</span><span style="color:#005CC5">QUORUM</span><span style="color:#24292E">)</span></span>
<span class="line"><span style="color:#D73A49">for</span><span style="color:#24292E"> user </span><span style="color:#D73A49">in</span><span style="color:#24292E"> users:</span></span>
<span class="line"><span style="color:#24292E">    batch.add(insert_stmt, user)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># 执行批量插入</span></span>
<span class="line"><span style="color:#24292E">session.execute(batch)</span></span>
<span class="line"><span style="color:#005CC5">print</span><span style="color:#24292E">(</span><span style="color:#032F62">"Batch insert completed."</span><span style="color:#24292E">)</span></span></code></pre>
<p>上述脚本首先连接到 Cassandra（假定在本机 9042 端口），然后通过 BatchStatement 将多条插入语句打包在一起发送，提高插入效率。我们设置了一致性级别为 QUORUM，表示需要多数副本确认写入。这在预发布环境可以帮助测试不同一致性级别下的性能和行为。执行成功后，Cassandra 中将批量写入三条记录。在实际应用中，如测试数据较多，也可以考虑使用 异步插入 或官方提供的 cqlsh COPY、DSBulk 工具来导入大规模数据 。</p>
<h2 id="python-批量更新-solr-示例"><a aria-hidden="true" tabindex="-1" href="#python-批量更新-solr-示例"><span class="icon icon-link"></span></a>Python 批量更新 Solr 示例</h2>
<p>有了数据存储，下一步通常需要将数据索引到 SolrCloud 以供检索。下面提供一个 Python 脚本示例，通过 Solr 的 HTTP 接口实现 批量更新索引（添加文档）。这里使用 Python 的 requests 库直接向 Solr 提交 JSON 文档：</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto;" tabindex="0" data-language="py"><code><span class="line"><span style="color:#D73A49">import</span><span style="color:#24292E"> requests, json</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># 待索引的文档列表，每个文档是一个字典</span></span>
<span class="line"><span style="color:#24292E">docs </span><span style="color:#D73A49">=</span><span style="color:#24292E"> [</span></span>
<span class="line"><span style="color:#24292E">    {</span><span style="color:#032F62">"id"</span><span style="color:#24292E">: </span><span style="color:#032F62">"1"</span><span style="color:#24292E">, </span><span style="color:#032F62">"title"</span><span style="color:#24292E">: </span><span style="color:#032F62">"Hello"</span><span style="color:#24292E">, </span><span style="color:#032F62">"content"</span><span style="color:#24292E">: </span><span style="color:#032F62">"世界你好"</span><span style="color:#24292E">},</span></span>
<span class="line"><span style="color:#24292E">    {</span><span style="color:#032F62">"id"</span><span style="color:#24292E">: </span><span style="color:#032F62">"2"</span><span style="color:#24292E">, </span><span style="color:#032F62">"title"</span><span style="color:#24292E">: </span><span style="color:#032F62">"Foo"</span><span style="color:#24292E">, </span><span style="color:#032F62">"content"</span><span style="color:#24292E">: </span><span style="color:#032F62">"Bar 内容"</span><span style="color:#24292E">}</span></span>
<span class="line"><span style="color:#24292E">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Solr 更新接口URL，假设集合名称为 my_collection</span></span>
<span class="line"><span style="color:#24292E">solr_url </span><span style="color:#D73A49">=</span><span style="color:#032F62"> "http://localhost:8983/solr/my_collection/update?commit=true"</span></span>
<span class="line"><span style="color:#24292E">headers </span><span style="color:#D73A49">=</span><span style="color:#24292E"> {</span><span style="color:#032F62">"Content-Type"</span><span style="color:#24292E">: </span><span style="color:#032F62">"application/json"</span><span style="color:#24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># 发送 POST 请求批量提交文档</span></span>
<span class="line"><span style="color:#24292E">response </span><span style="color:#D73A49">=</span><span style="color:#24292E"> requests.post(solr_url, </span><span style="color:#E36209">data</span><span style="color:#D73A49">=</span><span style="color:#24292E">json.dumps(docs), </span><span style="color:#E36209">headers</span><span style="color:#D73A49">=</span><span style="color:#24292E">headers)</span></span>
<span class="line"><span style="color:#005CC5">print</span><span style="color:#24292E">(</span><span style="color:#032F62">"Response:"</span><span style="color:#24292E">, response.status_code, response.text)</span></span></code></pre>
<p>在运行此脚本之前，需要确保 SolrCloud 集群中已经创建了名为 my_collection 的集合（collection），并且具有相应的字段模式以接受 title 和 content 等字段。如果集合尚未创建，可以通过 Solr 提供的命令快速创建一个，例如在容器中执行：</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#6F42C1">docker</span><span style="color:#032F62"> exec</span><span style="color:#005CC5"> -it</span><span style="color:#032F62"> solr1</span><span style="color:#032F62"> solr</span><span style="color:#032F62"> create</span><span style="color:#005CC5"> -c</span><span style="color:#032F62"> my_collection</span><span style="color:#005CC5"> -n</span><span style="color:#032F62"> data_driven_schema_configs</span></span></code></pre>
<p>上述命令将在 ZooKeeper 协调下创建一个名为 “my_collection”的新集合，使用内置的 data_driven_schema_configs 默认配置。创建完成后，运行 Python 脚本即可将 docs 列表中的文档批量提交给 Solr 索引。我们在请求URL中附加了 commit=true，让Solr在更新后立即提交，使文档可搜索。提交成功后，Solr 返回状态码以及简要结果信息（通常为空或包含更新的文档数量）。批量更新接口一次可以提交多个文档，Solr 会将这些文档路由到各自所属的分片并建立索引 。通过这种方式，我们能够在预发布环境批量构建索引数据，以模拟真实搜索场景。</p>
<h2 id="python-简易健康检查脚本"><a aria-hidden="true" tabindex="-1" href="#python-简易健康检查脚本"><span class="icon icon-link"></span></a>Python 简易健康检查脚本</h2>
<p>预发布环境部署完成后，进行健康检查非常重要。以下提供一个 Python 编写的简单健康检查脚本，它依次检测 Cassandra、Solr 和 ZooKeeper 三个服务是否正常响应：</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto;" tabindex="0" data-language="sh"><code><span class="line"><span style="color:#6F42C1">import</span><span style="color:#032F62"> socket</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1">services</span><span style="color:#032F62"> =</span><span style="color:#032F62"> {</span></span>
<span class="line"><span style="color:#6F42C1">    "Cassandra"</span><span style="color:#005CC5">:</span><span style="color:#24292E"> (</span><span style="color:#032F62">"localhost"</span><span style="color:#24292E">, </span><span style="color:#005CC5">9042</span><span style="color:#24292E">),</span></span>
<span class="line"><span style="color:#6F42C1">    "Solr"</span><span style="color:#005CC5">:</span><span style="color:#24292E">      (</span><span style="color:#032F62">"localhost"</span><span style="color:#24292E">, </span><span style="color:#005CC5">8983</span><span style="color:#24292E">),</span></span>
<span class="line"><span style="color:#6F42C1">    "ZooKeeper"</span><span style="color:#005CC5">:</span><span style="color:#24292E"> (</span><span style="color:#032F62">"localhost"</span><span style="color:#24292E">, </span><span style="color:#005CC5">2181</span><span style="color:#24292E">)</span></span>
<span class="line"><span style="color:#24292E">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49">for</span><span style="color:#24292E"> name, (</span><span style="color:#6F42C1">host,</span><span style="color:#032F62"> port</span><span style="color:#24292E">) in services.items():</span></span>
<span class="line"><span style="color:#6F42C1">    s</span><span style="color:#032F62"> =</span><span style="color:#032F62"> socket.socket</span><span style="color:#24292E">()</span></span>
<span class="line"><span style="color:#6F42C1">    try:</span></span>
<span class="line"><span style="color:#6F42C1">        s.settimeout(5</span><span style="color:#24292E">)</span></span>
<span class="line"><span style="color:#6F42C1">        s.connect((host,</span><span style="color:#032F62"> port</span><span style="color:#24292E">))</span></span>
<span class="line"><span style="color:#D73A49">        if</span><span style="color:#6F42C1"> name</span><span style="color:#032F62"> ==</span><span style="color:#032F62"> "ZooKeeper":</span></span>
<span class="line"><span style="color:#6A737D">            # 发送四字命令 "ruok" 检查 ZooKeeper 状态</span></span>
<span class="line"><span style="color:#6F42C1">            s.sendall(b</span><span style="color:#6F42C1">"ruok"</span><span style="color:#24292E">)</span></span>
<span class="line"><span style="color:#6F42C1">            resp</span><span style="color:#032F62"> =</span><span style="color:#032F62"> s.recv</span><span style="color:#24292E">(</span><span style="color:#6F42C1">4</span><span style="color:#24292E">)</span></span>
<span class="line"><span style="color:#D73A49">            if</span><span style="color:#6F42C1"> resp</span><span style="color:#032F62"> ==</span><span style="color:#032F62"> b'imok':</span></span>
<span class="line"><span style="color:#005CC5">                print</span><span style="color:#24292E">(</span><span style="color:#032F62">f</span><span style="color:#6F42C1">"{name} is healthy (responded {resp.decode()})"</span><span style="color:#24292E">)</span></span>
<span class="line"><span style="color:#24292E">            else:</span></span>
<span class="line"><span style="color:#005CC5">                print</span><span style="color:#24292E">(</span><span style="color:#032F62">f</span><span style="color:#6F42C1">"{name} responded with {resp.decode()}"</span><span style="color:#24292E">)</span></span>
<span class="line"><span style="color:#24292E">        else:</span></span>
<span class="line"><span style="color:#005CC5">            print</span><span style="color:#24292E">(</span><span style="color:#032F62">f</span><span style="color:#6F42C1">"{name} is up (port {port} reachable)"</span><span style="color:#24292E">)</span></span>
<span class="line"><span style="color:#6F42C1">    except</span><span style="color:#032F62"> Exception</span><span style="color:#032F62"> as</span><span style="color:#032F62"> e:</span></span>
<span class="line"><span style="color:#005CC5">        print</span><span style="color:#24292E">(</span><span style="color:#032F62">f</span><span style="color:#6F42C1">"{name} check failed: {e}"</span><span style="color:#24292E">)</span></span>
<span class="line"><span style="color:#6F42C1">    finally:</span></span>
<span class="line"><span style="color:#6F42C1">        s.close</span><span style="color:#24292E">()</span></span></code></pre>
<p>这个脚本通过尝试建立 TCP 连接来判断服务端口是否开放。其中对 ZooKeeper，我们发送了特殊的四字命令 “ruok”（意为“Are you ok”）并期望收到 “imok” 响应，表明 ZooKeeper 运转正常。如果 ZooKeeper 没有启用四字命令，可能不会返回任何数据（在新版本中需配置 ZOO_4LW_COMMANDS_WHITELIST 来开放该命令）。对于 Cassandra 和 Solr，我们仅测试端口连通性：能连接到 9042 则认为 Cassandra 存活，能连接到 8983 则认为 Solr 服务正常。实际生产中可以进一步通过执行查询或请求 API 来验证深层功能，例如对 Cassandra 执行一个简单的 SELECT，对 Solr 发一个查询请求等。</p>
<p>运行上述健康检查脚本，可快速定位预发布环境中哪个组件出现故障。例如输出 Solr check failed: [Errno 111] Connection refused 则说明 Solr 没有启动或端口未开放；若 ZooKeeper 返回非“imok”则需检查其是否进入正确状态。通过这样的脚本，运维人员可以定期检测预发布集群状态，在问题扩大前及时干预。</p>
<h2 id="docker-compose-集群部署示例"><a aria-hidden="true" tabindex="-1" href="#docker-compose-集群部署示例"><span class="icon icon-link"></span></a>Docker Compose 集群部署示例</h2>
<p>有了对原理的理解，我们可以着手在预发布环境部署一个迷你版的内容检索平台集群。这里使用 Docker Compose 一键启动 ZooKeeper + SolrCloud + Cassandra 集群，以模拟生产环境的分布式架构。下面是完整的 docker-compose.yml 示例：</p>
<pre class="astro-code github-light" style="background-color:#fff;color:#24292e; overflow-x: auto;" tabindex="0" data-language="yaml"><code><span class="line"><span style="color:#22863A">version</span><span style="color:#24292E">: </span><span style="color:#032F62">'3'</span></span>
<span class="line"><span style="color:#22863A">services</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#6A737D">  # ZooKeeper 集群（3个节点）</span></span>
<span class="line"><span style="color:#22863A">  zoo1</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#22863A">    image</span><span style="color:#24292E">: </span><span style="color:#032F62">zookeeper:3.8</span></span>
<span class="line"><span style="color:#22863A">    container_name</span><span style="color:#24292E">: </span><span style="color:#032F62">zoo1</span></span>
<span class="line"><span style="color:#22863A">    hostname</span><span style="color:#24292E">: </span><span style="color:#032F62">zoo1</span></span>
<span class="line"><span style="color:#22863A">    ports</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#24292E">      - </span><span style="color:#032F62">"2181:2181"</span></span>
<span class="line"><span style="color:#22863A">    environment</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#22863A">      ZOO_MY_ID</span><span style="color:#24292E">: </span><span style="color:#005CC5">1</span></span>
<span class="line"><span style="color:#22863A">      ZOO_SERVERS</span><span style="color:#24292E">: </span><span style="color:#032F62">server.1=zoo1:2888:3888;2181 server.2=zoo2:2888:3888;2181 server.3=zoo3:2888:3888;2181</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A">  zoo2</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#22863A">    image</span><span style="color:#24292E">: </span><span style="color:#032F62">zookeeper:3.8</span></span>
<span class="line"><span style="color:#22863A">    container_name</span><span style="color:#24292E">: </span><span style="color:#032F62">zoo2</span></span>
<span class="line"><span style="color:#22863A">    hostname</span><span style="color:#24292E">: </span><span style="color:#032F62">zoo2</span></span>
<span class="line"><span style="color:#22863A">    environment</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#22863A">      ZOO_MY_ID</span><span style="color:#24292E">: </span><span style="color:#005CC5">2</span></span>
<span class="line"><span style="color:#22863A">      ZOO_SERVERS</span><span style="color:#24292E">: </span><span style="color:#032F62">server.1=zoo1:2888:3888;2181 server.2=zoo2:2888:3888;2181 server.3=zoo3:2888:3888;2181</span></span>
<span class="line"><span style="color:#22863A">    depends_on</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#24292E">      - </span><span style="color:#032F62">zoo1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A">  zoo3</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#22863A">    image</span><span style="color:#24292E">: </span><span style="color:#032F62">zookeeper:3.8</span></span>
<span class="line"><span style="color:#22863A">    container_name</span><span style="color:#24292E">: </span><span style="color:#032F62">zoo3</span></span>
<span class="line"><span style="color:#22863A">    hostname</span><span style="color:#24292E">: </span><span style="color:#032F62">zoo3</span></span>
<span class="line"><span style="color:#22863A">    environment</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#22863A">      ZOO_MY_ID</span><span style="color:#24292E">: </span><span style="color:#005CC5">3</span></span>
<span class="line"><span style="color:#22863A">      ZOO_SERVERS</span><span style="color:#24292E">: </span><span style="color:#032F62">server.1=zoo1:2888:3888;2181 server.2=zoo2:2888:3888;2181 server.3=zoo3:2888:3888;2181</span></span>
<span class="line"><span style="color:#22863A">    depends_on</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#24292E">      - </span><span style="color:#032F62">zoo1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  # SolrCloud 集群（3个节点）</span></span>
<span class="line"><span style="color:#22863A">  solr1</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#22863A">    image</span><span style="color:#24292E">: </span><span style="color:#032F62">solr:9.2.1</span></span>
<span class="line"><span style="color:#22863A">    container_name</span><span style="color:#24292E">: </span><span style="color:#032F62">solr1</span></span>
<span class="line"><span style="color:#22863A">    ports</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#24292E">      - </span><span style="color:#032F62">"8983:8983"</span><span style="color:#6A737D">            # 映射第一个Solr节点端口到主机</span></span>
<span class="line"><span style="color:#22863A">    environment</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#22863A">      ZK_HOST</span><span style="color:#24292E">: </span><span style="color:#032F62">"zoo1:2181,zoo2:2181,zoo3:2181"</span></span>
<span class="line"><span style="color:#22863A">    depends_on</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#24292E">      - </span><span style="color:#032F62">zoo1</span></span>
<span class="line"><span style="color:#24292E">      - </span><span style="color:#032F62">zoo2</span></span>
<span class="line"><span style="color:#24292E">      - </span><span style="color:#032F62">zoo3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A">  solr2</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#22863A">    image</span><span style="color:#24292E">: </span><span style="color:#032F62">solr:9.2.1</span></span>
<span class="line"><span style="color:#22863A">    container_name</span><span style="color:#24292E">: </span><span style="color:#032F62">solr2</span></span>
<span class="line"><span style="color:#22863A">    environment</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#22863A">      ZK_HOST</span><span style="color:#24292E">: </span><span style="color:#032F62">"zoo1:2181,zoo2:2181,zoo3:2181"</span></span>
<span class="line"><span style="color:#22863A">    depends_on</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#24292E">      - </span><span style="color:#032F62">zoo1</span></span>
<span class="line"><span style="color:#24292E">      - </span><span style="color:#032F62">zoo2</span></span>
<span class="line"><span style="color:#24292E">      - </span><span style="color:#032F62">zoo3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A">  solr3</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#22863A">    image</span><span style="color:#24292E">: </span><span style="color:#032F62">solr:9.2.1</span></span>
<span class="line"><span style="color:#22863A">    container_name</span><span style="color:#24292E">: </span><span style="color:#032F62">solr3</span></span>
<span class="line"><span style="color:#22863A">    environment</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#22863A">      ZK_HOST</span><span style="color:#24292E">: </span><span style="color:#032F62">"zoo1:2181,zoo2:2181,zoo3:2181"</span></span>
<span class="line"><span style="color:#22863A">    depends_on</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#24292E">      - </span><span style="color:#032F62">zoo1</span></span>
<span class="line"><span style="color:#24292E">      - </span><span style="color:#032F62">zoo2</span></span>
<span class="line"><span style="color:#24292E">      - </span><span style="color:#032F62">zoo3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">  # Cassandra 集群（3个节点）</span></span>
<span class="line"><span style="color:#22863A">  cassandra1</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#22863A">    image</span><span style="color:#24292E">: </span><span style="color:#032F62">cassandra:3.11</span></span>
<span class="line"><span style="color:#22863A">    container_name</span><span style="color:#24292E">: </span><span style="color:#032F62">cassandra1</span></span>
<span class="line"><span style="color:#22863A">    ports</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#24292E">      - </span><span style="color:#032F62">"9042:9042"</span><span style="color:#6A737D">            # 映射第一个Cassandra节点端口到主机</span></span>
<span class="line"><span style="color:#22863A">    environment</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#22863A">      CASSANDRA_CLUSTER_NAME</span><span style="color:#24292E">: </span><span style="color:#032F62">"Test Cluster"</span></span>
<span class="line"><span style="color:#22863A">      CASSANDRA_SEEDS</span><span style="color:#24292E">: </span><span style="color:#032F62">"cassandra1"</span></span>
<span class="line"><span style="color:#22863A">      CASSANDRA_ENDPOINT_SNITCH</span><span style="color:#24292E">: </span><span style="color:#032F62">GossipingPropertyFileSnitch</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A">  cassandra2</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#22863A">    image</span><span style="color:#24292E">: </span><span style="color:#032F62">cassandra:3.11</span></span>
<span class="line"><span style="color:#22863A">    container_name</span><span style="color:#24292E">: </span><span style="color:#032F62">cassandra2</span></span>
<span class="line"><span style="color:#22863A">    environment</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#22863A">      CASSANDRA_CLUSTER_NAME</span><span style="color:#24292E">: </span><span style="color:#032F62">"Test Cluster"</span></span>
<span class="line"><span style="color:#22863A">      CASSANDRA_SEEDS</span><span style="color:#24292E">: </span><span style="color:#032F62">"cassandra1"</span></span>
<span class="line"><span style="color:#22863A">      CASSANDRA_ENDPOINT_SNITCH</span><span style="color:#24292E">: </span><span style="color:#032F62">GossipingPropertyFileSnitch</span></span>
<span class="line"><span style="color:#22863A">    depends_on</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#24292E">      - </span><span style="color:#032F62">cassandra1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#22863A">  cassandra3</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#22863A">    image</span><span style="color:#24292E">: </span><span style="color:#032F62">cassandra:3.11</span></span>
<span class="line"><span style="color:#22863A">    container_name</span><span style="color:#24292E">: </span><span style="color:#032F62">cassandra3</span></span>
<span class="line"><span style="color:#22863A">    environment</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#22863A">      CASSANDRA_CLUSTER_NAME</span><span style="color:#24292E">: </span><span style="color:#032F62">"Test Cluster"</span></span>
<span class="line"><span style="color:#22863A">      CASSANDRA_SEEDS</span><span style="color:#24292E">: </span><span style="color:#032F62">"cassandra1"</span></span>
<span class="line"><span style="color:#22863A">      CASSANDRA_ENDPOINT_SNITCH</span><span style="color:#24292E">: </span><span style="color:#032F62">GossipingPropertyFileSnitch</span></span>
<span class="line"><span style="color:#22863A">    depends_on</span><span style="color:#24292E">:</span></span>
<span class="line"><span style="color:#24292E">      - </span><span style="color:#032F62">cassandra1</span></span></code></pre>
<p>上述 Compose 文件定义了三个 ZooKeeper 容器（zoo1、zoo2、zoo3）、三个 Solr 容器（组成一个 SolrCloud 集群），以及三个 Cassandra 容器（组成一个 Cassandra 集群）。关键配置说明：</p>
<ul>
<li>ZooKeeper：通过 ZOO_MY_ID 和 ZOO_SERVERS 环境变量配置集群。这里将每个节点的 ID 分别设为1、2、3，并告诉每个容器集群内所有 ZooKeeper 的地址和端口。这样三个容器启动后会相互发现并选举出 Leader。我们映射了 zoo1 的 2181 端口到主机，以便外部工具（例如 zkCli.sh 或健康检查脚本）可以连接 ZooKeeper 集群。depends_on 确保 zoo2,zoo3 在 zoo1 之后启动（但注意这并不保证启动顺序完全按预期或 ZooKeeper 已经准备就绪，必要时可加入健康检查机制）。</li>
<li>SolrCloud：每个 Solr 实例启动时通过 ZK_HOST 指定 ZooKeeper 集群地址列表，使其加入 SolrCloud。我们开放了 solr1 的 8983 端口以访问 Web 管理界面，其余 Solr 实例不映射端口但仍在内部网络中与 solr1 互通。使用 depends_on 确保在启动 Solr 容器前 ZooKeeper 容器已启动。Solr 镜像默认会以 Cloud 模式 (-c) 运行，因为提供了 ZK_HOST。当所有 Solr 节点启动后，它们会共同组成一个 SolrCloud 集群。此时可以通过访问 <a href="http://localhost:8983/solr/">http://localhost:8983/solr/</a> 打开 Solr 管理界面，查看集群状态、创建集合等。</li>
<li>Cassandra：采用官方 Cassandra 镜像来启动三个节点。通过 CASSANDRA_SEEDS 我们指定种子节点地址为 cassandra1（第一个节点自己作为种子），这样其他节点能够发现并加入集群  。所有节点设置相同的 CASSANDRA_CLUSTER_NAME 确保属于同一集群。这里使用 GossipingPropertyFileSnitch（默认）使所有节点视为同一数据中心。如果需要多数据中心模拟，可调整对应的 DC 名称和策略。depends_on 确保后两个节点在种子节点启动后再启动，以避免同时初始化导致的 token 冲突问题 。启动后几分钟内，Cassandra 集群会完成自动发现，我们可以用 docker exec -it cassandra1 nodetool status 命令查看集群状态，每个节点应显示为 UN (Up/Normal) 且握有均匀的 Token Range。</li>
</ul>
<p>完成 Compose 文件后，运行 docker-compose up -d 即可在后台启动整个预发布集群。请耐心等待所有容器完成启动：可以通过 docker-compose logs -f 动态跟踪日志。当 Solr 日志出现 “Started Solr server” 字样，Cassandra 日志出现 “Startup complete”，ZooKeeper 日志出现 “Node is leader” 或 “Node is follower” 时，说明各服务均已就绪。</p>
<h2 id="常见错误及排查"><a aria-hidden="true" tabindex="-1" href="#常见错误及排查"><span class="icon icon-link"></span></a>常见错误及排查</h2>
<p>在预发布环境搭建过程中，可能会遇到一些常见问题。以下列出典型错误场景，并提供详细的排查步骤：</p>
<ul>
<li>Solr 无法连接 ZooKeeper：如果在 Solr 日志中看到报错 Could not connect to ZooKeeper … within … ms，说明 Solr 在指定时间内无法连上 ZooKeeper  。这可能是 ZooKeeper 尚未启动完成或 ZK_HOST 配置不正确。排查：首先执行 docker-compose logs -f zoo1 检查 ZooKeeper 日志是否正常（应有 Leader 选举结果和 绑定端口2181 等信息）。然后确认在 Solr 容器内能解析到 zoo1,zoo2,zoo3 主机名（例如 docker exec solr1 ping zoo1）。若名称解析有问题，可在 Compose 中显式指定 networks 或使用 links。如果只是启动顺序导致，可以尝试重启 Solr 容器：docker-compose restart solr1 solr2 solr3。还可以在 Compose 文件中为 ZooKeeper 增加健康检查，确保其完全就绪后再启动 Solr（通过 depends_on 的 condition: service_healthy 设置）。正常情况下，Solr Admin UI 打开后，在 “Cloud -> Graph” 能看到 ZooKeeper 状态及集群拓扑。</li>
<li>Solr 集群没有 Leader：创建 collection 时提示 “no active leader” 或查询返回部分分片无结果。这通常由于 SolrCloud 尚未选举完各分片的 leader 副本。排查：通过 Solr 管理界面的 “Cloud -> Tree” 或调用 Collections API 的 CLUSTERSTATUS 查看集合状态，确认每个 shard 下都有一个 “leader”:true 的副本。如果没有，检查 ZooKeeper 集群状态和 Solr 日志中的选主过程。如果 ZooKeeper 集群本身不稳定（例如少于过半节点存活），会导致 Solr 无法完成内部选主。此时需确保 ZooKeeper 至少有过半节点运行，并重启失联的 Solr 副本。通常在预发布环境，重启 SolrCloud 或等待数秒都能重新选出 leader。</li>
<li>Cassandra 节点未成功加入集群：运行 nodetool status 发现每台 Cassandra 只显示自身，没发现其他节点，或者日志出现集群名称不匹配的错误。排查：首先确保所有 Cassandra 容器使用相同的 CASSANDRA_CLUSTER_NAME（如不一致，会拒绝连接）。其次，检查 CASSANDRA_SEEDS 配置：应让至少一个节点（通常第一个）作为种子，其他节点配置种子列表包含它。如果种子配置正确但仍未互联，可能是由于 Compose 同时启动多个 Cassandra 导致初始 token 冲突 。解决方法：确保第一个节点完全启动后再启动其余节点（Compose 中已用 depends_on，但首次并行启动时仍可能竞争，必要时手动分两步启动）。也可以显式指定每个节点的初始 token 来避免冲突。检查容器日志中有没有 Unable to gossip with any seeds 等消息。如果有，重启出现问题的节点容器。最后，使用 docker exec -it cassandra1 cqlsh 连接Cassandra，执行 SELECT peer, rpc_address FROM system.peers; 查看种子节点眼中已发现的集群同伴列表，确认所有节点互相可见。</li>
<li>ZooKeeper 集群无法选举：如果 ZooKeeper 日志反复出现选举发起但无法成功（例如不停输出 LOOKING 状态），多数是因为 集群节点数不足多数 导致无法形成 quorum。比如启动了2个节点就尝试提供服务，会发现没有过半票选举不出 Leader。排查：确保 ZooKeeper 节点数是奇数且全部正确启动。如有节点启动失败（检查其日志，有无端口冲突或配置错误），尽快修复启动。使用 ZooKeeper 自带命令行：docker exec -it zoo1 zkServer.sh status 分别查看各节点状态：正常情况下应有一台显示 leader，其余显示 follower。如果都显示 standalone 或 looking，则说明没选出 Leader。此时核对 ZOO_MY_ID 和 ZOO_SERVERS 配置是否对应正确——每个容器的 myid 值必须和在 ZOO_SERVERS列表中的编号一致 。另外，检查网络互通，确保容器间的 2888、3888 端口可达（这些是选举通信端口）。纠正配置或网络问题后，重启 ZooKeeper 容器让它们重新发起选举。待其中一台日志出现 LEADING 并打印 ZooKeeper启动完成的信息，即告选主成功。</li>
<li>数据无法持久化（非报错但需要注意）：默认情况下，上述 Docker Compose 未对 Cassandra 和 Solr 的数据目录做持久化挂载，这意味着容器删除或重建后数据会丢失（ZooKeeper 的状态也会重置）。在预发布环境，经常需要反复重置数据倒无妨，但如果希望持久化数据以进行持续测试，建议为它们挂载卷。例如在 cassandra1 服务下添加 volumes: - ./data/cassandra1:/var/lib/cassandra，在 solr1 下添加 volumes: - ./data/solr1:/var/solr. 这样容器重启后数据依然保留。不过也要注意挂载可能引入的权限问题，可以在启动前预先调整宿主机目录权限或UID/GID。</li>
</ul>
<p>以上排查场景基本覆盖了预发布环境搭建中常见的问题。总结来说，遇到异常不要慌，充分利用日志和内置管理工具，逐一检查各组件的配置和状态，再结合对原理的理解，即可定位并解决问题。</p>
<h2 id="经验总结"><a aria-hidden="true" tabindex="-1" href="#经验总结"><span class="icon icon-link"></span></a>经验总结</h2>
<p>最后，根据实践经验，我们对面向内容检索平台的预发布环境搭建给出以下最佳实践和注意事项：</p>
<ul>
<li>配置尽量贴近生产：预发布环境应使用与生产相同的软件版本和配置参数（ZooKeeper 节点数、Solr分片副本数、Cassandra复制因子等）。只有环境一致，测试结果才有参考价值 。例如生产 Cassandra 副本因子为3，预发尽量也部署3个节点保持 RF=3，否则某些一致性级别在预发环境无法模拟（如 QUORUM 在2节点集群就退化成 ALL）。</li>
<li>合理缩减规模：虽要配置一致，但规模可比生产小。 一般一个机架上的最小集群规模即可，如生产 Solr 有6台12个分片，预发可用3台减半分片，在保证核心机制（分片、副本、容错）模拟到的同时节约资源。切忌为了省事用单节点假集群，那样很多分布式问题（选主、网络分区等）就测不出来了。</li>
<li>自动化与基础设施即代码：使用 Docker Compose、Kubernetes 或 Terraform 等工具来定义和部署预发布环境。一键部署减少人为失误，也方便环境的反复销毁重建。Compose 文件、K8s YAML等最好与代码仓库一起管理版本，确保团队成员搭建出的环境一致。</li>
<li>数据准备：尽可能使用贴近真实的数据进行测试。可以从线上脱敏抽取一部分数据导入预发，以便在索引量、查询负载上发现潜在性能问题。若无法使用真实数据，也应构造边界情况的数据（如超长文本、特殊字符）以测试系统兼容性。</li>
<li>关注系统日志：预发布环境是发现问题的最佳时机，应密切关注各组件日志。特别是 ZooKeeper 日志（观察会话断连、选举变化）、Solr 日志（索引提交错误、GC警告）、Cassandra 日志（hint太多、读修复频繁）等。如果预发环境日志中已有异常或警告，在生产环境往往会被放大，需在发布前修复。</li>
<li>定期演练故障：在预发环境可以主动演练一些故障，以验证系统的自动恢复能力。例如杀掉一个 Cassandra 节点观察读写是否正常（根据一致性设置可能有短暂失败，但应该在节点重启后自动恢复并进行 Hint Handoff）；停止 Solr 的 Leader 副本看查询是否无感知切换到副本、新Leader选举是否快速完成；模拟网络分区测试 ZooKeeper 的行为（可通过iptables临时阻断部分节点通信）。通过演练，这些组件在故障场景下的表现和潜在坑点就能在预发中了解到，避免上线后措手不及。</li>
<li>确保安全隔离：预发布环境通常对标生产，但绝对不能影响生产。因此做好隔离工作，例如使用不同的网络/VPC，避免预发的 ZooKeeper 或 Cassandra 意外加入生产集群。数据上如果共享了部分生产数据，一定要严格控制预发环境对生产数据的修改权限（理想情况下预发只读生产快照）。此外，为防止误操作，预发布和生产的访问入口、管理账号应有明显区分。</li>
<li>资源监控：不要因为是预发布就忽视监控。建议部署基本的监控和告警，如节点CPU/内存、Cassandra 的 compaction 延迟、Solr JVM 内存使用、ZooKeeper 延时等。在预发布观察这些指标的变化，有助于提前发现资源瓶颈并调整参数。例如通过预发压测发现 Solr Heap 不足导致频繁 GC，那么上线前就可考虑调大内存。</li>
</ul>
<p>通过以上这些实践，预发布环境可以更好地发挥“生产环境试金石”的作用 ：既捕获功能和性能问题，又验证系统在异常情况的表现，为最终上线保驾护航。在搭建和使用预发布环境的过程中，我们不断积累经验，将其沉淀为文档和自动化脚本，从而让团队在未来的迭代中更高效、更安心地交付内容检索平台的新功能。每一次在预发布环境中发现并解决的问题，都是在生产环境避免一次故障的宝贵收益。希望本指南能帮助你顺利搭建自己的预发布环境，在实战中不断完善，打造出稳健可依赖的内容检索平台！</p>
<h2 id="参考资料"><a aria-hidden="true" tabindex="-1" href="#参考资料"><span class="icon icon-link"></span></a>参考资料：</h2>
<ul>
<li>Cassandra 官方文档 - Architecture - Dynamo-style Replication</li>
<li>Apigee Docs - About Cassandra Replication Factor</li>
<li>Apache Solr Reference Guide - Shards and Indexing Data in SolrCloud</li>
<li>CSDN 博客 - SolrCloud 自动容错机制</li>
<li>ZooKeeper 资料 - Leader 选举原理</li>
<li>Stack Overflow 讨论 - Solr could not connect to ZooKeeper error</li>
</ul> <html lang="en" data-astro-cid-uffxixac> <head><!-- Global Metadata --><meta charset="utf-8"><!--<meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">--><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css"><link rel="shortcut icon" href="/favicon.png" type="image/png"><link rel="sitemap" href="/sitemap-index.xml"><link rel="alternate" type="application/rss+xml" title="Ge Yuxu • AI &#38; Engineering" href="https://geyuxu.com/rss.xml"><meta name="generator" content="Astro v5.5.6"><!-- Font preloads --><link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin><link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin><!-- Canonical URL --><link rel="canonical" href="https://geyuxu.com/blog/search/20220214_%E9%9D%A2%E5%90%91%E5%86%85%E5%AE%B9%E6%A3%80%E7%B4%A2%E5%B9%B3%E5%8F%B0%E7%9A%84%E9%A2%84%E5%8F%91%E5%B8%83%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"><!-- Primary Meta Tags --><title>Ge Yuxu • AI &amp; Engineering</title><meta name="title" content="Ge Yuxu • AI &#38; Engineering"><meta name="description" content="Welcome to my blog!"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://geyuxu.com/blog/search/20220214_%E9%9D%A2%E5%90%91%E5%86%85%E5%AE%B9%E6%A3%80%E7%B4%A2%E5%B9%B3%E5%8F%B0%E7%9A%84%E9%A2%84%E5%8F%91%E5%B8%83%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"><meta property="og:title" content="Ge Yuxu • AI &#38; Engineering"><meta property="og:description" content="Welcome to my blog!"><meta property="og:image" content="https://geyuxu.com/blog-placeholder-1.jpg"><!-- Twitter --><meta property="twitter:card" content="summary_large_image"><meta property="twitter:url" content="https://geyuxu.com/blog/search/20220214_%E9%9D%A2%E5%90%91%E5%86%85%E5%AE%B9%E6%A3%80%E7%B4%A2%E5%B9%B3%E5%8F%B0%E7%9A%84%E9%A2%84%E5%8F%91%E5%B8%83%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"><meta property="twitter:title" content="Ge Yuxu • AI &#38; Engineering"><meta property="twitter:description" content="Welcome to my blog!"><meta property="twitter:image" content="https://geyuxu.com/blog-placeholder-1.jpg"><script src="/js/jquery-3.7.1.min.js"></script><script src="/js/copy-code-button.js" defer></script><!-- Dify Chatbot Configuration --><script>
 window.difyChatbotConfig = {
  token: 'VgrjCAto93bjE0MW',
  systemVariables: {
    // user_id: 'YOU CAN DEFINE USER ID HERE',
    // conversation_id: 'YOU CAN DEFINE CONVERSATION ID HERE, IT MUST BE A VALID UUID',
  },
  userVariables: {
    // avatar_url: 'YOU CAN DEFINE USER AVATAR URL HERE',
    // name: 'YOU CAN DEFINE USER NAME HERE',
  },
 }
</script><!-- Dify Chatbot Script --><script src="https://udify.app/embed.min.js" id="VgrjCAto93bjE0MW" defer>
</script><!-- Dify Chatbot Custom Styles --></head> <body data-astro-cid-uffxixac>  <div class="statement" data-astro-cid-uffxixac> <blockquote data-astro-cid-uffxixac> <p data-astro-cid-uffxixac><strong data-astro-cid-uffxixac>脱敏说明</strong>：本文所有出现的表名、字段名、接口地址、变量名、IP地址及示例数据等均非真实，仅用于阐述技术思路与实现步骤，示例代码亦非公司真实代码。示例方案亦非公司真实完整方案，仅为本人记忆总结，用于技术学习探讨。<br data-astro-cid-uffxixac>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;文中所示任何标识符并不对应实际生产环境中的名称或编号。<br data-astro-cid-uffxixac>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;示例&nbsp;SQL、脚本、代码及数据等均为演示用途，不含真实业务数据，也不具备直接运行或复现的完整上下文。<br data-astro-cid-uffxixac>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;读者若需在实际项目中参考本文方案，请结合自身业务场景及数据安全规范，使用符合内部命名和权限控制的配置。</p> <p data-astro-cid-uffxixac><strong data-astro-cid-uffxixac>Data Desensitization Notice</strong>: All table names, field names, API endpoints, variable names, IP addresses, and sample data appearing in this article are fictitious and intended solely to illustrate technical concepts and implementation steps. The sample code is not actual company code. The proposed solutions are not complete or actual company solutions but are summarized from the author's memory for technical learning and discussion.<br data-astro-cid-uffxixac>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;Any identifiers shown in the text do not correspond to names or numbers in any actual production environment.<br data-astro-cid-uffxixac>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;Sample SQL, scripts, code, and data are for demonstration purposes only, do not contain real business data, and lack the full context required for direct execution or reproduction.<br data-astro-cid-uffxixac>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;Readers who wish to reference the solutions in this article for actual projects should adapt them to their own business scenarios and data security standards, using configurations that comply with internal naming and access control policies.</p> <p data-astro-cid-uffxixac><strong data-astro-cid-uffxixac>版权声明</strong>：本文版权归原作者所有，未经作者事先书面许可，任何单位或个人不得以任何方式复制、转载、摘编或用于商业用途。<br data-astro-cid-uffxixac>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;若需非商业性引用或转载本文内容，请务必注明出处并保持内容完整。<br data-astro-cid-uffxixac>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;对因商业使用、篡改或不当引用本文内容所产生的法律纠纷，作者保留追究法律责任的权利。</p> <p data-astro-cid-uffxixac><strong data-astro-cid-uffxixac>Copyright Notice</strong>: The copyright of this article belongs to the original author. Without prior written permission from the author, no entity or individual may copy, reproduce, excerpt, or use it for commercial purposes in any way.<br data-astro-cid-uffxixac>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;For non-commercial citation or reproduction of this content, attribution must be given, and the integrity of the content must be maintained.<br data-astro-cid-uffxixac>
&nbsp;&nbsp;&nbsp;&nbsp;•&nbsp;The author reserves the right to pursue legal action against any legal disputes arising from the commercial use, alteration, or improper citation of this article's content.</p> <p data-astro-cid-uffxixac><em data-astro-cid-uffxixac>Copyright&nbsp;©&nbsp;1989–Present&nbsp;Ge&nbsp;Yuxu.&nbsp;All&nbsp;Rights&nbsp;Reserved.</em></p> </blockquote> </div></body></html>  </article> </div> </main> <footer data-astro-cid-sz7xmlte>
&copy; 2025 All rights reserved.
</footer>  </body></html>